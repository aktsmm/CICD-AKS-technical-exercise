# Phase23: Azure Monitor 診断設定安定化 (2025-11-03)

## 背景

- `Deploy Infrastructure` ワークフローで Azure Monitor の診断設定をデプロイした際、サポートされないログカテゴリ (`SoftwareUpdates` など) を要求して失敗が発生。
- Azure Monitor Agent (AMA) と Data Collection Rule (DCR) による収集構成を導入済みのため、VM リソースへ追加の診断設定を付与する必要性を再検討。

## 事象

- GitHub Actions 上で `ReadOnlyDisabledSubscription` 解消後も、`infra/modules/diagnostics.bicep` 内の VM 診断設定リソースが `BadRequest` を返し、`ResourceDeploymentFailure` によって全体デプロイが中断。
- 警告として `adminUserName` ハードコード指摘 (挙動には影響なし)。

## 原因分析

- AMA ＋ DCR を有効化している VM では、`VMInsights` と `GuestMetrics` のみが利用可能なカテゴリ。
- その他のカテゴリは Update Management 等の追加機能が前提のため、診断設定が存在しない状況で指定すると `BadRequest` となる。
- 公式ドキュメントでも VM Insights (AMA) の導入で診断設定は必須ではない旨が示されている。

## 対応内容

1. `infra/modules/diagnostics.bicep` から VM 向け診断設定リソース (`vm-to-la`) を削除し、AMA ＋ DCR のみでゲスト情報を Log Analytics に送信する構成へ統一。
2. `infra/modules/vm-mongodb.bicep` で AMA 拡張 (`AzureMonitorLinuxAgent`) を導入済みであることを確認。
3. 変更内容を `fix: drop vm diagnostics setting in favor of dcr` としてコミット／プッシュ。
4. 安定状態を示すため `fix: lock working infra baseline` を追加コミットし、現在の構成を明示。

## 結果

- `Deploy Infrastructure` ワークフローが `Success` 完了。
- MongoDB VM に AMA が正しくインストールされ、DCR 経由で Log Analytics にデータが送信されることを確認。

## 今後のフォロー

- もし Update Management や追加のゲストロギングが必要になった場合は、Automation アカウント＋ Log Analytics 連携を別途構築する。
- `adminUserName` のハードコード警告は残るため、将来的にパラメーター化してリント警告を解消すると保守性が向上。

## 参考リンク

- Azure Monitor の VM Insights / AMA 構成: [https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-enable-overview](https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-enable-overview)
- AMA 環境でサポートされる VM ログカテゴリ: [https://learn.microsoft.com/azure/azure-monitor/reference/supported-logs/microsoft-compute-virtualmachines-logs](https://learn.microsoft.com/azure/azure-monitor/reference/supported-logs/microsoft-compute-virtualmachines-logs)
