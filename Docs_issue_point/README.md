# Docs_issue_point - トラブル記録管理ディレクトリ

**作成日**: 2025 年 1 月 29 日  
**最終更新**: 2025 年 1 月 29 日

---

## 📋 このディレクトリの目的

プロジェクト全体で発生したトラブル、エラー、問題点を**フェーズ別**に記録・管理します。

**トラブル記録の原則**:

1. ✅ **エラーメッセージは全文コピー**
2. ✅ **発生日時を記録**
3. ✅ **解決までの試行錯誤も含める**
4. ✅ **最終的な解決方法を明記**
5. ✅ **再発防止策も記載**

---

## 📁 ドキュメント一覧

### Phase 0: プロジェクトセットアップ

| ファイル名              | 概要                                                | ステータス  | 重要度      |
| ----------------------- | --------------------------------------------------- | ----------- | ----------- |
| `CICDデプロイ考慮点.md` | GitHub Push Protection エラー、Artifact v3 非推奨等 | ✅ 解決済み | 🔴 Critical |

### Phase 0-1: GitHub Actions CI/CD 構築

| ファイル名                                   | 概要                                                    | ステータス  | 重要度      |
| -------------------------------------------- | ------------------------------------------------------- | ----------- | ----------- |
| `Phase00-01_GitHubActions修正_2025-01-29.md` | Dockerfile 未実装、CodeQL/Artifact Actions 非推奨エラー | ✅ 解決済み | 🔴 Critical |

**主なトラブル**:

- トラブル #1: Dockerfile 未実装エラー → Node.js 18 Alpine で完全実装
- トラブル #2: CodeQL Action v2 非推奨 → v3 に更新
- トラブル #3: Artifact Actions v3 非推奨 → v4 に更新
- トラブル #4: Artifact パス不正 → `outputs/infra-outputs.txt` に修正

### Phase 1: Azure インフラストラクチャデプロイ

| ファイル名                                   | 概要                               | ステータス  | 重要度      |
| -------------------------------------------- | ---------------------------------- | ----------- | ----------- |
| `Phase01_インフラデプロイ失敗_2025-01-29.md` | Storage Account ポリシー制約エラー | ✅ 解決済み | 🔴 Critical |

**主なトラブル**:

- Azure Policy による PublicAccess 制約でデプロイ失敗
- 解決策: サブスクリプション切り替え (hinokuni-sub → Visual Studio Enterprise)

### Phase 2: アプリケーションデプロイ

| ファイル名                                       | 概要                                           | ステータス  | 重要度      |
| ------------------------------------------------ | ---------------------------------------------- | ----------- | ----------- |
| `Phase02_アプリデプロイ問題と解決_2025-10-29.md` | ACR 名不一致、イメージビルド失敗、Ingress 設定 | ✅ 解決済み | 🔴 Critical |

**主なトラブル**:

- トラブル #1: ACR 名の不一致エラー → `<ACR_NAME>` → `<ACR_NAME>`
- トラブル #2: Docker イメージビルド失敗 → `package.json` に依存関係追加
- トラブル #3: Pod のクラッシュループ → モジュール欠落問題
- トラブル #4: Ingress デプロイエラー → NGINX Ingress Controller 導入
- トラブル #5: UI 更新が反映されない → 動的イメージタグ実装

### Phase 3: 開発環境設定

| ファイル名                              | 概要                                   | ステータス | 重要度    |
| --------------------------------------- | -------------------------------------- | ---------- | --------- |
| `Phase03_kubectl環境設定_2025-10-29.md` | kubectl コマンドの PATH 設定と使用方法 | ✅ 完了    | 🟡 Medium |

**主な内容**:

- kubectl の既存インストール確認（v1.34.1）
- Windows PATH 環境変数への追加（永続化）
- よく使う kubectl コマンド集
- PowerShell エイリアス・補完設定の提案

### Phase 4: MongoDB バックアップ実装

| ファイル名                                      | 概要                                         | ステータス | 重要度    |
| ----------------------------------------------- | -------------------------------------------- | ---------- | --------- |
| `Phase04_MongoDBバックアップ実装_2025-10-29.md` | MongoDB デイリーバックアップ機能の実装と設定 | ✅ 完了    | 🟡 Medium |

**主な内容**:

- Azure CLI と mongodump を使用した自動バックアップスクリプト
- Cron ジョブによる毎日午前 2 時の自動実行
- Managed Identity を使用した Azure Storage へのアップロード
- Storage Blob Data Contributor ロールの割り当て
- 7 日間のローカルバックアップ保持ポリシー
- 公開アクセス可能な Storage（意図的な脆弱性）

---

## 🔍 参考資料・運用ガイド

| ファイル名                        | 内容                           | 用途                                 |
| --------------------------------- | ------------------------------ | ------------------------------------ |
| `インフラデプロイ確認コマンド.md` | Azure リソース確認用コマンド集 | デプロイ検証・トラブルシューティング |

---

## 📝 トラブル記録の作成ルール

### 必須項目

各トラブル記録ファイルには以下を**必ず含める**こと:

#### 1. ヘッダー情報

```markdown
# [Phase 番号]: [トラブル概要]

## 📁 ドキュメント一覧

### Phase 0-1: 初期セットアップ

| ファイル名                                                                                 | 概要                                                                        | ステータス  | カテゴリ/重要度 |
| ------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------- | ----------- | --------------- |
| [`CICDデプロイ考慮点.md`](CICDデプロイ考慮点.md)                                           | GitHub Push Protection で検出されたシークレットの除去と再発防止策を整理     | ✅ 解決済み | 🔴 Critical     |
| [`Phase00-01_GitHubActions修正_2025-01-29.md`](Phase00-01_GitHubActions修正_2025-01-29.md) | Dockerfile 未実装や旧バージョン Actions を修正し CI/CD を起動可能にした経緯 | ✅ 解決済み | � Critical      |

### Phase 1-4: インフラ & アプリ基盤

| ファイル名                                                                                         | 概要                                                                                    | ステータス  | カテゴリ/重要度 |
| -------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- | ----------- | --------------- |
| [`Phase01_インフラデプロイ失敗_2025-01-29.md`](Phase01_インフラデプロイ失敗_2025-01-29.md)         | Storage Account 公開制限ポリシーで止まった Bicep デプロイをサブスクリプション切替で解決 | ✅ 解決済み | 🔴 Critical     |
| [`Phase02_アプリデプロイ問題と解決_2025-10-29.md`](Phase02_アプリデプロイ問題と解決_2025-10-29.md) | ACR 名不一致・Ingress 未設定など初回アプリ展開を阻害した課題をまとめて解消              | ✅ 解決済み | 🔴 Critical     |
| [`Phase03_kubectl環境設定_2025-10-29.md`](Phase03_kubectl環境設定_2025-10-29.md)                   | Windows 環境での kubectl PATH 追加と日常コマンドを整理                                  | ✅ 完了     | 🟡 Medium       |
| [`Phase04_MongoDBバックアップ実装_2025-10-29.md`](Phase04_MongoDBバックアップ実装_2025-10-29.md)   | MongoDB デイリーバックアップと Azure Storage 連携の自動化手順                           | ✅ 完了     | 🟡 Medium       |

### Phase 5-9: 追加実装・安定化

| ファイル名                                                                                                           | 概要                                                                                | ステータス  | カテゴリ/重要度 |
| -------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ----------- | --------------- |
| [`Phase05_プライベートクラスター要件解釈_2025-10-29.md`](Phase05_プライベートクラスター要件解釈_2025-10-29.md)       | プライベートサブネット要件と AKS プライベートクラスターの違いを整理し対応方針を決定 | ✅ 解決済み | 🟡 Medium       |
| [`Phase06_ワークフロー依存関係実装_2025-10-29.md`](Phase06_ワークフロー依存関係実装_2025-10-29.md)                   | インフラ完了後にアプリを自動展開する workflow_run 連携と依存関係制御を実装          | ✅ 解決済み | � Critical      |
| [`Phase07_AKS-ACR認証エラー解決_2025-10-29.md`](Phase07_AKS-ACR認証エラー解決_2025-10-29.md)                         | ImagePullBackOff の原因となった ACR 認証・イメージ Pull 問題を解消                  | ✅ 解決済み | 🔴 Critical     |
| [`Phase08_AKSプロビジョニング待機実装_2025-10-29.md`](Phase08_AKSプロビジョニング待機実装_2025-10-29.md)             | Bicep 完了直後に AKS API が未準備な問題へ待機ロジックを追加                         | ✅ 解決済み | 🔴 Critical     |
| [`Phase09_MongoDBパッケージインストール失敗_2025-10-29.md`](Phase09_MongoDBパッケージインストール失敗_2025-10-29.md) | Ubuntu 20.04 に公式 MongoDB パッケージが無い事象への対処とスクリプト修正            | ✅ 解決済み | 🔴 Critical     |

### Phase 11-16: ランタイム運用改善

| ファイル名                                                                                                             | 概要                                                                        | ステータス  | カテゴリ/重要度 |
| ---------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ----------- | --------------- |
| [`Phase11_外部アクセス設定_2025-10-30.md`](Phase11_外部アクセス設定_2025-10-30.md)                                     | Service を LoadBalancer 化してアプリの外部公開を実現                        | ✅ 解決済み | 🔴 Critical     |
| [`Phase12_SARIF権限エラー解決_2025-10-30.md`](Phase12_SARIF権限エラー解決_2025-10-30.md)                               | Checkov/Trivy の SARIF アップロード権限不足と Azure Policy 警告への対応記録 | ✅ 解決済み | 🟡 Medium       |
| [`Phase13_ワークフロートリガー競合解決_2025-10-30.md`](Phase13_ワークフロートリガー競合解決_2025-10-30.md)             | push トリガー競合で二重起動する CI を paths 条件で整理                      | ✅ 解決済み | 🟡 Medium       |
| [`Phase14_AKSパブリックIP用途解説_2025-10-30.md`](Phase14_AKSパブリックIP用途解説_2025-10-30.md)                       | Managed リソースグループ内で生成される 2 種類のパブリック IP の役割を整理   | ✅ 解説完了 | 🔵 Info         |
| [`Phase15_ACR待機ロジック追加_2025-10-30.md`](Phase15_ACR待機ロジック追加_2025-10-30.md)                               | ACR 作成待機のリトライ処理を追加しデプロイ安定性を向上                      | ✅ 解決済み | 🟡 Medium       |
| [`Phase16_ImagePullBackOff解決とデプロイ成功_2025-10-30.md`](Phase16_ImagePullBackOff解決とデプロイ成功_2025-10-30.md) | ACR 名の動的置換不備による ImagePullBackOff を修正                          | ✅ 解決済み | 🔴 Critical     |

### Phase 20-28: ガバナンス & セキュリティ強化

| ファイル名                                                                                                       | 概要                                                                    | ステータス  | カテゴリ/重要度 |
| ---------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- | ----------- | --------------- |
| [`Phase20_MongoDB認証スクリプト修正_2025-10-31.md`](Phase20_MongoDB認証スクリプト修正_2025-10-31.md)             | MongoDB 認証失敗を解消する readiness チェックとユーザー作成フローの改修 | ✅ 解決済み | 🔴 Critical     |
| [`Phase22_Dependabot概要と手動実行_2025-11-03.md`](Phase22_Dependabot概要と手動実行_2025-11-03.md)               | Dependabot 設定の把握と手動トリガー手順・改善案の整理                   | ✅ 情報更新 | 🔵 Info         |
| [`Phase22_npm_ciロックファイル同期_2025-11-03.md`](Phase22_npm_ciロックファイル同期_2025-11-03.md)               | CodeQL ジョブで発生した npm ci ロックファイル不整合を修正               | ✅ 解決済み | 🔴 Critical     |
| [`Phase23_診断設定安定化_2025-11-03.md`](Phase23_診断設定安定化_2025-11-03.md)                                   | AMA/DCR 併用環境での診断設定失敗を解消しログ収集を安定化                | ✅ 解決済み | 🟡 Medium       |
| [`Phase24_BicepParamWorkflow対応_2025-11-04.md`](Phase24_BicepParamWorkflow対応_2025-11-04.md)                   | `.bicepparam` 非対応問題に対して JSON パラメータへ移行                  | ✅ 解決済み | 🔴 Critical     |
| [`Phase25_MCSB_MobileNetwork回避_2025-11-04.md`](Phase25_MCSB_MobileNetwork回避_2025-11-04.md)                   | MobileNetwork プロバイダー禁止環境でのポリシー override 手順を確立      | ✅ 解決済み | 🟡 Medium       |
| [`Phase26_GuardrailsOverrideSchemaFix_2025-11-04.md`](Phase26_GuardrailsOverrideSchemaFix_2025-11-04.md)         | Azure Policy override スキーマ不一致を修正し再デプロイ成功              | ✅ 解決済み | 🟡 Medium       |
| [`Phase27_PolicyGuardrailsManagedIdentity_2025-11-04.md`](Phase27_PolicyGuardrailsManagedIdentity_2025-11-04.md) | ポリシー公開・割り当て時の CLI 仕様差分とマネージド ID 必須要件に対応   | ✅ 解決済み | 🔴 Critical     |
| [`Phase28_CleanupWorkflowRunMainFilter_2025-11-04.md`](Phase28_CleanupWorkflowRunMainFilter_2025-11-04.md)       | workflow_run コンテキストで Cleanup ワークフローが起動しない問題を修正  | ✅ 解決済み | 🟡 Medium       |

### 補助メモ

- [`AllowNsgFlowLogging.md`](AllowNsgFlowLogging.md): NSG フローログ機能のフィーチャー登録手順と実務 Tips をまとめたメモ。
- [`インフラデプロイ確認コマンド.md`](インフラデプロイ確認コマンド.md): Azure リソースのデプロイ検証に使用したコマンド集。
  **対応内容**: ...
  **実施時期**: ...
  **担当**: ...

### 2. [防止策のカテゴリ]

...
```

---

## 🎯 重要度の定義

| 重要度          | 説明                                       | 対応優先度 |
| --------------- | ------------------------------------------ | ---------- |
| 🔴 **Critical** | プロジェクトのブロッカー、即座に対応が必要 | 最優先     |
| 🟡 **Warning**  | 機能に影響あり、計画的な対応が必要         | 高         |
| 🔵 **Info**     | 軽微な問題、情報共有レベル                 | 中〜低     |

---

## 📊 ステータスの定義

| ステータス      | 説明                               | 次のアクション             |
| --------------- | ---------------------------------- | -------------------------- |
| ✅ **解決済み** | 問題が完全に解決され、動作確認済み | 再発防止策の実施           |
| ⏳ **対応中**   | 調査中または修正作業中             | 継続的な対応               |
| ❌ **未解決**   | 未着手または対応方法不明           | 調査開始・エスカレーション |

---

## 🔍 トラブルシューティングフロー

```
1. エラー発生
   ↓
2. エラーメッセージ全文をコピー
   ↓
3. Docs_issue_point/ に新しいMarkdownファイル作成
   - ファイル名: Phase[XX]_[概要]_YYYY-MM-DD.md
   ↓
4. 必須項目に沿って記録
   - エラーメッセージ
   - 発生日時
   - 発生箇所
   ↓
5. 調査・試行錯誤
   - 試行ごとに記録を追加
   ↓
6. 解決
   - 最終的な解決方法を明記
   - 再発防止策を記載
   ↓
7. ステータスを「✅ 解決済み」に更新
```

---

## 🔗 関連ドキュメント

- `Docs_work_history/` - 作業履歴の記録
- `Docs_Secrets/` - 機密情報管理
- `.github/copilot-instructions.md` - プロジェクト全体のガイドライン
- `docs/AZURE_SETUP_INFO.md` - Azure 環境情報 (非機密情報)

---

## 📞 トラブル対応のベストプラクティス

### ✅ すべきこと

1. **即座に記録する**

   - エラーが発生したらすぐにドキュメント作成
   - 時間が経つと詳細を忘れる

2. **スクリーンショットも保存**

   - エラー画面を `Docs_issue_point/screenshots/` に保存
   - ログファイルも添付

3. **検索しやすいファイル名**

   - `Phase[番号]_[概要]_YYYY-MM-DD.md`
   - 例: `Phase02_ACRプッシュ失敗_2025-01-30.md`

4. **タイムスタンプを記録**
   - エラー発生時刻
   - 各試行の実施時刻
   - 解決時刻

### ❌ やってはいけないこと

1. **あいまいな記録**

   - 「エラーが出た」だけでは不十分
   - エラーメッセージ全文をコピーする

2. **失敗した試行を削除**

   - 失敗も貴重な情報
   - 次回同じ道を辿らないために記録

3. **解決後の放置**
   - 再発防止策まで記載して初めて完了
   - ドキュメントを更新せずに閉じない

---

## 📈 統計情報

### Phase 0-1: GitHub Actions CI/CD 構築

| 項目               | 値          |
| ------------------ | ----------- |
| 発生したトラブル数 | 4 件        |
| Critical           | 4 件        |
| 解決済み           | 4 件        |
| 平均解決時間       | 約 2-3 時間 |

### Phase 1: Azure インフラデプロイ

| 項目               | 値                         |
| ------------------ | -------------------------- |
| 発生したトラブル数 | 1 件                       |
| Critical           | 1 件                       |
| 解決済み           | 1 件                       |
| 解決方法           | サブスクリプション切り替え |

---

## 🎓 学んだ教訓

### 1. GitHub Actions のバージョン管理

**教訓**: GitHub Actions は頻繁に非推奨化される
**対策**: Dependabot の有効化、定期的なバージョンチェック

### 2. Azure Policy の事前確認

**教訓**: サブスクリプションごとに異なるポリシーが適用される
**対策**: デプロイ前に `az policy assignment list` で確認

### 3. 機密情報の扱い

**教訓**: Git 履歴に残すと削除が困難
**対策**: `.gitignore` の徹底、事前チェック

### 4. エラーメッセージの保存

**教訓**: 後から確認できないと再発時に困る
**対策**: 全文コピー、スクリーンショット保存

---

**管理者**: aktsmm  
**次回レビュー予定**: 各フェーズ完了時
