# Phase 12: SARIF Upload 権限エラー解決 (2025-10-30)

## 問題

GitHub Actions でセキュリティスキャン (Checkov, Trivy) の結果を SARIF 形式でアップロードしようとすると、権限エラーが発生。

### エラーメッセージ

```
Resource not accessible by integration - https://docs.github.com/rest
```

詳細:

```
This run of the CodeQL Action does not have permission to access the CodeQL Action API endpoints.
This could be because the Action is running on a pull request from a fork.
If not, please ensure the workflow has at least the 'security-events: read' permission.
Details: Resource not accessible by integration
```

### 発生箇所

#### 1. `infra-deploy.yml` - Checkov スキャン

```yaml
- name: Upload Checkov Results
  uses: github/codeql-action/upload-sarif@v3
  if: always()
  continue-on-error: true
  with:
    sarif_file: checkov-results.sarif
```

**エラー**: `Resource not accessible by integration`

#### 2. `app-deploy.yml` - Trivy スキャン

```yaml
- name: Upload Trivy Results
  uses: github/codeql-action/upload-sarif@v3
  if: always()
  continue-on-error: true
  with:
    sarif_file: trivy-results.sarif
```

**エラー**: `Resource not accessible by integration`

### Checkov スキャンの警告

同時に以下のセキュリティチェック失敗も発生:

```
Scan IaC for Security Issues
CKV_AZURE_226: "Ensure ephemeral disks are used for OS disks"
CKV_AZURE_141: "Ensure AKS local admin account is disabled"
CKV_AZURE_7: "Ensure AKS cluster has Network Policy configured"
CKV_AZURE_227: "Ensure that the AKS cluster encrypt temp disks, caches, and data flows between Compute and Storage resources"
CKV_AZURE_34: "Ensure that 'Public access level' is set to Private for blob containers"
CKV_AZURE_206: "Ensure that Storage Accounts use replication"
CKV_AZURE_44: "Ensure Storage Account is using the latest version of TLS encryption"
CKV_AZURE_43: "Ensure Storage Accounts adhere to the naming rules"
CKV_AZURE_35: "Ensure default network access rule for Storage Accounts is set to deny"
CKV_AZURE_3: "Ensure that 'supportsHttpsTrafficOnly' is set to 'true'"
```

**注**: これらは**意図的な脆弱性**のため、エラーではなく仕様。

## 原因

### 権限不足

GitHub Actions のデフォルト GITHUB_TOKEN には、SARIF (Static Analysis Results Interchange Format) ファイルを GitHub Security Tab にアップロードする権限がない。

### 必要な権限

- `security-events: write` - SARIF 結果のアップロード用
- `contents: read` - リポジトリ内容の読み取り用

## 解決策

### 修正 1: `infra-deploy.yml`

**ファイル**: `.github/workflows/infra-deploy.yml`

```diff
 name: Deploy Infrastructure

 on:
     push:
         branches:
             - main
         paths:
             - "infra/**"
             - ".github/workflows/infra-deploy.yml"
     workflow_dispatch:

+permissions:
+    contents: read
+    security-events: write
+
 env:
     AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
     RESOURCE_GROUP: rg-cicd-aks-bbs-001
     LOCATION: japaneast
```

### 修正 2: `app-deploy.yml`

**ファイル**: `.github/workflows/app-deploy.yml`

```diff
 name: Build and Deploy Application

 on:
     # アプリコードのみの変更時は直接実行
     push:
         branches:
             - main
         paths:
             - "app/**"
     workflow_dispatch:
     # Infrastructure完了後に自動実行
     workflow_run:
         workflows: ["Deploy Infrastructure"]
         types:
             - completed
         branches:
             - main

+permissions:
+    contents: read
+    security-events: write
+
 env:
     IMAGE_NAME: guestbook
     RESOURCE_GROUP: rg-cicd-aks-bbs-001
```

### コミット

```bash
git add .github/workflows/infra-deploy.yml .github/workflows/app-deploy.yml
git commit -m "fix: Add security-events write permission to fix SARIF upload error"
git push
```

## 技術的背景

### SARIF (Static Analysis Results Interchange Format)

- JSON ベースの標準フォーマット
- セキュリティスキャンツールの結果を統一形式で表現
- GitHub Security Tab で可視化

### GitHub Token Permissions

GitHub Actions では、ワークフローごとに最小権限の原則で権限を設定可能:

```yaml
permissions:
  actions: read|write|none
  checks: read|write|none
  contents: read|write|none
  deployments: read|write|none
  issues: read|write|none
  packages: read|write|none
  pull-requests: read|write|none
  security-events: read|write|none # ← SARIF upload用
```

デフォルトでは `security-events` は権限なし。明示的に `write` を指定する必要がある。

## 検証結果

### Before (エラー)

```
Run github/codeql-action/upload-sarif@v3
❌ Resource not accessible by integration
Error: HttpError: Resource not accessible by integration
```

### After (成功)

```
Run github/codeql-action/upload-sarif@v3
✅ Uploading results
✅ Successfully uploaded results
```

GitHub Security Tab:

- **Code scanning alerts** に Checkov の結果が表示
- **Dependabot alerts** とは別タブで管理
- 脆弱性の重要度 (Critical/High/Medium/Low) でフィルタリング可能

## 補足: Checkov 警告について

11 件の Checkov 警告は**意図的な脆弱性**のため、`soft_fail: true` で実行継続:

```yaml
- name: Run Checkov Scan
  uses: bridgecrewio/checkov-action@master
  with:
    directory: infra/
    framework: bicep
    output_format: sarif
    output_file_path: checkov-results.sarif
    soft_fail: true # ← 警告でもワークフロー継続
```

将来、意図的な脆弱性をスキップしたい場合は `.checkov.yml` で設定可能:

```yaml
# .checkov.yml (オプション)
skip-check:
  - CKV_AZURE_34 # Blob public access
  - CKV_AZURE_35 # Storage network deny
  - CKV_AZURE_3 # HTTPS only
  - CKV_AZURE_141 # AKS local admin
  - CKV_AZURE_7 # AKS Network Policy
```

## 関連ドキュメント

- [GitHub Actions: Permissions](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token)
- [SARIF specification](https://docs.oasis-open.org/sarif/sarif/v2.1.0/sarif-v2.1.0.html)
- [Checkov GitHub Action](https://github.com/bridgecrewio/checkov-action)
- [Trivy GitHub Action](https://github.com/aquasecurity/trivy-action)

## 関連 Phase

- **Phase 06**: ワークフロー依存関係実装
- **Phase 11**: 外部アクセス設定 (LoadBalancer)
- **Phase 12**: SARIF 権限エラー解決 (本 Phase)
