# Phase 15: ACR 待機ロジック追加 (2025-10-30)

## 問題の発生

### エラー内容

GitHub Actions 実行 #87 で以下のエラーが発生:

```
Run # リソースグループの存在確認（最大10回リトライ、30秒間隔）
🔍 Attempt 1/10: Checking resource group...
⏳ Resource group not found. Waiting 30 seconds...
🔍 Attempt 2/10: Checking resource group...
✅ Resource group rg-bbs-cicd-aks001001 found!
❌ No ACR found in resource group rg-bbs-cicd-aks001001
Error: Process completed with exit code 1.
```

### 問題の原因

**リソース作成のタイミング差**:

1. ✅ リソースグループ: 作成が即座に完了（数秒）
2. ⏳ ACR (Azure Container Registry): 作成に 5-10 分かかる

**元のコードの問題点**:

```bash
# リソースグループの確認 - リトライあり（10回、5分）
while [ $attempt -le $max_attempts ]; do
    if az group show --name $RESOURCE_GROUP &>/dev/null; then
        echo "✅ Resource group found!"
        break
    fi
    sleep 30
done

# ACRの取得 - リトライなし！
ACR_NAME=$(az acr list --resource-group $RESOURCE_GROUP --query "[0].name" -o tsv)
if [ -z "$ACR_NAME" ]; then
    echo "❌ No ACR found"
    exit 1  # ここで即座に失敗
fi
```

**問題**:

- リソースグループが見つかった直後に ACR を確認
- ACR はまだ作成中（Infrastructure Deploy ワークフローがバックグラウンドで実行中）
- ACR が見つからないため即座にエラー終了

## 実装した解決策

### 1. ACR 待機ロジックの追加

**ファイル**: `.github/workflows/app-deploy.yml`

**変更前**:

```bash
# ACRの取得
ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)

if [ -z "$ACR_NAME" ]; then
    echo "❌ No ACR found in resource group ${{ env.RESOURCE_GROUP }}"
    exit 1
fi
```

**変更後**:

```bash
# ACRの取得（最大20回リトライ、30秒間隔 = 最大10分待機）
max_acr_attempts=20
acr_attempt=1
ACR_NAME=""

while [ $acr_attempt -le $max_acr_attempts ]; do
    echo "🔍 Attempt $acr_attempt/$max_acr_attempts: Checking ACR..."

    ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)

    if [ -n "$ACR_NAME" ]; then
        echo "✅ ACR found: ${ACR_NAME}"
        break
    fi

    if [ $acr_attempt -eq $max_acr_attempts ]; then
        echo "❌ No ACR found in resource group ${{ env.RESOURCE_GROUP }} after $max_acr_attempts attempts!"
        echo "Infrastructure deployment may still be in progress."
        echo "💡 Hint: ACR creation typically takes 5-10 minutes after resource group creation."
        exit 1
    fi

    echo "⏳ ACR not found yet. Waiting 30 seconds... (This is normal, ACR creation takes time)"
    sleep 30
    acr_attempt=$((acr_attempt + 1))
done

echo "ACR Name: ${ACR_NAME}"
echo "acr_name=${ACR_NAME}" >> $GITHUB_OUTPUT
```

### 2. パラメータ設定

| パラメータ         | 値             | 理由                           |
| ------------------ | -------------- | ------------------------------ |
| `max_acr_attempts` | 20 回          | ACR 作成に最大 10 分かかるため |
| 待機間隔           | 30 秒          | API 呼び出し過多を防ぐため     |
| **合計待機時間**   | **最大 10 分** | ACR 作成時間(5-10 分)をカバー  |

### 3. エラーメッセージの改善

**ユーザーフレンドリーな出力**:

- 🔍 各試行回数を表示
- ⏳ 待機中であることを明示（「これは正常」と伝える）
- ✅ 成功時に ACR 名を表示
- ❌ 失敗時に原因と推奨時間を説明
- 💡 ACR 作成の一般的な所要時間を提示

## 技術的背景

### Azure リソース作成時間の比較

| リソースタイプ  | 作成時間    | 理由                                                  |
| --------------- | ----------- | ----------------------------------------------------- |
| Resource Group  | 数秒        | メタデータのみ作成                                    |
| Storage Account | 1-3 分      | ストレージの初期化                                    |
| **ACR**         | **5-10 分** | レジストリインフラの構築、レプリケーション設定        |
| AKS Cluster     | 10-20 分    | VM スケールセット、ネットワーク、コントロールプレーン |
| VM              | 3-5 分      | OS 起動、プロビジョニング                             |

### workflow_run トリガーの特性

```yaml
on:
  workflow_run:
    workflows: ["Deploy Infrastructure"]
    types: [completed]
    branches: [main]
```

**動作**:

- Infrastructure Deploy ワークフローが**完了**してから App Deploy がトリガー
- しかし「完了」= Bicep デプロイコマンドの終了
- Azure 側のリソース作成は**非同期で継続中**

**結果**:

- ワークフローは終了しているが、ACR はまだ作成中
- → App Deploy ワークフロー側で追加の待機が必要

## 期待される動作

### 成功ケース（ACR が 5 分後に作成完了）

```
🔍 Attempt 1/20: Checking ACR...
⏳ ACR not found yet. Waiting 30 seconds... (This is normal, ACR creation takes time)
🔍 Attempt 2/20: Checking ACR...
⏳ ACR not found yet. Waiting 30 seconds...
🔍 Attempt 3/20: Checking ACR...
⏳ ACR not found yet. Waiting 30 seconds...
...
🔍 Attempt 10/20: Checking ACR...
✅ ACR found: acrdevxxx123456
ACR Name: acrdevxxx123456
```

### タイムアウトケース（10 分経過しても ACR が見つからない）

```
🔍 Attempt 20/20: Checking ACR...
❌ No ACR found in resource group rg-bbs-cicd-aks001001 after 20 attempts!
Infrastructure deployment may still be in progress.
💡 Hint: ACR creation typically takes 5-10 minutes after resource group creation.
Error: Process completed with exit code 1.
```

## 関連ファイル

- **修正**: `.github/workflows/app-deploy.yml` (Lines 103-131)
- **関連**: `.github/workflows/infra-deploy.yml` (Infrastructure Deploy workflow)
- **依存**: `infra/modules/container-registry.bicep` (ACR 作成)

## 学んだこと

1. **Azure リソース作成は非同期**

   - Bicep デプロイが完了しても、リソースは作成中の可能性がある
   - 特に ACR、AKS など複雑なリソースは作成に時間がかかる

2. **ワークフロー依存関係の落とし穴**

   - `workflow_run` は前のワークフローの**コマンド終了**を待つ
   - Azure 側のリソース作成完了は保証されない
   - → 依存リソースは必ず存在確認+リトライロジックが必要

3. **適切なリトライ設定**

   - リソース作成時間を理解してリトライ回数を設定
   - 待機間隔は API 制限を考慮（30 秒が適切）
   - ユーザーに進捗がわかるメッセージを表示

4. **エラーメッセージの重要性**
   - 単に「見つからない」ではなく、なぜ見つからないか説明
   - 一般的な所要時間を提示して不安を軽減
   - 次のアクションを提案（「Infrastructure deployment を確認」など）

## 次のステップ

1. ✅ コードをコミット・プッシュ
2. ⏳ 次回の GitHub Actions 実行で動作確認
3. 📊 実際の ACR 作成時間を計測（ログから確認）
4. 🔧 必要に応じてリトライ回数を調整

## コミット情報

```bash
git commit -m "fix: Add retry logic for ACR availability check with 10-minute timeout

- Increased ACR check retries from 0 to 20 attempts (10 minutes total)
- ACR creation typically takes 5-10 minutes after resource group creation
- Added informative messages during wait time
- Prevents premature failure when infrastructure is still deploying

This fixes issue #87 where ACR was not found immediately after RG creation."
```

## 関連 Phase

- **Phase08**: AKS プロビジョニング待機実装（同様のリトライロジック）
- **Phase13**: ワークフロートリガー競合解決（workflow_run の理解）
- **Phase06**: ワークフロー依存関係実装（needs vs workflow_run）

## タグ

`#GitHub-Actions` `#ACR` `#Retry-Logic` `#Async-Resource-Creation` `#CI/CD` `#Timing-Issue`
