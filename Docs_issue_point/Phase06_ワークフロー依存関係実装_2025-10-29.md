# Phase 06: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾å­˜é–¢ä¿‚å®Ÿè£…

**ä½œæˆæ—¥**: 2025-10-29  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… è§£æ±ºæ¸ˆã¿  
**ã‚«ãƒ†ã‚´ãƒª**: CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ

---

## ğŸ¤” èª²é¡Œ

Infrastructureï¼ˆACRã€AKS ãªã©ï¼‰ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹å‰ã«ã€Application ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã„ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:

```
ERROR: Could not connect to the registry login server 'acrwizdev.azurecr.io'.
Please verify that the registry exists.
```

### å•é¡Œã®åŸå› 

1. **ç‹¬ç«‹ã—ãŸãƒˆãƒªã‚¬ãƒ¼**

   - `infra-deploy.yml`: `infra/**` ã®å¤‰æ›´ã§å®Ÿè¡Œ
   - `app-deploy.yml`: `app/**` ã®å¤‰æ›´ã§å®Ÿè¡Œ
   - ä¸¡ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒä¸¦è¡Œå®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§

2. **ãƒªã‚½ãƒ¼ã‚¹æœªä½œæˆã‚¨ãƒ©ãƒ¼**

   - ACR ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã§ `az acr login` ãŒå¤±æ•—
   - AKS ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã§ `kubectl apply` ãŒå¤±æ•—

3. **æ‰‹å‹•å®Ÿè¡Œã®ç…©é›‘ã•**
   - Infrastructure ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’ç¢ºèª
   - æ‰‹å‹•ã§ App ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
   - é‹ç”¨ãƒŸã‚¹ã®å¯èƒ½æ€§

---

## âœ… è§£æ±ºç­–

### GitHub Actions ã® `workflow_run` ã‚¤ãƒ™ãƒ³ãƒˆ

Infrastructure ãƒ‡ãƒ—ãƒ­ã‚¤ãŒ**å®Œäº†ã—ã¦ã‹ã‚‰**è‡ªå‹•çš„ã« App ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã™ã‚‹ã€‚

#### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

**`.github/workflows/app-deploy.yml`**

```yaml
name: Build and Deploy Application

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - ".github/workflows/app-deploy.yml"
  workflow_dispatch:
  # âœ… Infrastructure ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã«è‡ªå‹•å®Ÿè¡Œ
  workflow_run:
    workflows: ["Deploy Infrastructure"]
    types:
      - completed
    branches:
      - main

env:
  ACR_NAME: acrwizdev
  IMAGE_NAME: guestbook
  RESOURCE_GROUP: rg-wiz-exercise-a

jobs:
  scan-container:
    name: Scan Container Image
    runs-on: ubuntu-latest
    # âœ… æˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œï¼ˆå¤±æ•—æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      # ... ä»¥ä¸‹çœç•¥
```

---

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³ 1: Infrastructure å¤‰æ›´æ™‚

```mermaid
graph LR
    A[infra/** å¤‰æ›´] --> B[Deploy Infrastructure]
    B -->|æˆåŠŸ| C[Build and Deploy Application]
    B -->|å¤±æ•—| D[App ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚­ãƒƒãƒ—]
```

1. `infra/**` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ push
2. `Deploy Infrastructure` ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
3. **æˆåŠŸã—ãŸå ´åˆ**: è‡ªå‹•çš„ã« `Build and Deploy Application` ãŒå®Ÿè¡Œ
4. **å¤±æ•—ã—ãŸå ´åˆ**: App ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Ÿè¡Œã•ã‚Œãªã„

### ãƒ‘ã‚¿ãƒ¼ãƒ³ 2: Application å¤‰æ›´æ™‚ï¼ˆå¾“æ¥é€šã‚Šï¼‰

```mermaid
graph LR
    A[app/** å¤‰æ›´] --> B[Build and Deploy Application]
```

1. `app/**` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ push
2. `Build and Deploy Application` ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒç›´æ¥å®Ÿè¡Œ
3. Infrastructure ã¯æ—¢ã«ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã¨æƒ³å®š

### ãƒ‘ã‚¿ãƒ¼ãƒ³ 3: æ‰‹å‹•å®Ÿè¡Œï¼ˆå¾“æ¥é€šã‚Šï¼‰

```
GitHub Actions UI â†’ workflow_dispatch â†’ ä»»æ„ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œ
```

---

## ğŸ“Š å®Ÿè£…ã®è©³ç´°

### `workflow_run` ãƒˆãƒªã‚¬ãƒ¼ã®ä»•æ§˜

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£  | èª¬æ˜                       | è¨­å®šå€¤                               |
| ----------- | -------------------------- | ------------------------------------ |
| `workflows` | ãƒˆãƒªã‚¬ãƒ¼å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å | `["Deploy Infrastructure"]`          |
| `types`     | ç›£è¦–ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ           | `completed` (æˆåŠŸãƒ»å¤±æ•—å•ã‚ãšå®Œäº†æ™‚) |
| `branches`  | å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ               | `main`                               |

### æ¡ä»¶åˆ†å² `if` ã®æ„å‘³

```yaml
if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
```

| æ¡ä»¶                                                | æ„å‘³                          | å®Ÿè¡Œ        |
| --------------------------------------------------- | ----------------------------- | ----------- |
| `github.event_name != 'workflow_run'`               | ç›´æ¥ãƒˆãƒªã‚¬ãƒ¼ï¼ˆpush/æ‰‹å‹•å®Ÿè¡Œï¼‰ | âœ… å®Ÿè¡Œ     |
| `github.event.workflow_run.conclusion == 'success'` | Infrastructure ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ   | âœ… å®Ÿè¡Œ     |
| `github.event.workflow_run.conclusion == 'failure'` | Infrastructure ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—   | âŒ ã‚¹ã‚­ãƒƒãƒ— |

---

## ğŸ¯ ãƒ¡ãƒªãƒƒãƒˆ

### 1. **è‡ªå‹•åŒ–ã®å‘ä¸Š**

- Infrastructure ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€æ‰‹å‹•å®Ÿè¡Œä¸è¦
- ä¸€é€£ã®æµã‚ŒãŒå®Œå…¨è‡ªå‹•åŒ–

### 2. **ã‚¨ãƒ©ãƒ¼å‰Šæ¸›**

- ACR/AKS ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã‚’é˜²æ­¢
- ãƒªã‚½ãƒ¼ã‚¹ä¾å­˜é–¢ä¿‚ã‚’æ˜ç¤ºçš„ã«å®šç¾©

### 3. **é‹ç”¨ã®ç°¡ç´ åŒ–**

- ãƒ‡ãƒ—ãƒ­ã‚¤é †åºã‚’æ„è­˜ã™ã‚‹å¿…è¦ãªã—
- GitHub Actions ãŒä¾å­˜é–¢ä¿‚ã‚’ç®¡ç†

### 4. **æŸ”è»Ÿæ€§ã®ç¶­æŒ**

- `app/**` å˜ç‹¬å¤‰æ›´æ™‚ã¯ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½
- æ‰‹å‹•å®Ÿè¡Œã‚‚å¼•ãç¶šãåˆ©ç”¨å¯èƒ½

---

## ğŸ“ æ³¨æ„äº‹é …

### Infrastructure ãŒæ—¢ã«ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®å ´åˆ

**`app/**` ã®ã¿å¤‰æ›´ã—ãŸå ´åˆ:\*\*

- `workflow_run` ãƒˆãƒªã‚¬ãƒ¼ã¯ç™ºç«ã—ãªã„
- `push` ãƒˆãƒªã‚¬ãƒ¼ã§ç›´æ¥å®Ÿè¡Œã•ã‚Œã‚‹
- ACR/AKS ã¯æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨

### ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«å¤‰æ›´ã—ãŸå ´åˆ

**åŒä¸€ã‚³ãƒŸãƒƒãƒˆã§ `infra/**`ã¨`app/**` ã‚’å¤‰æ›´:**

1. `Deploy Infrastructure` ãŒå®Ÿè¡Œã•ã‚Œã‚‹
2. `Build and Deploy Application` ã‚‚ `push` ã§ç›´æ¥å®Ÿè¡Œã•ã‚Œã‚‹
3. ã•ã‚‰ã« Infrastructure å®Œäº†å¾Œã«å†åº¦ App ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹

**å¯¾ç­–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰:**

- `app/**` ã® `paths` ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã€`workflow_run` ã®ã¿ã«ã™ã‚‹
- ã¾ãŸã¯ã€é‡è¤‡å®Ÿè¡Œã‚’è¨±å®¹ã™ã‚‹ï¼ˆå†ªç­‰æ€§ãŒã‚ã‚Œã°å•é¡Œãªã—ï¼‰

---

## ğŸ” æ¤œè¨¼æ–¹æ³•

### 1. Infrastructure ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒˆãƒªã‚¬ãƒ¼

```bash
# infra/ é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´
git add infra/
git commit -m "feat: Update infrastructure"
git push
```

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:**

1. `Deploy Infrastructure` ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒé–‹å§‹
2. å®Œäº†å¾Œã€è‡ªå‹•çš„ã« `Build and Deploy Application` ãŒé–‹å§‹

### 2. GitHub Actions UI ã§ã®ç¢ºèª

```
Actions ã‚¿ãƒ– â†’ Workflows
â”œâ”€â”€ Deploy Infrastructure (å®Ÿè¡Œä¸­/å®Œäº†)
â””â”€â”€ Build and Deploy Application (å¾…æ©Ÿä¸­ â†’ å®Ÿè¡Œä¸­)
    â””â”€â”€ triggered by: workflow_run (Deploy Infrastructure)
```

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [GitHub Actions: `workflow_run` event](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_run)
- [Workflow é–“ã®ä¾å­˜é–¢ä¿‚](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#running-a-workflow-based-on-the-conclusion-of-another-workflow)

---

## ğŸ”„ å¤‰æ›´å±¥æ­´

| æ—¥æ™‚       | å¤‰æ›´å†…å®¹                                      |
| ---------- | --------------------------------------------- |
| 2025-10-29 | åˆæœŸå®Ÿè£…: `workflow_run` ãƒˆãƒªã‚¬ãƒ¼è¿½åŠ          |
| 2025-10-29 | æ¡ä»¶åˆ†å²è¿½åŠ : Infrastructure å¤±æ•—æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ— |
