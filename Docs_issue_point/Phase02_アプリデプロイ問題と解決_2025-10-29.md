# Phase02: アプリケーションデプロイ時のトラブルシューティング

**日付**: 2025 年 10 月 29 日  
**対象**: AKS アプリケーションデプロイと Ingress 構成

---

## 📌 目次

1. [ACR 名の不一致エラー](#1-acr名の不一致エラー)
2. [Docker イメージのビルド失敗](#2-dockerイメージのビルド失敗)
3. [Pod のクラッシュループ](#3-podのクラッシュループ)
4. [Ingress デプロイエラー](#4-ingressデプロイエラー)
5. [UI の更新が反映されない問題](#5-uiの更新が反映されない問題)

---

## 1. ACR 名の不一致エラー

### ❌ 問題

GitHub Actions ワークフローで以下のエラー:

```plaintext
ERROR: Unable to authenticate using AAD or admin login credentials.
The resource with name 'acrwizexercise' could not be found.
```

### 🔍 原因

- ワークフローファイルで ACR 名が `acrwizexercise` と指定
- 実際に作成した ACR は `acrwizdev`
- 名前の不一致により認証失敗

### ✅ 解決方法

**修正ファイル**:

- `.github/workflows/app-deploy.yml`
- `pipelines/azure-pipelines-app.yml`

**変更内容**:

```yaml
# Before
env:
  ACR_NAME: acrwizexercise

# After
env:
  ACR_NAME: acrwizdev
```

**コマンド**:

```bash
git add .github/workflows/app-deploy.yml pipelines/azure-pipelines-app.yml
git commit -m "fix: Update ACR name from acrwizexercise to acrwizdev"
git push origin main
```

### 📝 学習ポイント

- インフラ名とコード内の参照を一致させる
- 環境変数の一元管理が重要

---

## 2. Docker イメージのビルド失敗

### ❌ 問題

Pod が起動時に以下のエラーでクラッシュ:

```plaintext
Error: Cannot find module 'express'
Require stack:
- /app/app.js
```

### 🔍 原因分析

**調査コマンド**:

```bash
kubectl logs guestbook-app-d8697856c-vwhzl
```

**原因**:

1. `package.json` に `dependencies` セクションが存在しない
2. `npm install --production` が依存関係をインストールしなかった
3. Docker イメージ内に Node.js モジュールが含まれていない

**元の package.json**:

```json
{
  "name": "wiz-technical-exercise-app",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "start": "node app.js"
  }
}
```

### ✅ 解決方法

**Step 1: package.json の修正**

```json
{
  "name": "wiz-technical-exercise-app",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "start": "node app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^7.6.3",
    "body-parser": "^1.20.2",
    "ejs": "^3.1.9"
  }
}
```

**Step 2: Dockerfile の微調整**

```dockerfile
# Before
RUN npm install --production

# After
RUN npm install --omit=dev
```

**Step 3: 新しいイメージのビルド**

```bash
az acr build --registry acrwizdev --image guestbook:v3 .
```

**Step 4: Deployment の更新**

```yaml
spec:
  containers:
    - name: guestbook
      image: acrwizdev.azurecr.io/guestbook:v3
```

### 📊 ビルド結果の比較

| バージョン | 依存関係       | ビルド状態 | 実行状態      |
| ---------- | -------------- | ---------- | ------------- |
| v1, v2     | 0 パッケージ   | ✅ 成功    | ❌ クラッシュ |
| v3 以降    | 102 パッケージ | ✅ 成功    | ✅ 正常動作   |

### 📝 学習ポイント

- `package.json` の依存関係定義は必須
- ビルドが成功してもランタイムエラーの可能性
- ログ確認が重要 (`kubectl logs`)

---

## 3. Pod のクラッシュループ

### ❌ 問題

```bash
$ kubectl get pods
NAME                             READY   STATUS             RESTARTS
guestbook-app-d8697856c-4swnz   0/1     ImagePullBackOff   0
guestbook-app-d8697856c-vwhzl   0/1     CrashLoopBackOff   3
```

### 🔍 原因

**ImagePullBackOff**:

- ACR からイメージをプルできない
- DNS 解決の問題
- 認証問題

**CrashLoopBackOff**:

- アプリケーション起動時のエラー
- 依存モジュールの欠落

### ✅ 解決方法

**1. ACR と AKS の統合確認**

```bash
az aks update \
  --resource-group rg-cicd-aks-bbs01 \
  --name aks-wiz-dev \
  --attach-acr acrwizdev
```

**2. Pod 詳細の確認**

```bash
kubectl describe pod <pod-name>
```

**3. イメージの存在確認**

```bash
az acr repository show \
  --name acrwizdev \
  --image guestbook:v3
```

**4. 修正後の再デプロイ**

```bash
kubectl apply -f app/k8s/deployment.yaml
kubectl rollout status deployment/guestbook-app
```

### 📝 学習ポイント

- `describe pod` でイベント履歴を確認
- ACR 統合は `--attach-acr` で簡単に設定可能
- ローリングアップデートを監視

---

## 4. Ingress デプロイエラー

### ❌ 問題

Ingress リソース作成時のエラー:

```plaintext
The Ingress "guestbook-ingress" is invalid:
annotations.kubernetes.io/ingress.class: Invalid value: "azure/application-gateway":
must match `ingressClassName` when both are specified
```

### 🔍 原因

**元の Ingress 設定**:

```yaml
metadata:
  annotations:
    kubernetes.io/ingress.class: azure/application-gateway
spec:
  ingressClassName: azure-application-gateway
```

**問題点**:

- アノテーションとクラス名の不一致
- Application Gateway Ingress Controller (AGIC) が未インストール
- AGIC は Azure Application Gateway が必要（追加コスト）

### ✅ 解決方法 (Option 1: Ingress 削除)

**一時的な対処**:

```yaml
# ワークフローからIngress適用を削除
# kubectl apply -f app/k8s/ingress.yaml  # コメントアウト
```

### ✅ 解決方法 (Option 2: NGINX Ingress 使用) ← 採用

**Step 1: NGINX Ingress Controller のインストール**

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml
```

**Step 2: Service の変更 (LoadBalancer → ClusterIP)**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: guestbook-service
spec:
  type: ClusterIP # LoadBalancerから変更
  selector:
    app: guestbook
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
```

**Step 3: Ingress の修正**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: guestbook-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx # nginxに変更
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: guestbook-service
                port:
                  number: 80
```

**Step 4: 適用**

```bash
kubectl apply -f app/k8s/service.yaml
kubectl apply -f app/k8s/ingress.yaml
```

**Step 5: LoadBalancer IP の確認**

```bash
kubectl get svc -n ingress-nginx
```

**結果**:

```plaintext
NAME                       TYPE           EXTERNAL-IP
ingress-nginx-controller   LoadBalancer   20.18.117.80
```

### 📊 Ingress Controller の比較

| 項目           | NGINX Ingress       | Application Gateway      |
| -------------- | ------------------- | ------------------------ |
| 追加コスト     | 無料                | Application Gateway 料金 |
| セットアップ   | 簡単                | 複雑 (AGIC インストール) |
| 管理           | Kubernetes 内       | Azure リソース           |
| パフォーマンス | 高速                | 高速 (WAF 機能あり)      |
| 推奨ケース     | 一般的な Web アプリ | エンタープライズ         |

### 📝 学習ポイント

- Ingress Controller は別途インストールが必要
- NGINX は最もシンプルで実績のある選択肢
- Ingress は内部 Service を使用 (ClusterIP)

---

## 5. UI の更新が反映されない問題

### ❌ 問題

`index.ejs` を編集して Git にプッシュしても、ブラウザで変更が反映されない

### 🔍 原因

**調査**:

```bash
kubectl describe deployment guestbook-app | Select-String "Image:"
```

**結果**:

```plaintext
Image: acrwizdev.azurecr.io/guestbook:v3
```

**問題点**:

1. Deployment が固定イメージタグ `v3` を使用
2. GitHub Actions は `github.sha` タグでビルドしている
3. ワークフローは動的タグを Deployment に反映していない

### ✅ 解決方法

**Step 1: ワークフローの修正**

```yaml
# Before
sed -i "s|<ACR_NAME>|${{ env.ACR_NAME }}|g" app/k8s/deployment.yaml

# After
sed -i "s|image: acrwizdev.azurecr.io/guestbook:.*|image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ needs.build-push.outputs.image_tag }}|g" app/k8s/deployment.yaml
```

**Step 2: テスト用の変更**

```html
<!-- Before -->
<title>BBS App on AKS</title>

<!-- After -->
<title>🚀 Wiz BBS App on AKS</title>
```

**Step 3: コミット&プッシュ**

```bash
git add app/views/index.ejs
git commit -m "test: Update app title to test auto-deployment"
git push origin main
```

**Step 4: GitHub Actions の自動実行**

- ワークフローが自動トリガー
- Commit SHA タグでイメージビルド
- Deployment が新しいイメージで更新
- ローリングアップデート実行

### 📊 デプロイフロー

```plaintext
コード変更 (app/)
    ↓
Git Push
    ↓
GitHub Actions トリガー
    ↓
Dockerイメージビルド (SHA: f137a12)
    ↓
ACRにプッシュ
    ↓
Deployment更新 (image: acrwizdev.azurecr.io/guestbook:f137a12)
    ↓
Kubernetesローリングアップデート
    ↓
新しいPodが起動
    ↓
ブラウザで変更確認
```

### 🎯 最終的な自動化構成

**トリガー条件**:

```yaml
on:
  push:
    branches:
      - main
    paths:
      - "app/**"
```

**イメージタグ戦略**:

- 開発: Commit SHA (例: `f137a12`)
- リリース: セマンティックバージョン (例: `v1.0.0`)

### 📝 学習ポイント

- 固定タグは自動デプロイに不向き
- Commit SHA タグで変更を追跡可能
- `sed` でマニフェストを動的に更新

---

## 🛠️ 便利なデバッグコマンド集

### Pod 関連

```bash
# Podの状態確認
kubectl get pods -l app=guestbook

# Pod詳細情報
kubectl describe pod <pod-name>

# ログ確認
kubectl logs <pod-name>

# 前回のログ確認 (クラッシュ時)
kubectl logs <pod-name> --previous

# Podに接続
kubectl exec -it <pod-name> -- /bin/sh
```

### Deployment 関連

```bash
# Deployment状態
kubectl get deployment guestbook-app

# ローリングアップデート監視
kubectl rollout status deployment/guestbook-app

# ロールバック
kubectl rollout undo deployment/guestbook-app

# 履歴確認
kubectl rollout history deployment/guestbook-app
```

### Service & Ingress 関連

```bash
# Service確認
kubectl get svc

# Ingress確認
kubectl get ingress

# Ingress Controller確認
kubectl get all -n ingress-nginx

# LoadBalancer IP確認
kubectl get svc -n ingress-nginx ingress-nginx-controller
```

### イメージ関連

```bash
# ACRイメージ一覧
az acr repository list --name acrwizdev

# イメージタグ一覧
az acr repository show-tags --name acrwizdev --repository guestbook

# イメージ詳細
az acr repository show --name acrwizdev --image guestbook:v3
```

---

## ✅ トラブルシューティングチェックリスト

### デプロイ前

- [ ] ACR 名がコード内で一致している
- [ ] `package.json` に依存関係が定義されている
- [ ] Dockerfile が正しく構成されている
- [ ] マニフェストファイルが最新か

### デプロイ中

- [ ] イメージが ACR に存在する
- [ ] AKS と ACR が統合されている
- [ ] Pod が正常に起動している
- [ ] Service にエンドポイントがある

### デプロイ後

- [ ] Ingress が正しく構成されている
- [ ] LoadBalancer IP が割り当てられている
- [ ] HTTP アクセスが可能
- [ ] アプリケーションが正常動作

---

**作成日**: 2025 年 10 月 29 日  
**最終更新**: 2025 年 10 月 29 日
