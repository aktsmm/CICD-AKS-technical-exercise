# Phase 14: AKS パブリック IP 用途解説

**日付**: 2025 年 10 月 30 日  
**カテゴリ**: AKS / ネットワーキング

---

## 📋 概要

AKS クラスターデプロイ時に自動作成される 2 つのパブリック IP アドレスの用途と役割を解説します。

---

## 🌐 AKS が作成する 2 つのパブリック IP

AKS クラスターをデプロイすると、Managed Resource Group (`MC_*`) 内に**2 つのパブリック IP アドレス**が自動作成されます。

### パブリック IP 一覧

```powershell
# 確認コマンド
az network public-ip list `
  --resource-group MC_rg-cicd-aks-bbs-01_aksdev_japaneast `
  --query "[].{Name:name, IP:ipAddress}" -o table
```

**結果:**

| 名前 (GUID)                                   | IP アドレス     | 用途                                         |
| --------------------------------------------- | --------------- | -------------------------------------------- |
| `b6575400-f57a-4724-a7fc-b74529fc4c79`        | `20.**.***.**2` | **AKS クラスターのアウトバウンド通信**       |
| `kubernetes-adb690bcea33f4508b131815176cfdb5` | `4.***.**.75`   | **LoadBalancer Service (guestbook-service)** |

---

## 1️⃣ アウトバウンド IP (`20.**.***.**2`)

### 🎯 用途

AKS ノード(Pod)から**インターネットへの送信**時に使用される IP アドレス。

### 主な使用シーン

| シーン                    | 説明                                         | 例                                                   |
| ------------------------- | -------------------------------------------- | ---------------------------------------------------- |
| **コンテナイメージ pull** | ACR や Docker Hub からイメージをダウンロード | `docker pull acrwizdev*.azurecr.io/guestbook:latest` |
| **パッケージ更新**        | OS/アプリのパッケージ取得                    | `apt-get update`, `npm install`                      |
| **DNS 解決**              | 外部ドメイン名の名前解決                     | `nslookup google.com`                                |
| **外部 API 呼び出し**     | Pod 内アプリが外部サービスにアクセス         | `curl https://api.example.com`                       |
| **Azure Storage 接続**    | MongoDB バックアップのアップロード           | `az storage blob upload`                             |
| **GitHub 通信**           | GitHub Actions ランナーとの通信              | `git clone`, webhook 受信                            |

### Bicep 設定

```bicep
// infra/modules/aks.bicep
resource aks 'Microsoft.ContainerService/managedClusters@2023-10-01' = {
  properties: {
    networkProfile: {
      networkPlugin: 'azure'
      loadBalancerSku: 'standard'
      outboundType: 'loadBalancer'  // ← このIPを使用
    }
  }
}
```

### トラフィックフロー

```
AKS Pod (10.0.1.x)
    ↓
Standard Load Balancer (SNAT)
    ↓ 送信元IP: 20.**.***.**2
インターネット/ACR/Azure Storage
```

### 確認方法

```powershell
# Pod内から送信元IPを確認
kubectl run test-outbound --image=curlimages/curl --rm -it --restart=Never \
  -- curl -s ifconfig.me
# 出力: 20.**.***.**2
```

---

## 2️⃣ LoadBalancer Service の IP (`4.***.**.75`)

### 🎯 用途

Kubernetes の`type: LoadBalancer` Service に割り当てられる**外部公開用 IP**。

### 主な使用シーン

| シーン                     | 説明                                   |
| -------------------------- | -------------------------------------- |
| **外部から HTTP アクセス** | ブラウザからアプリケーションへアクセス |
| **ロードバランシング**     | 複数 Pod へのトラフィック分散          |
| **ヘルスチェック**         | Azure Load Balancer による死活監視     |

### Kubernetes Service 定義

```yaml
# app/k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: guestbook-service
spec:
  type: LoadBalancer # ← 自動的にパブリックIPを作成
  selector:
    app: guestbook
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
```

### トラフィックフロー

```
ユーザーブラウザ
    ↓ http://4.***.**.75
Azure Load Balancer
    ↓
AKS Pod (guestbook-app:3000)
```

### 確認方法

```powershell
# ServiceのExternal-IPを確認
kubectl get svc guestbook-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
# 出力: 4.***.**.75

# ブラウザでアクセス
Start-Process "http://4.***.**.75"
```

---

## 🔄 2 つの IP の関係性

### 通信方向別の使用 IP

```text
【インバウンド: 外部 → AKS】
ユーザー → 4.***.**.75 (LoadBalancer IP) → AKS Pod

【アウトバウンド: AKS → 外部】
AKS Pod → 20.**.***.**2 (Outbound IP) → インターネット

【VNet内通信: AKS ↔ MongoDB】
AKS Pod (10.0.1.x) → MongoDB VM (10.0.2.4)
※ VNet内通信なのでパブリックIPは使用されない
```

---

## 🌐 ネットワーク構成と通信フロー

### VNet 全体構成

```text
┌─────────────────────────────────────────────────────────────────────┐
│  VNet: vnetdev (10.0.0.0/16)                                   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Subnet: snet-aks (10.0.1.0/24)                              │  │
│  │                                                               │  │
│  │  ┌────────────────────────────────────────────────────┐     │  │
│  │  │  AKS Node 1 (10.0.1.4)                             │     │  │
│  │  │  ├─ Pod: guestbook-app-xxx (10.0.1.10)            │     │  │
│  │  │  └─ Pod: guestbook-app-yyy (10.0.1.11)            │     │  │
│  │  └────────────────────────────────────────────────────┘     │  │
│  │                                                               │  │
│  │  ┌────────────────────────────────────────────────────┐     │  │
│  │  │  AKS Node 2 (10.0.1.5)                             │     │  │
│  │  │  ├─ Pod: guestbook-app-zzz (10.0.1.12)            │     │  │
│  │  │  └─ Pod: coredns-xxx (10.0.1.13)                  │     │  │
│  │  └────────────────────────────────────────────────────┘     │  │
│  │                                                               │  │
│  │  ┌────────────────────────────────────────────────────┐     │  │
│  │  │  Standard Load Balancer                            │     │  │
│  │  │  ├─ Frontend IP: 4.***.**.75 (LoadBalancer)       │     │  │
│  │  │  └─ Outbound IP: 20.**.***.**2 (SNAT Pool)        │     │  │
│  │  └────────────────────────────────────────────────────┘     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Subnet: snet-mongo (10.0.2.0/24)                            │  │
│  │                                                               │  │
│  │  ┌────────────────────────────────────────────────────┐     │  │
│  │  │  VM: vm-mongo-dev (10.0.2.4)                       │     │  │
│  │  │  ├─ Public IP: 52.***.**.*** (SSH用)              │     │  │
│  │  │  ├─ Port 22: SSH                                   │     │  │
│  │  │  └─ Port 27017: MongoDB                            │     │  │
│  │  └────────────────────────────────────────────────────┘     │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### シナリオ別通信フロー

#### シナリオ 1: ユーザーが Web アプリにアクセス

```text
[1] ブラウザ (インターネット)
     ↓ HTTP GET http://4.***.**.75
     │ 送信元: 203.0.113.100 (ユーザーIP)
     │ 宛先: 4.***.**.75:80

[2] Azure Load Balancer (Frontend IP)
     ↓ ロードバランシング (ラウンドロビン)
     │ 宛先: 10.0.1.10:3000 (Pod IP)

[3] AKS Node 1 (10.0.1.4)
     ↓ kube-proxy (iptables/IPVS)
     │ DNAT: 10.0.1.10:3000

[4] Pod: guestbook-app-xxx (10.0.1.10)
     ↓ Node.js Express サーバーで処理
     │ レスポンス生成

[5] 応答パケット
     ↓ 送信元: 10.0.1.10:3000
     │ 宛先: 203.0.113.100

[6] Load Balancer
     ↓ SNAT (送信元を 4.***.**.75 に変換)
     │ 送信元: 4.***.**.75:80

[7] ブラウザにレスポンス到達
```

**使用される IP:**

- **インバウンド**: `4.***.**.75` (LoadBalancer Service IP)
- **アウトバウンド**: `4.***.**.75` (同じ IP で応答)

---

#### シナリオ 2: Pod から MongoDB へのデータベースアクセス

```text
[1] Pod: guestbook-app-xxx (10.0.1.10)
     ↓ MongoDB接続
     │ 送信元: 10.0.1.10:xxxxx
     │ 宛先: 10.0.2.4:27017
     │ プロトコル: TCP (MongoDB Wire Protocol)

[2] VNet内部ルーティング (Azure SDN)
     ↓ サブネット間通信
     │ snet-aks (10.0.1.0/24) → snet-mongo (10.0.2.0/24)
     │ ※ パブリックIPは使用されない

[3] NSG (vm-mongo-dev-nsg) でルール評価
     ↓ 許可ルール: Allow-MongoDB (Priority 110)
     │ 送信元: 10.0.0.0/16 (VNet全体)
     │ 宛先ポート: 27017

[4] VM: vm-mongo-dev (10.0.2.4)
     ↓ MongoDB プロセス (mongod)
     │ ポート 27017 でリッスン

[5] MongoDB クエリ実行
     ↓ データベース操作
     │ db.messages.find()

[6] 応答パケット
     ↓ 送信元: 10.0.2.4:27017
     │ 宛先: 10.0.1.10:xxxxx

[7] Pod でデータ受信
```

**使用される IP:**

- **通信経路**: VNet 内部のプライベート IP のみ
- **パブリック IP**: 使用されない (VNet 内完結)

**NSG ルール:**

```text
Priority 110: Allow-MongoDB
  Source: 10.0.0.0/16 (VNet)
  Destination: * (Any)
  Port: 27017
  Protocol: TCP
  Action: Allow
```

---

#### シナリオ 3: Pod から ACR へのイメージ pull

```text
[1] Kubelet (AKS Node: 10.0.1.4)
     ↓ イメージpull要求
     │ 宛先: acrwizdev*.azurecr.io:443
     │ DNS解決: 52.***.***.*** (ACR Public IP)

[2] DNS解決 (Azure DNS経由)
     ↓ クエリ: acrwizdev*.azurecr.io
     │ 応答: 52.***.***.***(ACR パブリックIP)

[3] AKS Node からアウトバウンド通信
     ↓ 送信元: 10.0.1.4 (Node IP)
     │ 宛先: 52.***.***.***:443

[4] Standard Load Balancer (SNAT)
     ↓ 送信元NATを実行
     │ 送信元: 10.0.1.4 → 20.**.***.**2 (Outbound IP)
     │ 宛先: 52.***.***.***:443

[5] インターネット経由でACR到達
     ↓ Azure Backbone経由
     │ HTTPS (TLS 1.2)

[6] ACR (Azure Container Registry)
     ↓ Managed Identity認証
     │ AKS Kubelet Identity: AcrPull権限確認

[7] イメージレイヤーをダウンロード
     ↓ 応答パケット
     │ 送信元: 52.***.***.***:443
     │ 宛先: 20.**.***.**2

[8] Load Balancer (逆NAT)
     ↓ 宛先を元に戻す
     │ 宛先: 20.**.***.**2 → 10.0.1.4

[9] AKS Node でイメージ受信
     ↓ containerd でイメージ展開
     │ /var/lib/containerd/
```

**使用される IP:**

- **アウトバウンド**: `20.**.***.**2` (SNAT 経由)
- **認証**: Managed Identity (Kubelet Identity)

**通信プロトコル:**

- HTTPS (TLS 1.2) on port 443
- Docker Registry API v2

---

#### シナリオ 4: VM から Storage Account へのバックアップアップロード

```text
[1] VM: vm-mongo-dev (10.0.2.4)
     ↓ cron ジョブ実行 (毎日 2:00 AM JST)
     │ /usr/local/bin/mongodb-backup.sh

[2] MongoDB バックアップ作成
     ↓ mongodump コマンド
     │ 出力: /tmp/backup-20251030.gz

[3] Azure CLI ログイン (Managed Identity)
     ↓ az login --identity
     │ VM System Assigned Identity使用

[4] Azure Storage Blob Upload
     ↓ az storage blob upload
     │ 送信元: 10.0.2.4
     │ 宛先: stwizdev*.blob.core.windows.net:443

[5] VM からアウトバウンド通信
     ↓ NSG ルール評価
     │ Outbound Rule: AllowAzureCloud (Default)

[6] Public IP経由でインターネット
     ↓ NAT実行
     │ 送信元: 10.0.2.4 → 52.***.**.*** (VM Public IP)
     │ 宛先: 20.***.***.***:443 (Storage Account)

[7] Azure Storage Account
     ↓ Azure AD認証
     │ VM Managed Identity: Storage Blob Data Contributor

[8] Blob Container (backups)
     ↓ ファイル保存
     │ backup-20251030.gz
     │ サイズ: 512 MB

[9] アップロード完了応答
     ↓ HTTP 201 Created
     │ 送信元: 20.***.***.***:443
     │ 宛先: 52.***.**.***(VM Public IP)

[10] VM で結果受信
      ↓ ログ記録
      │ /var/log/mongodb-backup.log
```

**使用される IP:**

- **送信元**: `52.***.**.**`(VM Public IP)
- **宛先**: Storage Account Public Endpoint
- **認証**: VM System Assigned Managed Identity

**NSG ルール:**

```text
Default Outbound Rule: AllowAzureCloud
  Source: VirtualNetwork
  Destination: AzureCloud
  Port: 443
  Protocol: TCP
  Action: Allow (Default)
```

---

#### シナリオ 5: GitHub Actions から AKS へのデプロイ

```text
[1] GitHub Actions Runner (インターネット)
     ↓ kubectl apply実行
     │ 送信元: GitHub Runner IP
     │ 宛先: aksdev API Server (パブリックエンドポイント)

[2] AKS API Server (パブリッククラスター)
     ↓ HTTPS (TLS 1.2) on port 443
     │ FQDN: aksdev-xxx.hcp.japaneast.azmk8s.io

[3] Azure AD認証
     ↓ Service Principal認証
     │ AZURE_CREDENTIALS (GitHub Secret)

[4] RBAC権限確認
     ↓ クラスター管理者権限チェック
     │ az aks get-credentials で取得したkubeconfig

[5] Kubernetes リソース作成
     ↓ kubectl apply -f deployment.yaml
     │ Deployment, Service, RBAC作成

[6] Kubelet がイメージpull
     ↓ ACRから取得 (シナリオ3参照)
     │ アウトバウンドIP: 20.**.***.**2使用

[7] Pod 起動
     ↓ コンテナ実行
     │ guestbook-app:latest

[8] Service Reconciliation
     ↓ LoadBalancer IPを割り当て
     │ 4.***.**.75を既存IPから再利用
```

**使用される IP:**

- **API Server**: AKS パブリックエンドポイント
- **イメージ pull**: `20.**.***.**2` (アウトバウンド IP)

**認証フロー:**

```text
GitHub Actions
  ↓ AZURE_CREDENTIALS (Service Principal)
Azure AD
  ↓ トークン発行
AKS API Server
  ↓ RBAC評価
kubectl コマンド実行許可
```

---

### ネットワークポリシーとセキュリティ境界

#### 現在のセキュリティ設定

```text
┌─────────────────────────────────────────────────────────────┐
│  インターネット                                              │
│                                                              │
│  ✅ Port 80/443: LoadBalancer Service (4.***.**.75)          │
│  ✅ Port 443: AKS API Server (パブリッククラスター)          │
│  ⚠️ Port 22: MongoDB VM SSH (52.***.**.**) [脆弱性]        │
└─────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Azure Virtual Network (10.0.0.0/16)                        │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  snet-aks (10.0.1.0/24)                              │  │
│  │  ├─ NSG: aks-agentpool-nsg (自動作成)               │  │
│  │  ├─ 許可: LoadBalancer Health Probe                 │  │
│  │  └─ 許可: VNet内部通信                              │  │
│  └──────────────────────────────────────────────────────┘  │
│                              ▼                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  snet-mongo (10.0.2.0/24)                            │  │
│  │  ├─ NSG: vm-mongo-dev-nsg                            │  │
│  │  ├─ ⚠️ Allow SSH from Internet (Priority 100)       │  │
│  │  └─ ✅ Allow MongoDB from VNet (Priority 110)       │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

#### 推奨セキュリティ改善

```text
【現在の脆弱性】
⚠️ MongoDB VM SSH: インターネット全体に公開
⚠️ MongoDB: 認証なし (デモ用の意図的な設定)
⚠️ Kubernetes RBAC: cluster-admin 権限付与

【推奨改善策】
1. SSH アクセス制限
   - 特定IPのみ許可
   - Azure Bastion使用

2. MongoDB認証有効化
   - ユーザー/パスワード設定
   - TLS/SSL有効化

3. RBAC最小権限
   - namespace単位の権限
   - developer-role (view/edit のみ)

4. Network Policy適用
   - Pod間通信制限
   - Egress制限
```

---

## ネットワーク設定の実装 (Bicep)

### VNet とサブネット定義

```bicep
// infra/modules/networking.bicep
resource vnet 'Microsoft.Network/virtualNetworks@2023-05-01' = {
  name: 'vnet${environment}'
  location: location
  properties: {
    addressSpace: {
      addressPrefixes: [
        '10.0.0.0/16'  // VNet全体
      ]
    }
    subnets: [
      {
        name: 'snet-aks'
        properties: {
          addressPrefix: '10.0.1.0/24'  // AKSノード用
          privateEndpointNetworkPolicies: 'Disabled'
        }
      }
      {
        name: 'snet-mongo'
        properties: {
          addressPrefix: '10.0.2.0/24'  // MongoDB VM用
        }
      }
    ]
  }
}
```

### AKS ネットワーク設定

```bicep
// infra/modules/aks.bicep
resource aks 'Microsoft.ContainerService/managedClusters@2023-10-01' = {
  properties: {
    networkProfile: {
      networkPlugin: 'azure'           // Azure CNI
      serviceCidr: '10.1.0.0/16'       // Service IP範囲
      dnsServiceIP: '10.1.0.10'        // CoreDNS IP
      loadBalancerSku: 'standard'      // Standard LB
      outboundType: 'loadBalancer'     // アウトバウンドIP使用
    }
  }
}
```

### NSG ルール定義

```bicep
// infra/modules/vm-mongodb.bicep
resource nsg 'Microsoft.Network/networkSecurityGroups@2023-05-01' = {
  properties: {
    securityRules: [
      {
        name: 'Allow-SSH-Internet'
        properties: {
          priority: 100
          direction: 'Inbound'
          access: 'Allow'
          protocol: 'Tcp'
          sourcePortRange: '*'
          destinationPortRange: '22'
          sourceAddressPrefix: '*'      // ⚠️ 脆弱性: 全開放
          destinationAddressPrefix: '*'
        }
      }
      {
        name: 'Allow-MongoDB'
        properties: {
          priority: 110
          direction: 'Inbound'
          access: 'Allow'
          protocol: 'Tcp'
          sourcePortRange: '*'
          destinationPortRange: '27017'
          sourceAddressPrefix: '10.0.0.0/16'  // VNet内のみ
          destinationAddressPrefix: '*'
        }
      }
    ]
  }
}
```

---

## ❓ よくある質問

### Q1: アウトバウンド IP は削除できますか?

**A:** 技術的には可能ですが、代替手段が必要です。

| 方法                  | 設定                                     | コスト       |
| --------------------- | ---------------------------------------- | ------------ |
| **現在 (デフォルト)** | `outboundType: 'loadBalancer'`           | **~$4/月**   |
| **NAT Gateway**       | `outboundType: 'userAssignedNATGateway'` | **~$35/月**  |
| **Azure Firewall**    | `outboundType: 'userDefinedRouting'`     | **~$700/月** |

**推奨**: 現在の構成を維持 (シンプル&低コスト)

### Q2: LoadBalancer IP は固定できますか?

**A:** はい、静的パブリック IP を事前作成して割り当て可能です。

```yaml
# 事前にパブリックIP作成
az network public-ip create \
  --resource-group MC_* \
  --name static-lb-ip \
  --sku Standard \
  --allocation-method Static

# Serviceに指定
apiVersion: v1
kind: Service
metadata:
  name: guestbook-service
spec:
  type: LoadBalancer
  loadBalancerIP: 4.***.**.75  # 固定IP指定
```

### Q3: プライベートクラスターにするとどうなりますか?

**A:** API サーバーは非公開になりますが、アウトバウンド IP は必要です。

```bicep
apiServerAccessProfile: {
  enablePrivateCluster: true  // APIサーバーを非公開
}
networkProfile: {
  outboundType: 'loadBalancer'  // アウトバウンドIPは必要
}
```

- ✅ API サーバー: プライベートエンドポイント経由
- ✅ LoadBalancer Service: 引き続き公開可能
- ✅ アウトバウンド通信: `20.**.***.**2` を使用

---

## 💰 コスト情報

### パブリック IP 関連のコスト

| 項目                           | 価格 (Japan East)                     |
| ------------------------------ | ------------------------------------- |
| **Standard SKU パブリック IP** | **$3.65/月** (各)                     |
| **アウトバウンドデータ転送**   | 最初の 5GB: 無料<br>5GB 超: $0.087/GB |
| **Load Balancer**              | 無料 (Standard SKU 内)                |

**今回の構成の月額コスト:**

- パブリック IP × 2 = **$7.30/月**
- データ転送 (想定 5GB 以内) = **$0/月**
- **合計: 約 $7-8/月**

### コスト削減の考慮点

- ✅ **現在の構成が最適** (低コスト&シンプル)
- ⚠️ NAT Gateway への移行はコスト増 (+$30/月)
- ⚠️ Azure Firewall は高コスト (+$690/月)

---

## 🔒 セキュリティ考慮事項

### アウトバウンド IP の制御

```powershell
# NSGでアウトバウンド制御
az network nsg rule create \
  --resource-group rg-cicd-aks-bbs-01 \
  --nsg-name aks-nsg \
  --name allow-acr-only \
  --priority 100 \
  --destination-address-prefixes AzureContainerRegistry \
  --destination-port-ranges 443 \
  --access Allow
```

### LoadBalancer IP の保護

```yaml
# Serviceにソース制限を追加
apiVersion: v1
kind: Service
metadata:
  name: guestbook-service
spec:
  type: LoadBalancer
  loadBalancerSourceRanges: # アクセス元IP制限
    - 203.0.113.0/24 # 特定ネットワークのみ許可
```

---

## 📊 監視とトラブルシューティング

### パブリック IP の使用状況確認

```powershell
# パブリックIP詳細情報
az network public-ip show \
  --resource-group MC_rg-cicd-aks-bbs-01_aksdev_japaneast \
  --name b6575400-f57a-4724-a7fc-b74529fc4c79 \
  --query "{IP:ipAddress, Status:provisioningState, Allocation:publicIPAllocationMethod}"

# LoadBalancerのバックエンドプール確認
az network lb show \
  --resource-group MC_rg-cicd-aks-bbs-01_aksdev_japaneast \
  --name kubernetes \
  --query "backendAddressPools[].backendIPConfigurations[].id"
```

### トラブルシューティング

#### 問題 1: LoadBalancer IP が割り当てられない

```powershell
# Serviceイベント確認
kubectl describe svc guestbook-service

# よくある原因:
# - クォータ超過
# - NSGルールでブロック
# - Load Balancerのヘルスチェック失敗
```

**解決策:**

```powershell
# クォータ確認
az network public-ip list --query "length([])"

# NSGルール確認
az network nsg rule list --resource-group MC_* --nsg-name aks-*-nsg
```

#### 問題 2: アウトバウンド通信が失敗する

```powershell
# Pod内から疎通確認
kubectl run debug --image=nicolaka/netshoot --rm -it --restart=Never -- /bin/bash
# コンテナ内で: curl -v https://acr*.azurecr.io
```

**よくある原因:**

- NSG でアウトバウンドがブロックされている
- Azure Policy 違反
- ネットワークポリシーの誤設定

---

## 🎯 ベストプラクティス

### 1. **IP アドレスのドキュメント化**

```markdown
# docs/NETWORK_INFO.md

## パブリック IP アドレス一覧

- **アウトバウンド IP**: 20.**.\***.\*\*2
  - 用途: ACR pull, 外部 API 通信
- **LoadBalancer IP**: 4.**\*.**.75
  - 用途: アプリケーション公開 (http://4.***.**.75)
```

### 2. **DNS 名の設定**

```powershell
# LoadBalancer IPにDNS名を設定
az network public-ip update \
  --resource-group MC_* \
  --name kubernetes-* \
  --dns-name guestbook-app-demo

# アクセス: http://guestbook-app-demo.japaneast.cloudapp.azure.com
```

### 3. **タグ付けによる管理**

```powershell
# パブリックIPにタグ追加
az network public-ip update \
  --resource-group MC_* \
  --name b6575400-* \
  --set tags.Purpose=AKS-Outbound tags.Environment=Dev
```

---

## 🔗 関連ファイル

- `infra/modules/aks.bicep` - AKS クラスター定義
- `infra/modules/networking.bicep` - VNet/Subnet 定義
- `app/k8s/service.yaml` - LoadBalancer Service 定義

---

## 🔗 参考リンク

- [AKS outbound network rules](https://learn.microsoft.com/azure/aks/limit-egress-traffic)
- [Use a Standard Load Balancer in AKS](https://learn.microsoft.com/azure/aks/load-balancer-standard)
- [AKS network concepts](https://learn.microsoft.com/azure/aks/concepts-network)
- [Azure Load Balancer pricing](https://azure.microsoft.com/pricing/details/load-balancer/)

---

## ✅ まとめ

| 項目                  | 内容                                             |
| --------------------- | ------------------------------------------------ |
| **アウトバウンド IP** | `20.**.***.**2` - AKS からインターネットへの通信 |
| **LoadBalancer IP**   | `4.***.**.75` - 外部から AKS へのアクセス        |
| **必要性**            | ✅ 両方とも必須 (現在の構成では削除不可)         |
| **コスト**            | 約 $7-8/月 (パブリック IP × 2)                   |
| **推奨**              | 🎯 現在の構成を維持 (シンプル&低コスト)          |

---

**作成者**: aktsmm  
**最終更新**: 2025 年 10 月 30 日
