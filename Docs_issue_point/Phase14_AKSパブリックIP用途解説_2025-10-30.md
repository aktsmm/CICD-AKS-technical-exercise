# Phase 14: AKS ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ç”¨é€”è§£èª¬

**æ—¥ä»˜**: 2025 å¹´ 10 æœˆ 30 æ—¥  
**ã‚«ãƒ†ã‚´ãƒª**: AKS / ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°

---

## ğŸ“‹ æ¦‚è¦

AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è‡ªå‹•ä½œæˆã•ã‚Œã‚‹ 2 ã¤ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç”¨é€”ã¨å½¹å‰²ã‚’è§£èª¬ã—ã¾ã™ã€‚

---

## ğŸŒ AKS ãŒä½œæˆã™ã‚‹ 2 ã¤ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP

AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€Managed Resource Group (`MC_*`) å†…ã«**2 ã¤ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹**ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚

### ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ä¸€è¦§

```powershell
# ç¢ºèªã‚³ãƒãƒ³ãƒ‰
az network public-ip list `
  --resource-group MC_rg-cicd-aks-bbs_aks-wiz-dev_japaneast `
  --query "[].{Name:name, IP:ipAddress}" -o table
```

**çµæœ:**

| åå‰ (GUID)                                   | IP ã‚¢ãƒ‰ãƒ¬ã‚¹     | ç”¨é€”                                         |
| --------------------------------------------- | --------------- | -------------------------------------------- |
| `b6575400-f57a-4724-a7fc-b74529fc4c79`        | `20.**.***.**2` | **AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡**       |
| `kubernetes-adb690bcea33f4508b131815176cfdb5` | `4.***.**.75`   | **LoadBalancer Service (guestbook-service)** |

---

## 1ï¸âƒ£ ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ IP (`20.**.***.**2`)

### ğŸ¯ ç”¨é€”

AKS ãƒãƒ¼ãƒ‰(Pod)ã‹ã‚‰**ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ã®é€ä¿¡**æ™‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã€‚

### ä¸»ãªä½¿ç”¨ã‚·ãƒ¼ãƒ³

| ã‚·ãƒ¼ãƒ³                    | èª¬æ˜                                         | ä¾‹                                                   |
| ------------------------- | -------------------------------------------- | ---------------------------------------------------- |
| **ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ pull** | ACR ã‚„ Docker Hub ã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ | `docker pull acrwizdev*.azurecr.io/guestbook:latest` |
| **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°**        | OS/ã‚¢ãƒ—ãƒªã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å–å¾—                    | `apt-get update`, `npm install`                      |
| **DNS è§£æ±º**              | å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã®åå‰è§£æ±º                     | `nslookup google.com`                                |
| **å¤–éƒ¨ API å‘¼ã³å‡ºã—**     | Pod å†…ã‚¢ãƒ—ãƒªãŒå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹         | `curl https://api.example.com`                       |
| **Azure Storage æ¥ç¶š**    | MongoDB ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰           | `az storage blob upload`                             |
| **GitHub é€šä¿¡**           | GitHub Actions ãƒ©ãƒ³ãƒŠãƒ¼ã¨ã®é€šä¿¡              | `git clone`, webhook å—ä¿¡                            |

### Bicep è¨­å®š

```bicep
// infra/modules/aks.bicep
resource aks 'Microsoft.ContainerService/managedClusters@2023-10-01' = {
  properties: {
    networkProfile: {
      networkPlugin: 'azure'
      loadBalancerSku: 'standard'
      outboundType: 'loadBalancer'  // â† ã“ã®IPã‚’ä½¿ç”¨
    }
  }
}
```

### ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼

```
AKS Pod (10.0.1.x)
    â†“
Standard Load Balancer (SNAT)
    â†“ é€ä¿¡å…ƒIP: 20.**.***.**2
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ/ACR/Azure Storage
```

### ç¢ºèªæ–¹æ³•

```powershell
# Podå†…ã‹ã‚‰é€ä¿¡å…ƒIPã‚’ç¢ºèª
kubectl run test-outbound --image=curlimages/curl --rm -it --restart=Never \
  -- curl -s ifconfig.me
# å‡ºåŠ›: 20.**.***.**2
```

---

## 2ï¸âƒ£ LoadBalancer Service ã® IP (`4.***.**.75`)

### ğŸ¯ ç”¨é€”

Kubernetes ã®`type: LoadBalancer` Service ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹**å¤–éƒ¨å…¬é–‹ç”¨ IP**ã€‚

### ä¸»ãªä½¿ç”¨ã‚·ãƒ¼ãƒ³

| ã‚·ãƒ¼ãƒ³                     | èª¬æ˜                                   |
| -------------------------- | -------------------------------------- |
| **å¤–éƒ¨ã‹ã‚‰ HTTP ã‚¢ã‚¯ã‚»ã‚¹** | ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã‚¢ã‚¯ã‚»ã‚¹ |
| **ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°**     | è¤‡æ•° Pod ã¸ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†æ•£          |
| **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**         | Azure Load Balancer ã«ã‚ˆã‚‹æ­»æ´»ç›£è¦–     |

### Kubernetes Service å®šç¾©

```yaml
# app/k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: guestbook-service
spec:
  type: LoadBalancer # â† è‡ªå‹•çš„ã«ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’ä½œæˆ
  selector:
    app: guestbook
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
```

### ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ©ã‚¦ã‚¶
    â†“ http://4.***.**.75
Azure Load Balancer
    â†“
AKS Pod (guestbook-app:3000)
```

### ç¢ºèªæ–¹æ³•

```powershell
# Serviceã®External-IPã‚’ç¢ºèª
kubectl get svc guestbook-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
# å‡ºåŠ›: 4.***.**.75

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹
Start-Process "http://4.***.**.75"
```

---

## ğŸ”„ 2 ã¤ã® IP ã®é–¢ä¿‚æ€§

### é€šä¿¡æ–¹å‘åˆ¥ã®ä½¿ç”¨ IP

```text
ã€ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰: å¤–éƒ¨ â†’ AKSã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ 4.***.**.75 (LoadBalancer IP) â†’ AKS Pod

ã€ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰: AKS â†’ å¤–éƒ¨ã€‘
AKS Pod â†’ 20.**.***.**2 (Outbound IP) â†’ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ

ã€VNetå†…é€šä¿¡: AKS â†” MongoDBã€‘
AKS Pod (10.0.1.x) â†’ MongoDB VM (10.0.2.4)
â€» VNetå†…é€šä¿¡ãªã®ã§ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¯ä½¿ç”¨ã•ã‚Œãªã„
```

---

## ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã¨é€šä¿¡ãƒ•ãƒ­ãƒ¼

### VNet å…¨ä½“æ§‹æˆ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VNet: vnet-wiz-dev (10.0.0.0/16)                                   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Subnet: snet-aks (10.0.1.0/24)                              â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚  AKS Node 1 (10.0.1.4)                             â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Pod: guestbook-app-xxx (10.0.1.10)            â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Pod: guestbook-app-yyy (10.0.1.11)            â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚  AKS Node 2 (10.0.1.5)                             â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Pod: guestbook-app-zzz (10.0.1.12)            â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Pod: coredns-xxx (10.0.1.13)                  â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚  Standard Load Balancer                            â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Frontend IP: 4.***.**.75 (LoadBalancer)       â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Outbound IP: 20.**.***.**2 (SNAT Pool)        â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Subnet: snet-mongo (10.0.2.0/24)                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚  VM: vm-mongo-dev (10.0.2.4)                       â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Public IP: 52.***.**.*** (SSHç”¨)              â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Port 22: SSH                                   â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Port 27017: MongoDB                            â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚·ãƒŠãƒªã‚ªåˆ¥é€šä¿¡ãƒ•ãƒ­ãƒ¼

#### ã‚·ãƒŠãƒªã‚ª 1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Web ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹

```text
[1] ãƒ–ãƒ©ã‚¦ã‚¶ (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ)
     â†“ HTTP GET http://4.***.**.75
     â”‚ é€ä¿¡å…ƒ: 203.0.113.100 (ãƒ¦ãƒ¼ã‚¶ãƒ¼IP)
     â”‚ å®›å…ˆ: 4.***.**.75:80

[2] Azure Load Balancer (Frontend IP)
     â†“ ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚° (ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³)
     â”‚ å®›å…ˆ: 10.0.1.10:3000 (Pod IP)

[3] AKS Node 1 (10.0.1.4)
     â†“ kube-proxy (iptables/IPVS)
     â”‚ DNAT: 10.0.1.10:3000

[4] Pod: guestbook-app-xxx (10.0.1.10)
     â†“ Node.js Express ã‚µãƒ¼ãƒãƒ¼ã§å‡¦ç†
     â”‚ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ

[5] å¿œç­”ãƒ‘ã‚±ãƒƒãƒˆ
     â†“ é€ä¿¡å…ƒ: 10.0.1.10:3000
     â”‚ å®›å…ˆ: 203.0.113.100

[6] Load Balancer
     â†“ SNAT (é€ä¿¡å…ƒã‚’ 4.***.**.75 ã«å¤‰æ›)
     â”‚ é€ä¿¡å…ƒ: 4.***.**.75:80

[7] ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹åˆ°é”
```

**ä½¿ç”¨ã•ã‚Œã‚‹ IP:**

- **ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰**: `4.***.**.75` (LoadBalancer Service IP)
- **ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰**: `4.***.**.75` (åŒã˜ IP ã§å¿œç­”)

---

#### ã‚·ãƒŠãƒªã‚ª 2: Pod ã‹ã‚‰ MongoDB ã¸ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹

```text
[1] Pod: guestbook-app-xxx (10.0.1.10)
     â†“ MongoDBæ¥ç¶š
     â”‚ é€ä¿¡å…ƒ: 10.0.1.10:xxxxx
     â”‚ å®›å…ˆ: 10.0.2.4:27017
     â”‚ ãƒ—ãƒ­ãƒˆã‚³ãƒ«: TCP (MongoDB Wire Protocol)

[2] VNetå†…éƒ¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (Azure SDN)
     â†“ ã‚µãƒ–ãƒãƒƒãƒˆé–“é€šä¿¡
     â”‚ snet-aks (10.0.1.0/24) â†’ snet-mongo (10.0.2.0/24)
     â”‚ â€» ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¯ä½¿ç”¨ã•ã‚Œãªã„

[3] NSG (vm-mongo-dev-nsg) ã§ãƒ«ãƒ¼ãƒ«è©•ä¾¡
     â†“ è¨±å¯ãƒ«ãƒ¼ãƒ«: Allow-MongoDB (Priority 110)
     â”‚ é€ä¿¡å…ƒ: 10.0.0.0/16 (VNetå…¨ä½“)
     â”‚ å®›å…ˆãƒãƒ¼ãƒˆ: 27017

[4] VM: vm-mongo-dev (10.0.2.4)
     â†“ MongoDB ãƒ—ãƒ­ã‚»ã‚¹ (mongod)
     â”‚ ãƒãƒ¼ãƒˆ 27017 ã§ãƒªãƒƒã‚¹ãƒ³

[5] MongoDB ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
     â†“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ
     â”‚ db.messages.find()

[6] å¿œç­”ãƒ‘ã‚±ãƒƒãƒˆ
     â†“ é€ä¿¡å…ƒ: 10.0.2.4:27017
     â”‚ å®›å…ˆ: 10.0.1.10:xxxxx

[7] Pod ã§ãƒ‡ãƒ¼ã‚¿å—ä¿¡
```

**ä½¿ç”¨ã•ã‚Œã‚‹ IP:**

- **é€šä¿¡çµŒè·¯**: VNet å†…éƒ¨ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã®ã¿
- **ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP**: ä½¿ç”¨ã•ã‚Œãªã„ (VNet å†…å®Œçµ)

**NSG ãƒ«ãƒ¼ãƒ«:**

```text
Priority 110: Allow-MongoDB
  Source: 10.0.0.0/16 (VNet)
  Destination: * (Any)
  Port: 27017
  Protocol: TCP
  Action: Allow
```

---

#### ã‚·ãƒŠãƒªã‚ª 3: Pod ã‹ã‚‰ ACR ã¸ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ pull

```text
[1] Kubelet (AKS Node: 10.0.1.4)
     â†“ ã‚¤ãƒ¡ãƒ¼ã‚¸pullè¦æ±‚
     â”‚ å®›å…ˆ: acrwizdev*.azurecr.io:443
     â”‚ DNSè§£æ±º: 52.***.***.*** (ACR Public IP)

[2] DNSè§£æ±º (Azure DNSçµŒç”±)
     â†“ ã‚¯ã‚¨ãƒª: acrwizdev*.azurecr.io
     â”‚ å¿œç­”: 52.***.***.***(ACR ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP)

[3] AKS Node ã‹ã‚‰ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡
     â†“ é€ä¿¡å…ƒ: 10.0.1.4 (Node IP)
     â”‚ å®›å…ˆ: 52.***.***.***:443

[4] Standard Load Balancer (SNAT)
     â†“ é€ä¿¡å…ƒNATã‚’å®Ÿè¡Œ
     â”‚ é€ä¿¡å…ƒ: 10.0.1.4 â†’ 20.**.***.**2 (Outbound IP)
     â”‚ å®›å…ˆ: 52.***.***.***:443

[5] ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§ACRåˆ°é”
     â†“ Azure BackboneçµŒç”±
     â”‚ HTTPS (TLS 1.2)

[6] ACR (Azure Container Registry)
     â†“ Managed Identityèªè¨¼
     â”‚ AKS Kubelet Identity: AcrPullæ¨©é™ç¢ºèª

[7] ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
     â†“ å¿œç­”ãƒ‘ã‚±ãƒƒãƒˆ
     â”‚ é€ä¿¡å…ƒ: 52.***.***.***:443
     â”‚ å®›å…ˆ: 20.**.***.**2

[8] Load Balancer (é€†NAT)
     â†“ å®›å…ˆã‚’å…ƒã«æˆ»ã™
     â”‚ å®›å…ˆ: 20.**.***.**2 â†’ 10.0.1.4

[9] AKS Node ã§ã‚¤ãƒ¡ãƒ¼ã‚¸å—ä¿¡
     â†“ containerd ã§ã‚¤ãƒ¡ãƒ¼ã‚¸å±•é–‹
     â”‚ /var/lib/containerd/
```

**ä½¿ç”¨ã•ã‚Œã‚‹ IP:**

- **ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰**: `20.**.***.**2` (SNAT çµŒç”±)
- **èªè¨¼**: Managed Identity (Kubelet Identity)

**é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«:**

- HTTPS (TLS 1.2) on port 443
- Docker Registry API v2

---

#### ã‚·ãƒŠãƒªã‚ª 4: VM ã‹ã‚‰ Storage Account ã¸ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```text
[1] VM: vm-mongo-dev (10.0.2.4)
     â†“ cron ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ (æ¯æ—¥ 2:00 AM JST)
     â”‚ /usr/local/bin/mongodb-backup.sh

[2] MongoDB ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
     â†“ mongodump ã‚³ãƒãƒ³ãƒ‰
     â”‚ å‡ºåŠ›: /tmp/backup-20251030.gz

[3] Azure CLI ãƒ­ã‚°ã‚¤ãƒ³ (Managed Identity)
     â†“ az login --identity
     â”‚ VM System Assigned Identityä½¿ç”¨

[4] Azure Storage Blob Upload
     â†“ az storage blob upload
     â”‚ é€ä¿¡å…ƒ: 10.0.2.4
     â”‚ å®›å…ˆ: stwizdev*.blob.core.windows.net:443

[5] VM ã‹ã‚‰ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡
     â†“ NSG ãƒ«ãƒ¼ãƒ«è©•ä¾¡
     â”‚ Outbound Rule: AllowAzureCloud (Default)

[6] Public IPçµŒç”±ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ
     â†“ NATå®Ÿè¡Œ
     â”‚ é€ä¿¡å…ƒ: 10.0.2.4 â†’ 52.***.**.*** (VM Public IP)
     â”‚ å®›å…ˆ: 20.***.***.***:443 (Storage Account)

[7] Azure Storage Account
     â†“ Azure ADèªè¨¼
     â”‚ VM Managed Identity: Storage Blob Data Contributor

[8] Blob Container (backups)
     â†“ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
     â”‚ backup-20251030.gz
     â”‚ ã‚µã‚¤ã‚º: 512 MB

[9] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¿œç­”
     â†“ HTTP 201 Created
     â”‚ é€ä¿¡å…ƒ: 20.***.***.***:443
     â”‚ å®›å…ˆ: 52.***.**.***(VM Public IP)

[10] VM ã§çµæœå—ä¿¡
      â†“ ãƒ­ã‚°è¨˜éŒ²
      â”‚ /var/log/mongodb-backup.log
```

**ä½¿ç”¨ã•ã‚Œã‚‹ IP:**

- **é€ä¿¡å…ƒ**: `52.***.**.**`(VM Public IP)
- **å®›å…ˆ**: Storage Account Public Endpoint
- **èªè¨¼**: VM System Assigned Managed Identity

**NSG ãƒ«ãƒ¼ãƒ«:**

```text
Default Outbound Rule: AllowAzureCloud
  Source: VirtualNetwork
  Destination: AzureCloud
  Port: 443
  Protocol: TCP
  Action: Allow (Default)
```

---

#### ã‚·ãƒŠãƒªã‚ª 5: GitHub Actions ã‹ã‚‰ AKS ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```text
[1] GitHub Actions Runner (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ)
     â†“ kubectl applyå®Ÿè¡Œ
     â”‚ é€ä¿¡å…ƒ: GitHub Runner IP
     â”‚ å®›å…ˆ: aks-wiz-dev API Server (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)

[2] AKS API Server (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼)
     â†“ HTTPS (TLS 1.2) on port 443
     â”‚ FQDN: aks-wiz-dev-xxx.hcp.japaneast.azmk8s.io

[3] Azure ADèªè¨¼
     â†“ Service Principalèªè¨¼
     â”‚ AZURE_CREDENTIALS (GitHub Secret)

[4] RBACæ¨©é™ç¢ºèª
     â†“ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
     â”‚ az aks get-credentials ã§å–å¾—ã—ãŸkubeconfig

[5] Kubernetes ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
     â†“ kubectl apply -f deployment.yaml
     â”‚ Deployment, Service, RBACä½œæˆ

[6] Kubelet ãŒã‚¤ãƒ¡ãƒ¼ã‚¸pull
     â†“ ACRã‹ã‚‰å–å¾— (ã‚·ãƒŠãƒªã‚ª3å‚ç…§)
     â”‚ ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰IP: 20.**.***.**2ä½¿ç”¨

[7] Pod èµ·å‹•
     â†“ ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œ
     â”‚ guestbook-app:latest

[8] Service Reconciliation
     â†“ LoadBalancer IPã‚’å‰²ã‚Šå½“ã¦
     â”‚ 4.***.**.75ã‚’æ—¢å­˜IPã‹ã‚‰å†åˆ©ç”¨
```

**ä½¿ç”¨ã•ã‚Œã‚‹ IP:**

- **API Server**: AKS ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **ã‚¤ãƒ¡ãƒ¼ã‚¸ pull**: `20.**.***.**2` (ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ IP)

**èªè¨¼ãƒ•ãƒ­ãƒ¼:**

```text
GitHub Actions
  â†“ AZURE_CREDENTIALS (Service Principal)
Azure AD
  â†“ ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ
AKS API Server
  â†“ RBACè©•ä¾¡
kubectl ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œè¨±å¯
```

---

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¢ƒç•Œ

#### ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ                                              â”‚
â”‚                                                              â”‚
â”‚  âœ… Port 80/443: LoadBalancer Service (4.***.**.75)          â”‚
â”‚  âœ… Port 443: AKS API Server (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼)          â”‚
â”‚  âš ï¸ Port 22: MongoDB VM SSH (52.***.**.**) [è„†å¼±æ€§]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Azure Virtual Network (10.0.0.0/16)                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  snet-aks (10.0.1.0/24)                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ NSG: aks-agentpool-nsg (è‡ªå‹•ä½œæˆ)               â”‚  â”‚
â”‚  â”‚  â”œâ”€ è¨±å¯: LoadBalancer Health Probe                 â”‚  â”‚
â”‚  â”‚  â””â”€ è¨±å¯: VNetå†…éƒ¨é€šä¿¡                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  snet-mongo (10.0.2.0/24)                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ NSG: vm-mongo-dev-nsg                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ âš ï¸ Allow SSH from Internet (Priority 100)       â”‚  â”‚
â”‚  â”‚  â””â”€ âœ… Allow MongoDB from VNet (Priority 110)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¨å¥¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„

```text
ã€ç¾åœ¨ã®è„†å¼±æ€§ã€‘
âš ï¸ MongoDB VM SSH: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå…¨ä½“ã«å…¬é–‹
âš ï¸ MongoDB: èªè¨¼ãªã— (ãƒ‡ãƒ¢ç”¨ã®æ„å›³çš„ãªè¨­å®š)
âš ï¸ Kubernetes RBAC: cluster-admin æ¨©é™ä»˜ä¸

ã€æ¨å¥¨æ”¹å–„ç­–ã€‘
1. SSH ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
   - ç‰¹å®šIPã®ã¿è¨±å¯
   - Azure Bastionä½¿ç”¨

2. MongoDBèªè¨¼æœ‰åŠ¹åŒ–
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
   - TLS/SSLæœ‰åŠ¹åŒ–

3. RBACæœ€å°æ¨©é™
   - namespaceå˜ä½ã®æ¨©é™
   - developer-role (view/edit ã®ã¿)

4. Network Policyé©ç”¨
   - Podé–“é€šä¿¡åˆ¶é™
   - Egressåˆ¶é™
```

---

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã®å®Ÿè£… (Bicep)

### VNet ã¨ã‚µãƒ–ãƒãƒƒãƒˆå®šç¾©

```bicep
// infra/modules/networking.bicep
resource vnet 'Microsoft.Network/virtualNetworks@2023-05-01' = {
  name: 'vnet-wiz-${environment}'
  location: location
  properties: {
    addressSpace: {
      addressPrefixes: [
        '10.0.0.0/16'  // VNetå…¨ä½“
      ]
    }
    subnets: [
      {
        name: 'snet-aks'
        properties: {
          addressPrefix: '10.0.1.0/24'  // AKSãƒãƒ¼ãƒ‰ç”¨
          privateEndpointNetworkPolicies: 'Disabled'
        }
      }
      {
        name: 'snet-mongo'
        properties: {
          addressPrefix: '10.0.2.0/24'  // MongoDB VMç”¨
        }
      }
    ]
  }
}
```

### AKS ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š

```bicep
// infra/modules/aks.bicep
resource aks 'Microsoft.ContainerService/managedClusters@2023-10-01' = {
  properties: {
    networkProfile: {
      networkPlugin: 'azure'           // Azure CNI
      serviceCidr: '10.1.0.0/16'       // Service IPç¯„å›²
      dnsServiceIP: '10.1.0.10'        // CoreDNS IP
      loadBalancerSku: 'standard'      // Standard LB
      outboundType: 'loadBalancer'     // ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰IPä½¿ç”¨
    }
  }
}
```

### NSG ãƒ«ãƒ¼ãƒ«å®šç¾©

```bicep
// infra/modules/vm-mongodb.bicep
resource nsg 'Microsoft.Network/networkSecurityGroups@2023-05-01' = {
  properties: {
    securityRules: [
      {
        name: 'Allow-SSH-Internet'
        properties: {
          priority: 100
          direction: 'Inbound'
          access: 'Allow'
          protocol: 'Tcp'
          sourcePortRange: '*'
          destinationPortRange: '22'
          sourceAddressPrefix: '*'      // âš ï¸ è„†å¼±æ€§: å…¨é–‹æ”¾
          destinationAddressPrefix: '*'
        }
      }
      {
        name: 'Allow-MongoDB'
        properties: {
          priority: 110
          direction: 'Inbound'
          access: 'Allow'
          protocol: 'Tcp'
          sourcePortRange: '*'
          destinationPortRange: '27017'
          sourceAddressPrefix: '10.0.0.0/16'  // VNetå†…ã®ã¿
          destinationAddressPrefix: '*'
        }
      }
    ]
  }
}
```

---

## â“ ã‚ˆãã‚ã‚‹è³ªå•

### Q1: ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ IP ã¯å‰Šé™¤ã§ãã¾ã™ã‹?

**A:** æŠ€è¡“çš„ã«ã¯å¯èƒ½ã§ã™ãŒã€ä»£æ›¿æ‰‹æ®µãŒå¿…è¦ã§ã™ã€‚

| æ–¹æ³•                  | è¨­å®š                                     | ã‚³ã‚¹ãƒˆ       |
| --------------------- | ---------------------------------------- | ------------ |
| **ç¾åœ¨ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)** | `outboundType: 'loadBalancer'`           | **~$4/æœˆ**   |
| **NAT Gateway**       | `outboundType: 'userAssignedNATGateway'` | **~$35/æœˆ**  |
| **Azure Firewall**    | `outboundType: 'userDefinedRouting'`     | **~$700/æœˆ** |

**æ¨å¥¨**: ç¾åœ¨ã®æ§‹æˆã‚’ç¶­æŒ (ã‚·ãƒ³ãƒ—ãƒ«&ä½ã‚³ã‚¹ãƒˆ)

### Q2: LoadBalancer IP ã¯å›ºå®šã§ãã¾ã™ã‹?

**A:** ã¯ã„ã€é™çš„ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚’äº‹å‰ä½œæˆã—ã¦å‰²ã‚Šå½“ã¦å¯èƒ½ã§ã™ã€‚

```yaml
# äº‹å‰ã«ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPä½œæˆ
az network public-ip create \
  --resource-group MC_* \
  --name static-lb-ip \
  --sku Standard \
  --allocation-method Static

# Serviceã«æŒ‡å®š
apiVersion: v1
kind: Service
metadata:
  name: guestbook-service
spec:
  type: LoadBalancer
  loadBalancerIP: 4.***.**.75  # å›ºå®šIPæŒ‡å®š
```

### Q3: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ã™ã‚‹ã¨ã©ã†ãªã‚Šã¾ã™ã‹?

**A:** API ã‚µãƒ¼ãƒãƒ¼ã¯éå…¬é–‹ã«ãªã‚Šã¾ã™ãŒã€ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ IP ã¯å¿…è¦ã§ã™ã€‚

```bicep
apiServerAccessProfile: {
  enablePrivateCluster: true  // APIã‚µãƒ¼ãƒãƒ¼ã‚’éå…¬é–‹
}
networkProfile: {
  outboundType: 'loadBalancer'  // ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰IPã¯å¿…è¦
}
```

- âœ… API ã‚µãƒ¼ãƒãƒ¼: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±
- âœ… LoadBalancer Service: å¼•ãç¶šãå…¬é–‹å¯èƒ½
- âœ… ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡: `20.**.***.**2` ã‚’ä½¿ç”¨

---

## ğŸ’° ã‚³ã‚¹ãƒˆæƒ…å ±

### ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP é–¢é€£ã®ã‚³ã‚¹ãƒˆ

| é …ç›®                           | ä¾¡æ ¼ (Japan East)                     |
| ------------------------------ | ------------------------------------- |
| **Standard SKU ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP** | **$3.65/æœˆ** (å„)                     |
| **ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿è»¢é€**   | æœ€åˆã® 5GB: ç„¡æ–™<br>5GB è¶…: $0.087/GB |
| **Load Balancer**              | ç„¡æ–™ (Standard SKU å†…)                |

**ä»Šå›ã®æ§‹æˆã®æœˆé¡ã‚³ã‚¹ãƒˆ:**

- ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP Ã— 2 = **$7.30/æœˆ**
- ãƒ‡ãƒ¼ã‚¿è»¢é€ (æƒ³å®š 5GB ä»¥å†…) = **$0/æœˆ**
- **åˆè¨ˆ: ç´„ $7-8/æœˆ**

### ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®è€ƒæ…®ç‚¹

- âœ… **ç¾åœ¨ã®æ§‹æˆãŒæœ€é©** (ä½ã‚³ã‚¹ãƒˆ&ã‚·ãƒ³ãƒ—ãƒ«)
- âš ï¸ NAT Gateway ã¸ã®ç§»è¡Œã¯ã‚³ã‚¹ãƒˆå¢— (+$30/æœˆ)
- âš ï¸ Azure Firewall ã¯é«˜ã‚³ã‚¹ãƒˆ (+$690/æœˆ)

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ IP ã®åˆ¶å¾¡

```powershell
# NSGã§ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰åˆ¶å¾¡
az network nsg rule create \
  --resource-group rg-cicd-aks-bbs \
  --nsg-name aks-nsg \
  --name allow-acr-only \
  --priority 100 \
  --destination-address-prefixes AzureContainerRegistry \
  --destination-port-ranges 443 \
  --access Allow
```

### LoadBalancer IP ã®ä¿è­·

```yaml
# Serviceã«ã‚½ãƒ¼ã‚¹åˆ¶é™ã‚’è¿½åŠ 
apiVersion: v1
kind: Service
metadata:
  name: guestbook-service
spec:
  type: LoadBalancer
  loadBalancerSourceRanges: # ã‚¢ã‚¯ã‚»ã‚¹å…ƒIPåˆ¶é™
    - 203.0.113.0/24 # ç‰¹å®šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿è¨±å¯
```

---

## ğŸ“Š ç›£è¦–ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã®ä½¿ç”¨çŠ¶æ³ç¢ºèª

```powershell
# ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPè©³ç´°æƒ…å ±
az network public-ip show \
  --resource-group MC_rg-cicd-aks-bbs_aks-wiz-dev_japaneast \
  --name b6575400-f57a-4724-a7fc-b74529fc4c79 \
  --query "{IP:ipAddress, Status:provisioningState, Allocation:publicIPAllocationMethod}"

# LoadBalancerã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ—ãƒ¼ãƒ«ç¢ºèª
az network lb show \
  --resource-group MC_rg-cicd-aks-bbs_aks-wiz-dev_japaneast \
  --name kubernetes \
  --query "backendAddressPools[].backendIPConfigurations[].id"
```

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### å•é¡Œ 1: LoadBalancer IP ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œãªã„

```powershell
# Serviceã‚¤ãƒ™ãƒ³ãƒˆç¢ºèª
kubectl describe svc guestbook-service

# ã‚ˆãã‚ã‚‹åŸå› :
# - ã‚¯ã‚©ãƒ¼ã‚¿è¶…é
# - NSGãƒ«ãƒ¼ãƒ«ã§ãƒ–ãƒ­ãƒƒã‚¯
# - Load Balancerã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—
```

**è§£æ±ºç­–:**

```powershell
# ã‚¯ã‚©ãƒ¼ã‚¿ç¢ºèª
az network public-ip list --query "length([])"

# NSGãƒ«ãƒ¼ãƒ«ç¢ºèª
az network nsg rule list --resource-group MC_* --nsg-name aks-*-nsg
```

#### å•é¡Œ 2: ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ãŒå¤±æ•—ã™ã‚‹

```powershell
# Podå†…ã‹ã‚‰ç–é€šç¢ºèª
kubectl run debug --image=nicolaka/netshoot --rm -it --restart=Never -- /bin/bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§: curl -v https://acr*.azurecr.io
```

**ã‚ˆãã‚ã‚‹åŸå› :**

- NSG ã§ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹
- Azure Policy é•å
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼ã®èª¤è¨­å®š

---

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. **IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–**

```markdown
# docs/NETWORK_INFO.md

## ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€è¦§

- **ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ IP**: 20.**.\***.\*\*2
  - ç”¨é€”: ACR pull, å¤–éƒ¨ API é€šä¿¡
- **LoadBalancer IP**: 4.**\*.**.75
  - ç”¨é€”: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¬é–‹ (http://4.***.**.75)
```

### 2. **DNS åã®è¨­å®š**

```powershell
# LoadBalancer IPã«DNSåã‚’è¨­å®š
az network public-ip update \
  --resource-group MC_* \
  --name kubernetes-* \
  --dns-name guestbook-app-demo

# ã‚¢ã‚¯ã‚»ã‚¹: http://guestbook-app-demo.japaneast.cloudapp.azure.com
```

### 3. **ã‚¿ã‚°ä»˜ã‘ã«ã‚ˆã‚‹ç®¡ç†**

```powershell
# ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã«ã‚¿ã‚°è¿½åŠ 
az network public-ip update \
  --resource-group MC_* \
  --name b6575400-* \
  --set tags.Purpose=AKS-Outbound tags.Environment=Dev
```

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `infra/modules/aks.bicep` - AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å®šç¾©
- `infra/modules/networking.bicep` - VNet/Subnet å®šç¾©
- `app/k8s/service.yaml` - LoadBalancer Service å®šç¾©

---

## ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯

- [AKS outbound network rules](https://learn.microsoft.com/azure/aks/limit-egress-traffic)
- [Use a Standard Load Balancer in AKS](https://learn.microsoft.com/azure/aks/load-balancer-standard)
- [AKS network concepts](https://learn.microsoft.com/azure/aks/concepts-network)
- [Azure Load Balancer pricing](https://azure.microsoft.com/pricing/details/load-balancer/)

---

## âœ… ã¾ã¨ã‚

| é …ç›®                  | å†…å®¹                                             |
| --------------------- | ------------------------------------------------ |
| **ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ IP** | `20.**.***.**2` - AKS ã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ã®é€šä¿¡ |
| **LoadBalancer IP**   | `4.***.**.75` - å¤–éƒ¨ã‹ã‚‰ AKS ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹        |
| **å¿…è¦æ€§**            | âœ… ä¸¡æ–¹ã¨ã‚‚å¿…é ˆ (ç¾åœ¨ã®æ§‹æˆã§ã¯å‰Šé™¤ä¸å¯)         |
| **ã‚³ã‚¹ãƒˆ**            | ç´„ $7-8/æœˆ (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP Ã— 2)                   |
| **æ¨å¥¨**              | ğŸ¯ ç¾åœ¨ã®æ§‹æˆã‚’ç¶­æŒ (ã‚·ãƒ³ãƒ—ãƒ«&ä½ã‚³ã‚¹ãƒˆ)          |

---

**ä½œæˆè€…**: aktsmm  
**æœ€çµ‚æ›´æ–°**: 2025 å¹´ 10 æœˆ 30 æ—¥
