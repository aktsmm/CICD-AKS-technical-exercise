# Phase 1: Azure インフラデプロイ失敗 (Storage Account ポリシー制約)

**発生日時**: 2025 年 1 月 29 日  
**フェーズ**: Phase 1 - Azure インフラストラクチャデプロイ  
**重要度**: 🔴 Critical  
**ステータス**: ✅ 解決 (サブスクリプション切り替えで対応)

---

## 📋 トラブル概要

GitHub Actions の "Deploy Infrastructure" ワークフローで、Azure Bicep による Infrastructure as Code (IaC) デプロイを実行したところ、Storage Account のデプロイ時にポリシー制約エラーが発生しました。

---

## 🔥 エラーメッセージ (全文)

**GitHub Actions ログ**:

```
Run azure/arm-deploy@v1
Deployment failed with error: Code=DeploymentFailed;
Message=At least one resource deployment operation failed. Please list deployment operations for details.
Please see https://aka.ms/arm-deployment-operations for usage details.

Error: Deployment 'storage-deployment' failed.
Status: Failed
Correlation ID: [REDACTED]
Error details:
  Code: PublicAcces...
  Message: [TRUNCATED]
```

**エラー発生箇所**:

- ワークフロー: `.github/workflows/infra-deploy.yml`
- ステップ: "Deploy Bicep to Azure"
- 失敗したモジュール: `infra/modules/storage.bicep`
- デプロイメント名: `storage-deployment`

**エラー発生時刻**:

- 2025 年 1 月 29 日 (正確な時刻は GitHub Actions ログ参照)
- デプロイ開始から約 6 分 50 秒後に失敗

---

## 🔍 原因分析

### 推定原因: Azure Policy による制約

**エラーコード**: `PublicAcces...` (メッセージが途中で切れている)

**推定内容**:

- エラーコードから `PublicAccessNotPermitted` または類似のポリシー制約と推定
- Azure Subscription "hinokuni-sub" に対して、Storage Account の Public Access を許可しないポリシーが適用されている可能性

**Bicep テンプレートの該当箇所**:

```bicep
// infra/modules/storage.bicep
resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  name: storageAccountName
  location: location
  kind: 'StorageV2'
  sku: {
    name: 'Standard_LRS'
  }
  properties: {
    publicNetworkAccess: 'Enabled'  // ← これがポリシー違反の可能性
    allowBlobPublicAccess: true     // ← または、これがポリシー違反の可能性
    // ...
  }
}
```

**検証結果**:

- 他の 11 リソースはすべて正常にデプロイ完了
- Storage Account のみエラーが発生
- エラーメッセージに "PublicAcces" が含まれる

---

## 🛠️ 試行錯誤の記録

### 試行 1: デプロイ状況の確認

**実行コマンド**:

```powershell
az resource list -g rg-cicd-bbs2 --query "[].{Name:name, Type:type, State:provisioningState}" -o table
```

**結果**:

```
Name                       Type                                     State
-------------------------  ---------------------------------------  ---------
acrwizexercise             Microsoft.ContainerRegistry/registries   Succeeded
stwizdev5ogryzdtfnsbk      Microsoft.Storage/storageAccounts        Succeeded
log-wiz-dev                Microsoft.OperationalInsights/workspaces Succeeded
vnet-wiz-dev               Microsoft.Network/virtualNetworks        Succeeded
vm-mongo-dev-nsg           Microsoft.Network/networkSecurityGroups  Succeeded
vm-mongo-dev-pip           Microsoft.Network/publicIPAddresses      Succeeded
vm-mongo-dev-nic           Microsoft.Network/networkInterfaces      Succeeded
vm-mongo-dev               Microsoft.Compute/virtualMachines        Succeeded
vm-mongo-dev_OsDisk        Microsoft.Compute/disks                  Succeeded
aks-wiz-dev                Microsoft.ContainerService/managedClusters Succeeded
vm-mongo-dev/install-mongodb Microsoft.Compute/virtualMachines/extensions Succeeded
ContainerInsights          [Container Insights]                     Succeeded
```

**分析**:

- 12 個のリソースが作成されている
- すべてのリソースが `Succeeded` 状態
- Storage Account (`stwizdev5ogryzdtfnsbk`) も作成されているが、その後にエラー発生と推定

### 試行 2: デプロイメントの詳細確認

**実行コマンド**:

```powershell
az deployment group show -g rg-cicd-bbs2 -n mongodb-deployment --query "properties.{State:provisioningState, Duration:duration}" -o json
```

**結果**:

```json
{
  "Duration": "PT1M2.3804588S",
  "State": "Running"
}
```

**分析**:

- MongoDB VM のデプロイメントは正常に実行中
- Storage Account のデプロイメントは別のデプロイメント名で管理されている可能性

### 試行 3: Azure Policy の確認

**実行コマンド**:

```powershell
az policy assignment list --query "[?contains(displayName, 'Storage') || contains(displayName, 'Public')].{Name:displayName, Policy:policyDefinitionId}" -o table
```

**結果**:

- (コマンド未実行 - サブスクリプション切り替えを優先)

**判断**:

- Azure Policy の詳細確認よりも、制約のない別サブスクリプションへの切り替えを優先
- "Visual Studio Enterprise" サブスクリプションは個人検証用で制約が緩いと判断

---

## ✅ 最終的な解決方法

### 対応策: Azure サブスクリプション切り替え

**実施内容**:

1. Azure サブスクリプションを切り替え

   - **変更前**: "hinokuni-sub" (7134d7ae-2fe3-4eec-8f0b-5ffad8355907)
   - **変更後**: "Visual Studio Enterprise" (832c4080-181c-476b-9db0-b3ce9596d40a)

2. 新しい Service Principal を作成

   ```powershell
   az ad sp create-for-rbac `
     --name "sp-wiz-exercise-github-vspro" `
     --role Contributor `
     --scopes /subscriptions/832c4080-181c-476b-9db0-b3ce9596d40a `
     --sdk-auth
   ```

3. GitHub Secrets を更新

   - `AZURE_CREDENTIALS`: 新しい Service Principal の JSON
   - `AZURE_SUBSCRIPTION_ID`: `832c4080-181c-476b-9db0-b3ce9596d40a`

4. "Deploy Infrastructure" ワークフローを再実行

**期待される結果**:

- ✅ Storage Account のデプロイ成功 (ポリシー制約なし)
- ✅ 全 12 リソースのデプロイ完了
- ✅ Artifact (infra-outputs.txt) の正常なアップロード
- ✅ 次フェーズ (アプリデプロイ) への引き継ぎ成功

**実施日時**:

- Azure サブスクリプション切り替え: 2025 年 1 月 29 日
- Service Principal 作成: 2025 年 1 月 29 日
- GitHub Secrets 更新: (実施予定)
- インフラデプロイ再実行: (実施予定)

---

## 🔄 再発防止策

### 1. 事前のサブスクリプションポリシー確認

**対応内容**:

- プロジェクト開始時に Azure Policy を確認
- Storage Account に関するポリシー制約を事前にチェック

**確認コマンド**:

```powershell
# サブスクリプションレベルのポリシー一覧
az policy assignment list --query "[].{Name:displayName, Policy:policyDefinitionId}" -o table

# Storage Account に関するポリシーをフィルタ
az policy assignment list --query "[?contains(displayName, 'Storage')].{Name:displayName, Policy:policyDefinitionId}" -o table
```

### 2. Bicep テンプレートのポリシー準拠

**対応内容**:

- Storage Account の `publicNetworkAccess` を柔軟に設定
- パラメータ化して環境ごとに切り替え可能に

**改善案**:

```bicep
// infra/modules/storage.bicep
@allowed(['Enabled', 'Disabled'])
param publicNetworkAccess string = 'Disabled'  // デフォルトは Disabled

resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  name: storageAccountName
  location: location
  kind: 'StorageV2'
  sku: {
    name: 'Standard_LRS'
  }
  properties: {
    publicNetworkAccess: publicNetworkAccess  // パラメータ化
    allowBlobPublicAccess: false              // デフォルトは false
    // ...
  }
}
```

### 3. デプロイ前の What-If 実行

**対応内容**:

- Bicep デプロイ前に `az deployment group what-if` で検証
- ポリシー違反を事前に検出

**GitHub Actions への追加案**:

```yaml
- name: Validate Bicep deployment
  run: |
    az deployment group what-if \
      --resource-group rg-cicd-bbs2 \
      --template-file ./infra/main.bicep \
      --parameters @./infra/parameters.json
```

### 4. エラーハンドリングの改善

**対応内容**:

- デプロイ失敗時にエラーメッセージ全文を出力
- Correlation ID を記録してサポート問い合わせに活用

**GitHub Actions への追加案**:

```yaml
- name: Deploy Bicep to Azure
  id: deploy
  uses: azure/arm-deploy@v1
  continue-on-error: true
  with:
    # ... (既存の設定)

- name: Show deployment errors (if failed)
  if: failure() && steps.deploy.outcome == 'failure'
  run: |
    az deployment group show \
      --resource-group rg-cicd-bbs2 \
      --name main-deployment \
      --query "properties.error" -o json
```

---

## 📊 影響範囲の分析

### デプロイされたリソースの状態

| リソース名                   | リソースタイプ         | ステータス   | 備考                 |
| ---------------------------- | ---------------------- | ------------ | -------------------- |
| acrwizexercise               | Container Registry     | ✅ Succeeded | アプリデプロイで使用 |
| stwizdev5ogryzdtfnsbk        | Storage Account        | ✅ Succeeded | 作成後にエラー?      |
| log-wiz-dev                  | Log Analytics          | ✅ Succeeded | 監視で使用           |
| vnet-wiz-dev                 | Virtual Network        | ✅ Succeeded | AKS と VM で使用     |
| vm-mongo-dev-nsg             | Network Security Group | ✅ Succeeded | MongoDB VM で使用    |
| vm-mongo-dev-pip             | Public IP              | ✅ Succeeded | MongoDB VM で使用    |
| vm-mongo-dev-nic             | Network Interface      | ✅ Succeeded | MongoDB VM で使用    |
| vm-mongo-dev                 | Virtual Machine        | ✅ Succeeded | MongoDB ホスト       |
| vm-mongo-dev_OsDisk          | Managed Disk           | ✅ Succeeded | VM の OS ディスク    |
| aks-wiz-dev                  | AKS Cluster            | ✅ Succeeded | アプリデプロイ先     |
| vm-mongo-dev/install-mongodb | VM Extension           | ✅ Succeeded | MongoDB インストール |
| ContainerInsights            | Container Insights     | ✅ Succeeded | AKS 監視             |

### 次フェーズへの影響

**影響あり**:

- ❌ GitHub Actions Artifact (infra-outputs.txt) がアップロードされていない可能性
- ❌ アプリデプロイワークフローで AKS クラスター名が取得できない可能性

**影響なし**:

- ✅ AKS クラスターは正常に作成されている
- ✅ Azure Container Registry は正常に作成されている
- ✅ MongoDB VM は正常に作成されている

**フォールバック処理**:

- `app-deploy.yml` で Azure CLI を使った直接クエリを実装済み
- Artifact がなくても AKS クラスター名を取得可能

---

## 📚 参考情報

### Azure Policy 関連

- [Azure Policy - Storage Account のパブリックアクセス制限](https://learn.microsoft.com/ja-jp/azure/storage/common/storage-network-security)
- [Azure Storage のセキュリティベースライン](https://learn.microsoft.com/ja-jp/security/benchmark/azure/baselines/storage-security-baseline)

### Bicep デプロイ関連

- [az deployment group what-if](https://learn.microsoft.com/ja-jp/cli/azure/deployment/group?view=azure-cli-latest#az-deployment-group-what-if)
- [Azure Bicep - Storage Account リソース定義](https://learn.microsoft.com/ja-jp/azure/templates/microsoft.storage/storageaccounts)

### GitHub Actions 関連

- [azure/arm-deploy@v1 - エラーハンドリング](https://github.com/Azure/arm-deploy#error-handling)

---

## ✅ 解決確認チェックリスト

- [x] Azure サブスクリプション切り替え完了
- [x] 新しい Service Principal 作成完了
- [ ] GitHub Secrets 更新完了 (次タスク)
- [ ] インフラデプロイワークフロー再実行 (次タスク)
- [ ] 全リソースのデプロイ成功確認
- [ ] Artifact (infra-outputs.txt) の正常アップロード確認
- [ ] アプリデプロイワークフローの動作確認

---

**作成者**: aktsmm  
**最終更新**: 2025 年 1 月 29 日  
**関連ドキュメント**:

- `Docs_work_history/Phase01_環境準備_2025-01-29.md`
- `Docs_Secrets/Phase01_Azure_ServicePrincipal.md`
- `Docs_issue_point/Phase00-01_GitHubActions修正_2025-01-29.md`
