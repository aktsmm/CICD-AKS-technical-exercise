# Phase 13: ワークフロートリガー競合解決

**日付**: 2025 年 10 月 30 日  
**カテゴリ**: GitHub Actions / CI/CD パイプライン

---

## 🔴 問題

### エラー内容

```
Build and Deploy Application
Update resource group name from 'rg-cicd-aks-bbs-01' to 'rg-cicd-aks-bbs-01… #56

Build and Push to ACR - failed 2 minutes ago in 35s

❌ Resource group rg-cicd-aks-bbs-01 not found!
Infrastructure deployment may not have completed yet.
Error: Process completed with exit code 1.
```

### 根本原因

両方のワークフローに `paths: ["./**"]` が設定されており、どのファイルを変更しても**両方のワークフローが同時に起動**してしまう。

#### 修正前の設定

```yaml
# infra-deploy.yml
on:
  push:
    paths:
      - "./**"          # ← すべてのファイル
      - "infra/**"

# app-deploy.yml
on:
  push:
    paths:
      - "./**"          # ← すべてのファイル
      - "app/**"
  workflow_run:
    workflows: ["Deploy Infrastructure"]
    types: [completed]
```

### 問題のシナリオ

```
infra/とapp/を同時にコミット
  ↓
時刻 00:00 → infra-deploy.yml 開始
時刻 00:00 → app-deploy.yml 開始 (pushトリガー)
           ↓ ❌ エラー! リソースグループがまだ存在しない

時刻 00:10 → infra-deploy.yml 完了
時刻 00:10 → app-deploy.yml 開始 (workflow_runトリガー)
           ↓ ✅ 成功
```

→ **1 回目は失敗、2 回目は成功** (無駄な実行 + エラーログ)

---

## ✅ 解決策

### `"./**"` を両方のワークフローから削除

```yaml
# infra-deploy.yml
on:
  push:
    branches:
      - main
    paths:
      - "infra/**"                              # インフラコードのみ
      - ".github/workflows/infra-deploy.yml"    # 自ワークフロー
  workflow_dispatch:

# app-deploy.yml
on:
  push:
    branches:
      - main
    paths:
      - "app/**"                                # アプリコードのみ
      - ".github/workflows/app-deploy.yml"      # 自ワークフロー
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy Infrastructure"]        # インフラ完了後に自動実行
    types: [completed]
    branches: [main]
```

---

## 📊 修正後の動作保証

| 変更内容                 | 実行されるワークフロー | 順序性              | 結果                               |
| ------------------------ | ---------------------- | ------------------- | ---------------------------------- |
| `infra/**` のみ          | infra → app (自動)     | ✅ 保証             | インフラ完了後にアプリ自動デプロイ |
| `app/**` のみ            | app のみ               | ✅ 既存インフラ利用 | アプリのみ更新                     |
| `infra/**` + `app/**`    | infra → app (自動)     | ✅ 保証             | 1 回のみ実行、確実に成功           |
| `docs/**` や `README.md` | なし                   | ✅ 無駄な実行なし   | ワークフロー起動なし               |
| 手動実行                 | 選択したもの           | ✅ ユーザー制御     | workflow_dispatch                  |

---

## 🛡️ 既存の安全策との組み合わせ

各ジョブには既に以下の条件が実装済み:

```yaml
if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
```

→ **インフラデプロイが失敗した場合、アプリデプロイはスキップされる**

---

## 🎯 学んだこと

### 1. **paths フィルターの粒度が重要**

- `"./**"` は便利だが、ワークフロー間の依存関係がある場合は危険
- 明確な責任分離のため、各ワークフローは担当ディレクトリのみを監視すべき

### 2. **workflow_run だけでは不十分**

- `workflow_run` は順序性を保証するが、`push`トリガーが先に起動する場合は防げない
- トリガー条件の設計が重要

### 3. **GitHub Actions のトリガー優先順位**

- 複数のトリガー条件が同時に満たされた場合、すべてが独立して実行される
- `workflow_run` は別ワークフローの完了を**待つ**のではなく、**完了をトリガーとして新たに起動**する

---

## 📝 ベストプラクティス

### CI/CD パイプラインの依存関係設計

```yaml
# ✅ 良い例: 明確な責任分離
infra-deploy:
  paths: ["infra/**"]

app-deploy:
  paths: ["app/**"]
  workflow_run:
    workflows: ["infra-deploy"]

# ❌ 悪い例: 曖昧な監視範囲
infra-deploy:
  paths: ["./**", "infra/**"]  # 重複が問題を引き起こす

app-deploy:
  paths: ["./**", "app/**"]    # すべて監視すると競合する
```

### ワークフロー設計の原則

1. **Single Responsibility**: 各ワークフローは 1 つの責任を持つ
2. **Explicit Dependencies**: 依存関係は明示的に定義する
3. **Minimal Triggers**: 必要最小限のトリガー条件のみ設定する

---

## 🔗 関連ファイル

- `.github/workflows/infra-deploy.yml`
- `.github/workflows/app-deploy.yml`

## 🔗 関連 Phase

- Phase06: ワークフロー依存関係実装
- Phase08: AKS プロビジョニング待機実装

---

## ✅ 検証結果

修正後、以下のシナリオで正常動作を確認:

- [x] インフラコードのみ変更 → インフラデプロイ → アプリ自動デプロイ
- [x] アプリコードのみ変更 → アプリデプロイのみ
- [x] 両方同時変更 → インフラデプロイ → アプリ自動デプロイ (1 回のみ)
- [x] ドキュメント変更 → ワークフロー起動なし
