# Phase 05: プライベートクラスター要件解釈と実装判断

**作成日**: 2025-10-29  
**ステータス**: ✅ 解決済み  
**カテゴリ**: アーキテクチャ設計・要件解釈

---

## 📋 要件の原文

> **Kubernetes 上の Web アプリケーション**
>
> - Kubernetes クラスタは**プライベートサブネット**に配置
> - Ingress + CSP（Cloud Service Provider）のロードバランサで公開
> - kubectl コマンドによる操作をデモ可能にすること

---

## 🤔 疑問点

**「プライベートサブネット」** = **「AKS プライベートクラスター」** なのか？

### Azure AKS における 2 つの概念

| 概念                       | 意味                                         | 実装方法                        | 外部アクセス            |
| -------------------------- | -------------------------------------------- | ------------------------------- | ----------------------- |
| **プライベートサブネット** | ノードが VNet 内のプライベート IP 空間に配置 | `vnetSubnetID` でサブネット指定 | LoadBalancer 経由で可能 |
| **プライベートクラスター** | API サーバーがプライベート IP のみ           | `enablePrivateCluster: true`    | Jump Server 経由のみ    |

---

## 🔍 要件分析

### 要件が求めているもの

1. ✅ **Kubernetes クラスタがプライベートサブネットに配置**

   - ノードが VNet 内のプライベート IP アドレスを持つ
   - インターネットゲートウェイへの直接ルートがない
   - **これは「ノードの配置場所」の話**

2. ✅ **Ingress + LoadBalancer で外部公開**

   - アプリケーションへの外部アクセスを許可
   - **パブリック LoadBalancer が必要**

3. ✅ **kubectl コマンドで操作可能**
   - GitHub Actions からのデプロイ
   - ローカル開発環境からの操作
   - **API サーバーへのアクセスが必要**

### プライベートクラスターにすると発生する問題

❌ **GitHub Actions から kubectl 実行不可**

```
error: dial tcp: lookup aksdev-xxx.privatelink.japaneast.azmk8s.io
on 127.0.0.53:53: no such host
```

❌ **デプロイパイプラインが複雑化**

- Self-hosted runner が必要
- または VPN/ExpressRoute 接続
- Jump Server 経由の kubectl 実行

---

## ✅ 採用した実装

### ネットワーク構成

```
インターネット
    ↓
[Azure Load Balancer (Public IP)]
    ↓
┌─────────────── VNet: 10.0.0.0/16 ───────────────┐
│                                                  │
│  ┌─── snet-aks: 10.0.1.0/24 (Private) ───┐    │
│  │  • AKS ノードプール                     │    │
│  │  • Pod (10.244.x.x)                    │    │
│  │  • LoadBalancer Service → 外部公開     │    │
│  └──────────────────────────────────────┘     │
│                                                  │
│  ┌─── snet-mongo: 10.0.2.0/24 (Private) ─┐    │
│  │  • MongoDB VM (10.0.2.4)                │    │
│  │  • AKS からのみアクセス可能              │    │
│  └──────────────────────────────────────┘     │
│                                                  │
└──────────────────────────────────────────────┘

AKS API サーバー (パブリック FQDN)
    ↑
kubectl / GitHub Actions
```

### Bicep 実装

**`infra/modules/aks.bicep`**

```bicep
resource aks 'Microsoft.ContainerService/managedClusters@2023-10-01' = {
  name: clusterName
  location: location
  properties: {
    dnsPrefix: clusterName

    // ✅ パブリッククラスター: GitHub Actions からデプロイ可能
    apiServerAccessProfile: {
      enablePrivateCluster: false
    }

    // ✅ プライベートサブネットに配置
    agentPoolProfiles: [
      {
        name: 'nodepool1'
        count: 2
        vmSize: 'Standard_DS2_v2'
        osType: 'Linux'
        mode: 'System'
        vnetSubnetID: subnetId  // ← 10.0.1.0/24 に配置
      }
    ]

    networkProfile: {
      networkPlugin: 'azure'
      serviceCidr: '10.1.0.0/16'
      dnsServiceIP: '10.1.0.10'
      loadBalancerSku: 'standard'
      // ✅ LoadBalancer で外部公開
      outboundType: 'loadBalancer'
    }
  }
}
```

**`infra/modules/networking.bicep`**

```bicep
resource vnet 'Microsoft.Network/virtualNetworks@2023-05-01' = {
  name: 'vnet${environment}'
  location: location
  properties: {
    addressSpace: {
      addressPrefixes: ['10.0.0.0/16']
    }
    subnets: [
      {
        name: 'snet-aks'  // ← プライベートサブネット
        properties: {
          addressPrefix: '10.0.1.0/24'
          privateEndpointNetworkPolicies: 'Disabled'
        }
      }
      {
        name: 'snet-mongo'  // ← プライベートサブネット
        properties: {
          addressPrefix: '10.0.2.0/24'
        }
      }
    ]
  }
}
```

---

## 📊 要件適合性の検証

| 要件                                              | 実装                           | 状態 |
| ------------------------------------------------- | ------------------------------ | ---- |
| Kubernetes クラスタはプライベートサブネットに配置 | `vnetSubnetID: 10.0.1.0/24`    | ✅   |
| Ingress + LoadBalancer で公開                     | `outboundType: 'loadBalancer'` | ✅   |
| kubectl コマンドで操作可能                        | API サーバーがパブリック       | ✅   |
| MongoDB はプライベートサブネット                  | `10.0.2.0/24`                  | ✅   |
| MongoDB への接続は VNet 内のみ                    | NSG で制限                     | ✅   |

---

## 🎓 結論

### 「プライベートサブネット」≠「プライベートクラスター」

- **プライベートサブネット**: ノードの配置場所（ネットワーク層）
- **プライベートクラスター**: API サーバーのアクセス制御（コントロールプレーン層）

### 採用した設計判断

✅ **ノードはプライベートサブネット** (`vnetSubnetID` で指定)  
✅ **API サーバーはパブリック** (`enablePrivateCluster: false`)  
✅ **アプリは LoadBalancer で公開** (要件通り)

この構成により:

- 要件の「プライベートサブネット配置」を満たす
- GitHub Actions からの CI/CD が可能
- kubectl での操作デモが可能
- 不要な複雑性を回避

---

## 📚 参考資料

- [Azure AKS プライベートクラスター](https://learn.microsoft.com/ja-jp/azure/aks/private-clusters)
- [Azure Virtual Network サブネット](https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-manage-subnet)
- [AKS ネットワーク概念](https://learn.microsoft.com/ja-jp/azure/aks/concepts-network)

---

## 🔄 変更履歴

| 日時       | 変更内容                                                             |
| ---------- | -------------------------------------------------------------------- |
| 2025-10-29 | 初期作成: プライベートクラスター vs プライベートサブネットの要件解釈 |
| 2025-10-29 | 実装判断: `enablePrivateCluster: false` に変更してデプロイ可能に     |
