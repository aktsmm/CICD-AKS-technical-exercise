# Phase 05: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è¦ä»¶è§£é‡ˆã¨å®Ÿè£…åˆ¤æ–­

**ä½œæˆæ—¥**: 2025-10-29  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… è§£æ±ºæ¸ˆã¿  
**ã‚«ãƒ†ã‚´ãƒª**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆãƒ»è¦ä»¶è§£é‡ˆ

---

## ğŸ“‹ è¦ä»¶ã®åŸæ–‡

> **Kubernetes ä¸Šã® Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**
>
> - Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã¯**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ**ã«é…ç½®
> - Ingress + CSPï¼ˆCloud Service Providerï¼‰ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã§å…¬é–‹
> - kubectl ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹æ“ä½œã‚’ãƒ‡ãƒ¢å¯èƒ½ã«ã™ã‚‹ã“ã¨

---

## ğŸ¤” ç–‘å•ç‚¹

**ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã€** = **ã€ŒAKS ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã€** ãªã®ã‹ï¼Ÿ

### Azure AKS ã«ãŠã‘ã‚‹ 2 ã¤ã®æ¦‚å¿µ

| æ¦‚å¿µ                       | æ„å‘³                                         | å®Ÿè£…æ–¹æ³•                        | å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹            |
| -------------------------- | -------------------------------------------- | ------------------------------- | ----------------------- |
| **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ** | ãƒãƒ¼ãƒ‰ãŒ VNet å†…ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ç©ºé–“ã«é…ç½® | `vnetSubnetID` ã§ã‚µãƒ–ãƒãƒƒãƒˆæŒ‡å®š | LoadBalancer çµŒç”±ã§å¯èƒ½ |
| **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼** | API ã‚µãƒ¼ãƒãƒ¼ãŒãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã®ã¿           | `enablePrivateCluster: true`    | Jump Server çµŒç”±ã®ã¿    |

---

## ğŸ” è¦ä»¶åˆ†æ

### è¦ä»¶ãŒæ±‚ã‚ã¦ã„ã‚‹ã‚‚ã®

1. âœ… **Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãŒãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®**

   - ãƒãƒ¼ãƒ‰ãŒ VNet å†…ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã¤
   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã¸ã®ç›´æ¥ãƒ«ãƒ¼ãƒˆãŒãªã„
   - **ã“ã‚Œã¯ã€Œãƒãƒ¼ãƒ‰ã®é…ç½®å ´æ‰€ã€ã®è©±**

2. âœ… **Ingress + LoadBalancer ã§å¤–éƒ¨å…¬é–‹**

   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
   - **ãƒ‘ãƒ–ãƒªãƒƒã‚¯ LoadBalancer ãŒå¿…è¦**

3. âœ… **kubectl ã‚³ãƒãƒ³ãƒ‰ã§æ“ä½œå¯èƒ½**
   - GitHub Actions ã‹ã‚‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
   - ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã‹ã‚‰ã®æ“ä½œ
   - **API ã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦**

### ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ã™ã‚‹ã¨ç™ºç”Ÿã™ã‚‹å•é¡Œ

âŒ **GitHub Actions ã‹ã‚‰ kubectl å®Ÿè¡Œä¸å¯**

```
error: dial tcp: lookup aks-dev-xxx.privatelink.japaneast.azmk8s.io
on 127.0.0.53:53: no such host
```

âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒè¤‡é›‘åŒ–**

- Self-hosted runner ãŒå¿…è¦
- ã¾ãŸã¯ VPN/ExpressRoute æ¥ç¶š
- Jump Server çµŒç”±ã® kubectl å®Ÿè¡Œ

---

## âœ… æ¡ç”¨ã—ãŸå®Ÿè£…

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ

```
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ
    â†“
[Azure Load Balancer (Public IP)]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ VNet: 10.0.0.0/16 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€ snet-aks: 10.0.1.0/24 (Private) â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ AKS ãƒãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«                     â”‚    â”‚
â”‚  â”‚  â€¢ Pod (10.244.x.x)                    â”‚    â”‚
â”‚  â”‚  â€¢ LoadBalancer Service â†’ å¤–éƒ¨å…¬é–‹     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€ snet-mongo: 10.0.2.0/24 (Private) â”€â”    â”‚
â”‚  â”‚  â€¢ MongoDB VM (10.0.2.4)                â”‚    â”‚
â”‚  â”‚  â€¢ AKS ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AKS API ã‚µãƒ¼ãƒãƒ¼ (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ FQDN)
    â†‘
kubectl / GitHub Actions
```

### Bicep å®Ÿè£…

**`infra/modules/aks.bicep`**

```bicep
resource aks 'Microsoft.ContainerService/managedClusters@2023-10-01' = {
  name: clusterName
  location: location
  properties: {
    dnsPrefix: clusterName

    // âœ… ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼: GitHub Actions ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½
    apiServerAccessProfile: {
      enablePrivateCluster: false
    }

    // âœ… ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½®
    agentPoolProfiles: [
      {
        name: 'nodepool1'
        count: 2
        vmSize: 'Standard_DS2_v2'
        osType: 'Linux'
        mode: 'System'
        vnetSubnetID: subnetId  // â† 10.0.1.0/24 ã«é…ç½®
      }
    ]

    networkProfile: {
      networkPlugin: 'azure'
      serviceCidr: '10.1.0.0/16'
      dnsServiceIP: '10.1.0.10'
      loadBalancerSku: 'standard'
      // âœ… LoadBalancer ã§å¤–éƒ¨å…¬é–‹
      outboundType: 'loadBalancer'
    }
  }
}
```

**`infra/modules/networking.bicep`**

```bicep
resource vnet 'Microsoft.Network/virtualNetworks@2023-05-01' = {
  name: 'vnet${environment}'
  location: location
  properties: {
    addressSpace: {
      addressPrefixes: ['10.0.0.0/16']
    }
    subnets: [
      {
        name: 'snet-aks'  // â† ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ
        properties: {
          addressPrefix: '10.0.1.0/24'
          privateEndpointNetworkPolicies: 'Disabled'
        }
      }
      {
        name: 'snet-mongo'  // â† ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ
        properties: {
          addressPrefix: '10.0.2.0/24'
        }
      }
    ]
  }
}
```

---

## ğŸ“Š è¦ä»¶é©åˆæ€§ã®æ¤œè¨¼

| è¦ä»¶                                              | å®Ÿè£…                           | çŠ¶æ…‹ |
| ------------------------------------------------- | ------------------------------ | ---- |
| Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«é…ç½® | `vnetSubnetID: 10.0.1.0/24`    | âœ…   |
| Ingress + LoadBalancer ã§å…¬é–‹                     | `outboundType: 'loadBalancer'` | âœ…   |
| kubectl ã‚³ãƒãƒ³ãƒ‰ã§æ“ä½œå¯èƒ½                        | API ã‚µãƒ¼ãƒãƒ¼ãŒãƒ‘ãƒ–ãƒªãƒƒã‚¯       | âœ…   |
| MongoDB ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ                  | `10.0.2.0/24`                  | âœ…   |
| MongoDB ã¸ã®æ¥ç¶šã¯ VNet å†…ã®ã¿                    | NSG ã§åˆ¶é™                     | âœ…   |

---

## ğŸ“ çµè«–

### ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã€â‰ ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã€

- **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ**: ãƒãƒ¼ãƒ‰ã®é…ç½®å ´æ‰€ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤ï¼‰
- **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼**: API ã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³å±¤ï¼‰

### æ¡ç”¨ã—ãŸè¨­è¨ˆåˆ¤æ–­

âœ… **ãƒãƒ¼ãƒ‰ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ** (`vnetSubnetID` ã§æŒ‡å®š)  
âœ… **API ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯** (`enablePrivateCluster: false`)  
âœ… **ã‚¢ãƒ—ãƒªã¯ LoadBalancer ã§å…¬é–‹** (è¦ä»¶é€šã‚Š)

ã“ã®æ§‹æˆã«ã‚ˆã‚Š:

- è¦ä»¶ã®ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆé…ç½®ã€ã‚’æº€ãŸã™
- GitHub Actions ã‹ã‚‰ã® CI/CD ãŒå¯èƒ½
- kubectl ã§ã®æ“ä½œãƒ‡ãƒ¢ãŒå¯èƒ½
- ä¸è¦ãªè¤‡é›‘æ€§ã‚’å›é¿

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Azure AKS ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼](https://learn.microsoft.com/ja-jp/azure/aks/private-clusters)
- [Azure Virtual Network ã‚µãƒ–ãƒãƒƒãƒˆ](https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-manage-subnet)
- [AKS ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¦‚å¿µ](https://learn.microsoft.com/ja-jp/azure/aks/concepts-network)

---

## ğŸ”„ å¤‰æ›´å±¥æ­´

| æ—¥æ™‚       | å¤‰æ›´å†…å®¹                                                             |
| ---------- | -------------------------------------------------------------------- |
| 2025-10-29 | åˆæœŸä½œæˆ: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ vs ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®è¦ä»¶è§£é‡ˆ |
| 2025-10-29 | å®Ÿè£…åˆ¤æ–­: `enablePrivateCluster: false` ã«å¤‰æ›´ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã«     |
