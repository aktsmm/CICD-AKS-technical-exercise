# Phase 08: AKS プロビジョニング完了待機実装

**作成日**: 2025-10-29  
**ステータス**: ✅ 解決済み  
**カテゴリ**: CI/CD パイプライン・非同期リソース作成

---

## 🔴 問題

### エラー内容

```
ERROR: (ControlPlaneNotFound) Could not find control plane with ID 6901659c8a804c00012113e9.
Please reconcile your managed cluster by cmd 'az aks update' and try again.
Code: ControlPlaneNotFound
Message: Could not find control plane with ID 6901659c8a804c00012113e9.
Please reconcile your managed cluster by cmd 'az aks update' and try again.
Exception Details: (Unspecified) rpc error: code = NotFound desc = Control Plane not found
Error: Process completed with exit code 3.
```

### 状況

- Infrastructure デプロイワークフローが「完了」
- `workflow_run` トリガーで App デプロイワークフローが開始
- `az aks get-credentials` 実行時に `ControlPlaneNotFound` エラー

---

## 🔍 原因分析

### 根本原因

**Bicep デプロイの「完了」と AKS リソースの「利用可能」は別のタイミング**

#### Infrastructure デプロイワークフローの動作

```yaml
- name: Deploy Bicep
  uses: azure/arm-deploy@v1
  # ↓ この時点で "完了" となる
```

**Bicep デプロイが完了する条件:**

- ARM API が AKS リソースの作成を開始
- API が `Succeeded` ステータスを返す
- **しかし、AKS Control Plane の初期化は非同期で継続中**

#### AKS のプロビジョニング状態

```bash
$ az aks list --query "[].{Name:name,State:provisioningState}"
Name         State
-----------  --------
aksdev  Creating  # ← Bicep は完了したが、AKS はまだ作成中
```

#### タイムライン

```
00:00  Bicep デプロイ開始
       └─ AKS リソース作成要求
05:00  Bicep デプロイ完了 ✅ (ARM API: Succeeded)
       └─ workflow_run トリガー発火
05:01  App デプロイ開始
       └─ az aks get-credentials 実行
       └─ ERROR: ControlPlaneNotFound ❌

       【実際の AKS の状態】
       provisioningState: Creating (Control Plane 初期化中)

10:00  AKS プロビジョニング完了 (本来はここで利用可能)
```

### なぜ以前は問題にならなかったか

1. **手動デプロイ時**: Infrastructure 完了を確認してから App デプロイを実行
2. **別々のデプロイ**: 時間差があり、自然に待機状態になっていた
3. **Phase 06 で自動化**: Infrastructure → App の即座の連携により顕在化

---

## ✅ 解決策

### 実装: AKS プロビジョニング完了待機ロジック

**`.github/workflows/app-deploy.yml`**

```yaml
- name: Set AKS Context
  run: |
    if [ -z "${{ steps.infra.outputs.aks_name }}" ]; then
      echo "Error: AKS cluster name is empty. Please run infra-deploy workflow first."
      exit 1
    fi

    # AKS がプロビジョニング完了するまで待機
    echo "Waiting for AKS cluster to be ready..."
    max_attempts=30
    attempt=1

    while [ $attempt -le $max_attempts ]; do
      state=$(az aks show \
        --resource-group ${{ env.RESOURCE_GROUP }} \
        --name ${{ steps.infra.outputs.aks_name }} \
        --query provisioningState -o tsv)
      
      echo "Attempt $attempt/$max_attempts: AKS provisioning state = $state"
      
      if [ "$state" == "Succeeded" ]; then
        echo "AKS cluster is ready!"
        break
      elif [ "$state" == "Failed" ]; then
        echo "Error: AKS provisioning failed"
        exit 1
      fi
      
      if [ $attempt -eq $max_attempts ]; then
        echo "Error: Timeout waiting for AKS to be ready"
        exit 1
      fi
      
      echo "Waiting 30 seconds..."
      sleep 30
      attempt=$((attempt + 1))
    done

    az aks get-credentials \
      --resource-group ${{ env.RESOURCE_GROUP }} \
      --name ${{ steps.infra.outputs.aks_name }} \
      --overwrite-existing
```

---

## 📊 実装の詳細

### 待機ロジックの仕様

| パラメータ       | 設定値                         | 説明                      |
| ---------------- | ------------------------------ | ------------------------- |
| **最大試行回数** | 30 回                          | 最大 15 分間待機          |
| **待機間隔**     | 30 秒                          | ポーリング頻度            |
| **タイムアウト** | 15 分                          | 通常 AKS は 5-10 分で完了 |
| **成功条件**     | `provisioningState: Succeeded` | Control Plane 利用可能    |
| **失敗条件**     | `provisioningState: Failed`    | 即座にエラー終了          |

### プロビジョニング状態の種類

| 状態        | 意味   | 処理            |
| ----------- | ------ | --------------- |
| `Creating`  | 作成中 | 待機継続        |
| `Updating`  | 更新中 | 待機継続        |
| `Succeeded` | 完了   | デプロイ続行 ✅ |
| `Failed`    | 失敗   | エラー終了 ❌   |
| `Deleting`  | 削除中 | エラー終了 ❌   |

---

## 🔄 修正後の動作フロー

### Infrastructure デプロイ → App デプロイ

```
┌─────────────────────────────────────────┐
│ Infrastructure Deploy Workflow          │
├─────────────────────────────────────────┤
│ 1. Bicep デプロイ実行                    │
│    └─ AKS リソース作成要求              │
│ 2. Bicep デプロイ完了 ✅                │
│    └─ ARM API: Succeeded                │
│ 3. workflow_run トリガー発火            │
└─────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│ App Deploy Workflow                      │
├─────────────────────────────────────────┤
│ 1. if 条件チェック                       │
│    └─ workflow_run.conclusion == success│
│ 2. Build & Push to ACR                  │
│ 3. Get Infrastructure Details           │
│ 4. ✨ AKS プロビジョニング状態チェック  │
│    ├─ Creating → 30秒待機               │
│    ├─ Creating → 30秒待機               │
│    └─ Succeeded → 続行 ✅              │
│ 5. az aks get-credentials               │
│ 6. kubectl apply                         │
│ 7. kubectl rollout status               │
└─────────────────────────────────────────┘
```

### ログ出力例

```bash
Waiting for AKS cluster to be ready...
Attempt 1/30: AKS provisioning state = Creating
Waiting 30 seconds...
Attempt 2/30: AKS provisioning state = Creating
Waiting 30 seconds...
Attempt 3/30: AKS provisioning state = Creating
Waiting 30 seconds...
Attempt 4/30: AKS provisioning state = Succeeded
AKS cluster is ready!
Merged "aksdev" as current context in /home/runner/.kube/config
```

---

## 🎯 設計判断

### 待機場所の選択

#### Option 1: Infrastructure デプロイワークフローで待機

```yaml
# infra-deploy.yml
- name: Wait for AKS
  run: |
    az aks wait --resource-group $RG --name $AKS_NAME --created
```

**メリット:**

- Infrastructure デプロイが真に完了
- App デプロイは即座に実行可能

**デメリット:**

- Infrastructure デプロイ時間が長くなる
- 手動での Infrastructure デプロイ時も毎回待機

#### Option 2: App デプロイワークフローで待機 ✅ (採用)

```yaml
# app-deploy.yml
- name: Set AKS Context
  run: |
    # AKS 状態チェックループ
```

**メリット:**

- Infrastructure デプロイが高速
- App デプロイ時にのみ待機
- 手動実行時も安全（冪等性）

**デメリット:**

- App デプロイ時間が若干増加

**採用理由:**

- Infrastructure は複数回デプロイされる可能性（テスト、修正）
- App デプロイは Infrastructure が完全に準備できた後に実行すべき
- 手動実行時の安全性向上

---

## 💡 ベストプラクティス

### 1. **非同期リソース作成の考慮**

Azure の多くのリソースは非同期で作成される:

| リソース     | ARM 完了 | 実際の利用可能 |
| ------------ | -------- | -------------- |
| AKS          | 5 秒     | 5-10 分        |
| VM           | 30 秒    | 2-5 分         |
| SQL Database | 1 分     | 5-15 分        |
| Function App | 10 秒    | 1-2 分         |

**教訓**: ARM API の完了を信頼せず、リソース固有の状態を確認する

### 2. **ポーリングのベストプラクティス**

```bash
# ✅ 良い例: 指数バックオフ
sleep_time=10
while [ $attempt -le $max_attempts ]; do
  # チェック
  sleep $sleep_time
  sleep_time=$((sleep_time * 2))  # 10, 20, 40, 80...
done

# ⚠️ 今回の実装: 固定間隔（シンプル）
sleep 30
```

**今回は固定間隔を採用:**

- AKS 作成時間は比較的予測可能（5-10 分）
- 指数バックオフの複雑性が不要
- タイムアウトで最大待機時間を制限

### 3. **冪等性の確保**

```bash
# 何度実行しても安全
az aks get-credentials --overwrite-existing
kubectl apply -f deployment.yaml  # apply は冪等
```

---

## 🚨 注意事項

### タイムアウト設定

**15 分（30 回 × 30 秒）を超えた場合:**

```bash
Error: Timeout waiting for AKS to be ready
exit 1
```

**対処法:**

1. Infrastructure デプロイログで AKS 作成エラーを確認
2. Azure Portal で AKS の詳細なエラーメッセージを確認
3. リソースグループを削除して再作成

### 並行実行の制限

**GitHub Actions の並行実行:**

```yaml
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false # 前のデプロイ完了を待つ
```

**今回は未実装:**

- `workflow_run` で自動的に順序が保証される
- 手動実行は運用者が管理

---

## 🔗 関連する問題

### Phase 06 との関係

**Phase 06: ワークフロー依存関係実装**

- Infrastructure → App の自動連携を実装
- しかし、リソースの利用可能性は未考慮

**Phase 08** (本件):

- リソースの利用可能性を確認するロジックを追加
- 真の自動化を実現

### Phase 07 との違い

**Phase 07: AKS-ACR 認証エラー**

- 権限の問題（ロール割り当て未実装）

**Phase 08** (本件):

- タイミングの問題（リソース作成未完了）

---

## 📚 参考資料

- [Azure ARM デプロイの非同期操作](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/async-operations)
- [AKS のプロビジョニング状態](https://learn.microsoft.com/ja-jp/azure/aks/concepts-clusters-workloads#cluster-lifecycle)
- [GitHub Actions workflow_run イベント](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_run)

---

## 🔄 変更履歴

| 日時       | 変更内容                                       |
| ---------- | ---------------------------------------------- |
| 2025-10-29 | 問題発見: ControlPlaneNotFound エラー          |
| 2025-10-29 | 原因特定: AKS プロビジョニング未完了           |
| 2025-10-29 | 解決: 状態チェックループ実装（最大 15 分待機） |
