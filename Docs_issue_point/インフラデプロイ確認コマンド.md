# インフラデプロイ確認コマンド - クイックリファレンス

**作成日**: 2025 年 1 月 29 日  
**用途**: Azure リソースデプロイ後の確認・検証・トラブルシューティング

---

## 📋 概要

Azure インフラストラクチャをデプロイした後に、リソースの状態を確認するための Azure CLI コマンド集です。

---

## 🔍 デプロイ完了後の確認手順

### 1. すべてのリソースを確認

```powershell
# リソースグループ内のすべてのリソースを表示
az resource list -g rg-cicd-bbs -o table

# リソース数を確認
az resource list -g rg-cicd-bbs --query "length([])"
```

### 2. AKS クラスターの確認

```powershell
# AKS クラスターの状態を確認
az aks show -g rg-cicd-bbs -n aks-wiz-exercise --query "{Name:name, Status:powerState.code, KubernetesVersion:kubernetesVersion, NodeCount:agentPoolProfiles[0].count}" -o table

# AKS 認証情報を取得
az aks get-credentials -g rg-cicd-bbs -n aks-wiz-exercise --overwrite-existing

# ノードを確認
kubectl get nodes
```

### 3. MongoDB VM の確認

```powershell
# VM の状態を確認
az vm show -g rg-cicd-bbs -n vm-mongo-dev --query "{Name:name, ProvisioningState:provisioningState, PowerState:instanceView.statuses[1].displayStatus}" -o table

# VM のパブリック IP アドレスを取得
az vm list-ip-addresses -g rg-cicd-bbs -n vm-mongo-dev --query "[0].virtualMachine.network.publicIpAddresses[0].ipAddress" -o tsv
```

### 4. Azure Container Registry の確認

```powershell
# ACR の状態を確認
az acr show -n acrwizexercise --query "{Name:name, LoginServer:loginServer, Sku:sku.name}" -o table

# AKS と ACR を統合
az aks update -g rg-cicd-bbs -n aks-wiz-exercise --attach-acr acrwizexercise
```

### 5. Log Analytics ワークスペースの確認

```powershell
# Log Analytics ワークスペースを確認
az monitor log-analytics workspace show -g rg-cicd-bbs -n log-wiz-exercise --query "{Name:name, Location:location}" -o table
```

### 6. Virtual Network の確認

```powershell
# VNet とサブネットを確認
az network vnet show -g rg-cicd-bbs -n vnet-wiz-exercise --query "{Name:name, AddressSpace:addressSpace.addressPrefixes[0]}" -o table

az network vnet subnet list -g rg-cicd-bbs --vnet-name vnet-wiz-exercise -o table
```

### 7. Storage Account の確認

```powershell
# Storage Account を確認
az storage account show -n stwizexercise -g rg-cicd-bbs --query "{Name:name, Location:location, Sku:sku.name}" -o table

# Blob コンテナーを確認
az storage container list --account-name stwizexercise -o table
```

## トラブルシューティング

### デプロイが失敗した場合

#### 1. エラーログを確認

GitHub Actions のログで詳細なエラーメッセージを確認します。

#### 2. Azure Provider の登録確認

```powershell
# 必要な Provider が登録されているか確認
az provider show --namespace Microsoft.ContainerService --query "registrationState"
az provider show --namespace Microsoft.Compute --query "registrationState"
az provider show --namespace Microsoft.Network --query "registrationState"
az provider show --namespace Microsoft.Storage --query "registrationState"
az provider show --namespace Microsoft.ContainerRegistry --query "registrationState"

# 未登録の場合は登録
az provider register --namespace Microsoft.ContainerService --wait
az provider register --namespace Microsoft.Compute --wait
az provider register --namespace Microsoft.Network --wait
az provider register --namespace Microsoft.Storage --wait
az provider register --namespace Microsoft.ContainerRegistry --wait
```

#### 3. リソースグループの確認

```powershell
# リソースグループが存在するか確認
az group show -n rg-cicd-bbs

# 存在しない場合は作成
az group create -n rg-cicd-bbs -l japaneast
```

#### 4. クォータの確認

```powershell
# VM のクォータを確認
az vm list-usage -l japaneast --query "[?name.value=='standardDSv2Family'].{Name:name.localizedValue, Current:currentValue, Limit:limit}" -o table

# AKS のクォータを確認
az vm list-usage -l japaneast --query "[?contains(name.value, 'Cores')].{Name:name.localizedValue, Current:currentValue, Limit:limit}" -o table
```

#### 5. 既存リソースの競合確認

```powershell
# 同名のリソースが存在するか確認
az aks show -n aks-wiz-exercise -g rg-cicd-bbs 2>&1
az vm show -n vm-mongo-dev -g rg-cicd-bbs 2>&1
az acr show -n acrwizexercise 2>&1
```

---

## 🚀 デプロイ成功後の次のステップ

### 1. AKS と ACR を統合

```powershell
# ACR からイメージをプルできるように AKS に権限を付与
az aks update -g rg-cicd-bbs -n aks-wiz-exercise --attach-acr acrwizexercise
```

### 2. MongoDB への接続確認

```powershell
# VM の IP アドレスを取得
$MONGO_IP = az vm list-ip-addresses -g rg-cicd-bbs -n vm-mongo-dev --query "[0].virtualMachine.network.publicIpAddresses[0].ipAddress" -o tsv

# SSH で接続テスト (パスワードは MONGO_ADMIN_PASSWORD シークレット)
ssh azureuser@$MONGO_IP

# MongoDB が起動しているか確認 (VM 内で実行)
sudo systemctl status mongod
```

### 3. アプリケーションデプロイの準備

インフラが正常にデプロイされたら、次のステップに進みます:

1. **アプリデプロイワークフローの実行**

   - GitHub Actions で「Build and Deploy Application」を手動実行
   - または `app/` 配下のファイルを変更してコミット

2. **デプロイ内容**
   - Docker イメージのビルドと ACR へのプッシュ
   - Kubernetes マニフェストの適用
   - Ingress の設定

---

## 📚 参考リンク

### Azure ドキュメント

- [AKS クイックスタート](https://learn.microsoft.com/ja-jp/azure/aks/learn/quick-kubernetes-deploy-cli)
- [Azure Container Registry](https://learn.microsoft.com/ja-jp/azure/container-registry/)
- [Bicep ドキュメント](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/)

### トラブルシューティング参考

- [AKS トラブルシューティング](https://learn.microsoft.com/ja-jp/azure/aks/troubleshooting)
- [Azure CLI リファレンス](https://learn.microsoft.com/ja-jp/cli/azure/)
- [Azure CLI トラブルシューティング](https://learn.microsoft.com/ja-jp/cli/azure/use-cli-effectively)

---

**作成者**: aktsmm  
**最終更新**: 2025 年 1 月 29 日

**関連ドキュメント**:

- `Docs_issue_point/README.md` - トラブル記録管理ガイド
- `Docs_work_history/Phase01_環境準備_2025-01-29.md` - 作業履歴

**プロジェクト**: CICD-AKS-Technical Exercise
