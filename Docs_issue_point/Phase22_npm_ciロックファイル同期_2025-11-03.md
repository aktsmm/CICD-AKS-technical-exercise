# Phase 22: CodeQL ã‚¸ãƒ§ãƒ–ã® npm ci ã‚¨ãƒ©ãƒ¼è§£æ±º

**ç™ºç”Ÿæ—¥æ™‚**: 2025 å¹´ 11 æœˆ 3 æ—¥ 09:40 JST
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 22 - DevSecOps (CI/CD ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
**é‡è¦åº¦**: ğŸ”´ Critical
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… è§£æ±ºæ¸ˆã¿

---

## ğŸ”¥ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (å…¨æ–‡)

```text
Run npm ci
npm error code EUSAGE
npm error
npm error `npm ci` can only install packages when your package.json and package-lock.json or npm-shrinkwrap.json are in sync. Please update your lock file with `npm install` before continuing.
npm error
npm error Missing: body-parser@1.20.3 from lock file
npm error Missing: ejs@3.1.10 from lock file
npm error Missing: express@4.21.2 from lock file
npm error Missing: mongoose@7.8.7 from lock file
npm error Missing: bytes@3.1.2 from lock file
npm error Missing: content-type@1.0.5 from lock file
npm error Missing: debug@2.6.9 from lock file
npm error Missing: depd@2.0.0 from lock file
npm error Missing: destroy@1.2.0 from lock file
npm error Missing: http-errors@2.0.0 from lock file
npm error Missing: iconv-lite@0.4.24 from lock file
npm error Missing: on-finished@2.4.1 from lock file
npm error Missing: qs@6.13.0 from lock file
npm error Missing: raw-body@2.5.2 from lock file
npm error Missing: type-is@1.6.18 from lock file
npm error Missing: unpipe@1.0.0 from lock file
npm error Missing: ms@2.0.0 from lock file
npm error Missing: jake@10.9.4 from lock file
npm error Missing: accepts@1.3.8 from lock file
npm error Missing: array-flatten@1.1.1 from lock file
npm error Missing: content-disposition@0.5.4 from lock file
npm error Missing: cookie@0.7.1 from lock file
npm error Missing: cookie-signature@1.0.6 from lock file
npm error Missing: encodeurl@2.0.0 from lock file
npm error Missing: escape-html@1.0.3 from lock file
npm error Missing: etag@1.8.1 from lock file
npm error Missing: finalhandler@1.3.1 from lock file
npm error Missing: fresh@0.5.2 from lock file
npm error Missing: merge-descriptors@1.0.3 from lock file
npm error Missing: methods@1.1.2 from lock file
npm error Missing: parseurl@1.3.3 from lock file
npm error Missing: path-to-regexp@0.1.12 from lock file
npm error Missing: proxy-addr@2.0.7 from lock file
npm error Missing: range-parser@1.2.1 from lock file
npm error Missing: safe-buffer@5.2.1 from lock file
npm error Missing: send@0.19.0 from lock file
npm error Missing: serve-static@1.16.2 from lock file
npm error Missing: setprototypeof@1.2.0 from lock file
npm error Missing: statuses@2.0.1 from lock file
npm error Missing: utils-merge@1.0.1 from lock file
npm error Missing: vary@1.1.2 from lock file
npm error Missing: mime-types@2.1.35 from lock file
npm error Missing: negotiator@0.6.3 from lock file
npm error Missing: inherits@2.0.4 from lock file
npm error Missing: toidentifier@1.0.1 from lock file
npm error Missing: safer-buffer@2.1.2 from lock file
npm error Missing: async@3.2.6 from lock file
npm error Missing: filelist@1.0.4 from lock file
npm error Missing: picocolors@1.1.1 from lock file
npm error Missing: minimatch@5.1.6 from lock file
npm error Missing: mime-db@1.52.0 from lock file
npm error Missing: brace-expansion@2.0.2 from lock file
npm error Missing: balanced-match@1.0.2 from lock file
npm error Missing: bson@5.5.1 from lock file
npm error Missing: kareem@2.5.1 from lock file
npm error Missing: mongodb@5.9.2 from lock file
npm error Missing: mpath@0.9.0 from lock file
npm error Missing: mquery@5.0.0 from lock file
npm error Missing: ms@2.1.3 from lock file
npm error Missing: sift@16.0.1 from lock file
npm error Missing: @mongodb-js/saslprep@1.3.2 from lock file
npm error Missing: mongodb-connection-string-url@2.6.0 from lock file
npm error Missing: socks@2.8.7 from lock file
npm error Missing: sparse-bitfield@3.0.3 from lock file
npm error Missing: @types/whatwg-url@8.2.2 from lock file
npm error Missing: whatwg-url@11.0.0 from lock file
npm error Missing: @types/node@24.9.2 from lock file
npm error Missing: @types/webidl-conversions@7.0.3 from lock file
npm error Missing: undici-types@7.16.0 from lock file
npm error Missing: debug@4.4.3 from lock file
npm error Missing: ee-first@1.1.1 from lock file
npm error Missing: forwarded@0.2.0 from lock file
npm error Missing: ipaddr.js@1.9.1 from lock file
npm error Missing: side-channel@1.1.0 from lock file
npm error Missing: encodeurl@1.0.2 from lock file
npm error Missing: mime@1.6.0 from lock file
npm error Missing: ms@2.1.3 from lock file
npm error Missing: es-errors@1.3.0 from lock file
npm error Missing: object-inspect@1.13.4 from lock file
npm error Missing: side-channel-list@1.0.0 from lock file
npm error Missing: side-channel-map@1.0.1 from lock file
npm error Missing: side-channel-weakmap@1.0.2 from lock file
npm error Missing: call-bound@1.0.4 from lock file
npm error Missing: get-intrinsic@1.3.0 from lock file
npm error Missing: call-bind-apply-helpers@1.0.2 from lock file
npm error Missing: function-bind@1.1.2 from lock file
npm error Missing: es-define-property@1.0.1 from lock file
npm error Missing: es-object-atoms@1.1.1 from lock file
npm error Missing: get-proto@1.0.1 from lock file
npm error Missing: gopd@1.2.0 from lock file
npm error Missing: has-symbols@1.1.0 from lock file
npm error Missing: hasown@2.0.2 from lock file
npm error Missing: math-intrinsics@1.1.0 from lock file
npm error Missing: dunder-proto@1.0.1 from lock file
npm error Missing: ip-address@10.0.1 from lock file
npm error Missing: smart-buffer@4.2.0 from lock file
npm error Missing: memory-pager@1.5.0 from lock file
npm error Missing: media-typer@0.3.0 from lock file
npm error Missing: tr46@3.0.0 from lock file
npm error Missing: webidl-conversions@7.0.0 from lock file
npm error Missing: punycode@2.3.1 from lock file
npm error Missing: ms@2.1.3 from lock file
npm error
npm error Clean install a project
npm error
npm error Usage:
npm error npm ci
npm error
npm error Options:
npm error [--install-strategy <hoisted|nested|shallow|linked>] [--legacy-bundling]
npm error [--global-style] [--omit <dev|optional|peer> [--omit <dev|optional|peer> ...]]
npm error [--include <prod|dev|optional|peer> [--include <prod|dev|optional|peer> ...]]
npm error [--strict-peer-deps] [--foreground-scripts] [--ignore-scripts] [--no-audit]
npm error [--no-bin-links] [--no-fund] [--dry-run]
npm error [-w|--workspace <workspace-name> [-w|--workspace <workspace-name> ...]]
npm error [-ws|--workspaces] [--include-workspace-root] [--install-links]
npm error
npm error aliases: clean-install, ic, install-clean, isntall-clean
npm error
npm error Run "npm help ci" for more info
npm error A complete log of this run can be found in: /home/runner/.npm/_logs/2025-11-03T00_41_00_777Z-debug-0.log
Error: Process completed with exit code 1.
```

---

## ğŸ“ ç™ºç”Ÿç®‡æ‰€

- GitHub Actions Workflow: `.github/workflows/app-deploy.yml`
- Job: `codeql-analysis`
- Step: `Install Node.js Dependencies`
- å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: `npm ci`
- é–¢é€£ã‚³ãƒŸãƒƒãƒˆ: `eb4b5f4` (CodeQL ã‚¸ãƒ§ãƒ–çµ±åˆ)

---

## ğŸ” åŸå› åˆ†æ

- `app/package-lock.json` ãŒã»ã¼ç©ºã®çŠ¶æ…‹ã§ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ãŠã‚Šã€ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è§£æ±ºæƒ…å ±ãŒæ¬ è½ã—ã¦ã„ãŸã€‚
- `npm ci` ã¯ lockfile ã‚’å”¯ä¸€ã®ä¾å­˜è§£æ±ºã‚½ãƒ¼ã‚¹ã¨ã—ã¦æ‰±ã†ãŸã‚ã€`package.json` ã§è§£æ±ºå¯¾è±¡ã«ãªã£ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ lockfile ã«å­˜åœ¨ã—ãªã„å ´åˆã¯å³åº§ã«å¤±æ•—ã™ã‚‹ã€‚
- CodeQL ã‚¸ãƒ§ãƒ–å†…ã§ `npm ci` ã‚’è¿½åŠ ã—ãŸã“ã¨ã§ã€ã“ã‚Œã¾ã§é¡•åœ¨åŒ–ã—ã¦ã„ãªã‹ã£ãŸ lockfile ã®ä¸æ•´åˆãŒ CI ä¸Šã§æ¤œå‡ºã•ã‚ŒãŸã€‚

---

## ğŸ› ï¸ è©¦è¡ŒéŒ¯èª¤ã®è¨˜éŒ²

### è©¦è¡Œ 1: ä¾å­˜æ§‹é€ ã®èª¿æŸ»

- **å®Ÿè¡Œå†…å®¹**: `app/package.json` ã¨ `app/package-lock.json` ã‚’æ¯”è¼ƒã—ã€lockfile ãŒãƒ™ãƒ¼ã‚¹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚’ä¿æŒã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚
- **çµæœ**: âŒ lockfile ãŒç„¡åŠ¹ã§ã‚ã‚‹äº‹å®Ÿã‚’ç¢ºèªã€‚
- **åˆ†æ**: æ‰‹å‹•ç·¨é›†ã¾ãŸã¯æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® npm ã«ã‚ˆã‚‹ç”ŸæˆãŒåŸå› ã¨æ¨å®šã€‚

### è©¦è¡Œ 2: `npm install` ã«ã‚ˆã‚‹ lockfile å†ç”Ÿæˆ

- **å®Ÿè¡Œå†…å®¹**:

```powershell
cd app
npm install
```

- **çµæœ**: âš ï¸ ä¾å­˜é–¢ä¿‚ä¸€å¼ãŒ `package-lock.json` ã«å±•é–‹ã•ã‚ŒãŸãŒã€`package.json` ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã¯å¤ã„ã¾ã¾ (`^4.18.2` ãªã©)ã€‚
- **åˆ†æ**: lockfile ã¨ manifest ã®ä¸æ•´åˆã¯è§£æ¶ˆã•ã‚ŒãŸãŒã€æœ€æ–°ã®ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–ã‚Šè¾¼ã‚€æ©Ÿä¼šã¨æ‰ãˆã¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ–¹é‡ã«åˆ‡ã‚Šæ›¿ãˆã€‚

### è©¦è¡Œ 3: ä¸»è¦ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°

- **å®Ÿè¡Œå†…å®¹**:

```powershell
npm install express@4.21.2 mongoose@7.8.7 body-parser@1.20.3 ejs@3.1.10
```

- **çµæœ**: âœ… `package.json` ãŒæœ€æ–°ã®ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°ã•ã‚Œã€lockfile ã‚‚ä¸€è‡´ã€‚
- **åˆ†æ**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ã‚’å«ã‚€æœ€æ–°ãƒ‘ãƒƒãƒã¸ã®æ›´æ–°ã¨åŒæ™‚ã«ã€CI ãŒè¦æ±‚ã™ã‚‹ lockfile åŒæœŸã‚’æº€ãŸã›ãŸã€‚

### è©¦è¡Œ 4: `npm ci` ã®ãƒ­ãƒ¼ã‚«ãƒ«å†å®Ÿè¡Œã§æ¤œè¨¼

- **å®Ÿè¡Œå†…å®¹**:

```powershell
npm ci
```

- **çµæœ**: âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã§ `npm ci` ãŒå®Œäº†ã—ã€CI ã¨åŒæ¡ä»¶ã§æˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚
- **åˆ†æ**: lockfile ã®å†ç”Ÿæˆã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã§å•é¡ŒãŒè§£æ¶ˆã•ã‚ŒãŸã“ã¨ã‚’è¨¼æ˜ã€‚

---

## ğŸ“˜ `npm install` ã¨ `npm ci` ã®é•ã„ãƒ¡ãƒ¢

| ã‚³ãƒãƒ³ãƒ‰      | ä¸»ãªç”¨é€”                   | lockfile ã®æ‰±ã„                                                                                                                                                | å…¸å‹çš„ãªä½¿ç”¨ã‚·ãƒŠãƒªã‚ª                                                                      |
| ------------- | -------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| `npm install` | ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ ãƒ»æ›´æ–° | `package.json` ã‚’åŸºã«è§£æ±ºã—ã€å¿…è¦ã«å¿œã˜ã¦ `package-lock.json` ã‚’æ›¸ãæ›ãˆã‚‹ã€‚æŒ‡å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¯„å›²å†…ã§æœ€æ–°ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€è§£æ±ºçµæœãŒæ—¥ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ | é–‹ç™ºä¸­ã«æ–°ã—ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã™ã‚‹ã¨ãã‚„ã€æ—¢å­˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ãŸã„ã¨ãã€‚                  |
| `npm ci`      | CI/CD ã§ã®å†ç¾æ€§ç¢ºä¿       | `package-lock.json` ã‚’å”¯ä¸€ã®ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨ã—ã€å…¨ä¾å­˜ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚lockfile ã¨ `package.json` ãŒä¸€è‡´ã—ãªã„å ´åˆã¯å³ã‚¨ãƒ©ãƒ¼ã€‚                          | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆã€Pull Request ãƒã‚§ãƒƒã‚¯ã€ä¾å­˜è§£æ±ºã®å†ç¾æ€§ã‚’ä¿è¨¼ã—ãŸã„ã¨ãã€‚ |

**å®Ÿå‹™ Tip**: ä¾å­˜ã‚’å¤‰æ›´ã—ãŸç›´å¾Œã¯ `npm install` ã§ lockfile ã‚’æ›´æ–°ã—ã€ãã®çŠ¶æ…‹ã§ `npm ci` ãŒé€šã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã¨ã€CI ã§ã‚‚åŒã˜ç’°å¢ƒãŒå†ç¾ã§ãã‚‹ã€‚

---

## âœ… æœ€çµ‚çš„ãªè§£æ±ºæ–¹æ³•

**å®Ÿæ–½å†…å®¹**:

1. `app/package.json` ã®ä¾å­˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æœ€æ–°ãƒ‘ãƒƒãƒã«æ›´æ–°ã€‚
2. `npm install` â†’ `npm ci` ã‚’å®Ÿè¡Œã—ã€`package-lock.json` ã‚’å®Œå…¨ã«å†ç”Ÿæˆã€‚
3. `app/package.json` ã¨ `app/package-lock.json` ã‚’ã‚³ãƒŸãƒƒãƒˆ (`2f0a560`).
4. GitHub Actions ã‚’å†å®Ÿè¡Œã—ã€`codeql-analysis` ã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

**å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«**:

- `app/package.json`
- `app/package-lock.json`

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:

```powershell
cd d:/00_temp/wizwork/wiz-technical-exercise/app
npm install
npm install express@4.21.2 mongoose@7.8.7 body-parser@1.20.3 ejs@3.1.10
npm ci
```

---

## ğŸ”„ å†ç™ºé˜²æ­¢ç­–

### 1. ä¾å­˜æ›´æ–°ãƒ•ãƒ­ãƒ¼ã®æ¨™æº–åŒ–

- **å†…å®¹**: ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ãƒ»æ›´æ–°ã™ã‚‹éš›ã¯ `npm install` / `npm update` å¾Œã« `npm ci` ã‚’å®Ÿè¡Œã—ã€lockfile ãŒ CI ã¨åŒã˜çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’æ‰‹å…ƒã§æ¤œè¨¼ã™ã‚‹ã€‚
- **å®Ÿæ–½æ™‚æœŸ**: å³æ—¥é‹ç”¨ã€‚

### 2. Dependabot ã«ã‚ˆã‚‹è‡ªå‹•ç›£è¦–

- **å†…å®¹**: `.github/dependabot.yml` ã§ npm ã¨ GitHub Actions ã®é€±æ¬¡ç›£è¦–ã‚’æœ‰åŠ¹åŒ–æ¸ˆã¿ã€‚Dependabot PR ã‚’å–ã‚Šè¾¼ã‚€éš›ã¯ `npm ci` ãŒæˆåŠŸã™ã‚‹ã‹ã‚’å¿…ãšãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
- **è£œè¶³**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨ã‚‚è‡ªå‹•åŒ–ã•ã‚Œã€lockfile ã®ã‚ºãƒ¬ãŒæ—©æœŸã«æ¤œå‡ºã§ãã‚‹ã€‚

### 3. CodeQL ã‚¸ãƒ§ãƒ–ã§ã®ãƒ—ãƒªãƒã‚§ãƒƒã‚¯ç¶™ç¶š

- **å†…å®¹**: `codeql-analysis` ã‚¸ãƒ§ãƒ–ã«ãŠã‘ã‚‹ `npm ci` ã‚’å¿…é ˆã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã€lockfile ä¸æ•´åˆã‚’ PR æ™‚ç‚¹ã§æ¤œçŸ¥ã™ã‚‹ã€‚
- **ç¾å ´ Tip**: å®Ÿå‹™ã§ã‚‚ CodeQL ã‚„ SAST ã®å‰æ®µã« `npm ci` ã‚’ç½®ãã¨ã€ä¾å­˜è§£æ±ºãŒä¿è¨¼ã•ã‚ŒãŸçŠ¶æ…‹ã§é™çš„è§£æã‚’å®Ÿè¡Œã§ãã‚‹ãŸã‚ã€ãƒã‚¤ã‚ºãŒæ¸›ã‚Šèª¿æŸ»å·¥æ•°ãŒå‰Šæ¸›ã§ãã‚‹ã€‚

---

## ğŸ“ å‚è€ƒæƒ…å ±

- `ci: integrate CodeQL into app deployment` (commit `eb4b5f4`)
- `deps: sync app dependencies for npm ci` (commit `2f0a560`)
- [#microsoft.docs.mcp CodeQL code scanning](https://learn.microsoft.com/ja-jp/code-security/secure-coding/github/codeql-code-scanning)
