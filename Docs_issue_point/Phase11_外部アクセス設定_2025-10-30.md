# Phase 11: 外部アクセス設定 (2025-10-30)

## 問題

デプロイ後、アプリケーションへのアクセス方法が不明。  
`kubectl get svc`で確認したところ、`guestbook-service`が**ClusterIP**になっており、外部からアクセス不可。

```bash
$ kubectl get svc -n default
NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
guestbook-service   ClusterIP   10.1.246.60   <none>        80/TCP    22h
```

## 原因

`app/k8s/service.yaml`の Service タイプが`ClusterIP`のままだった。

```yaml
spec:
  type: ClusterIP # ← これでは外部アクセス不可
```

## 解決策

### 1. Service タイプを`LoadBalancer`に変更

**ファイル**: `app/k8s/service.yaml`

```diff
 spec:
-  type: ClusterIP
+  type: LoadBalancer  # ClusterIP → LoadBalancer に変更
   selector:
     app: guestbook
```

### 2. 変更をコミット&プッシュ

```bash
cd d:\00_temp\wizwork\wiz-technical-exercise
git add app/k8s/service.yaml
git commit -m "fix: Change Service type from ClusterIP to LoadBalancer for external access"
git push
```

GitHub Actions の`app-deploy`ワークフローが自動トリガーされ、変更が反映される。

### 3. 即座に適用 (オプション)

ワークフロー完了を待たずに即座に反映:

```bash
kubectl apply -f app/k8s/service.yaml
```

### 4. External IP の確認

```bash
kubectl get svc guestbook-service -n default
```

**結果**:

```
NAME                TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)        AGE
guestbook-service   LoadBalancer   10.1.246.60   48.218.233.207   80:31305/TCP   22h
```

## アクセス方法

### ブラウザでアクセス

```
http://48.218.233.207
```

### curl でテスト

```bash
curl http://48.218.233.207
```

### PowerShell でテスト

```powershell
Invoke-WebRequest http://48.218.233.207
```

## 技術的補足

### LoadBalancer vs ClusterIP

| タイプ           | 用途                 | External IP          |
| ---------------- | -------------------- | -------------------- |
| **ClusterIP**    | クラスタ内部通信のみ | なし                 |
| **LoadBalancer** | 外部からのアクセス   | Azure が自動割り当て |
| NodePort         | 開発/テスト用        | Node IP + ポート     |

### Bicep での Kubernetes リソース管理

**Q**: Bicep で Service マニフェストを管理できる?  
**A**: 技術的には可能だが**推奨されない**

- Bicep → AKS Extension → Kubernetes マニフェスト適用という複雑な経路
- デバッグが困難
- Kubernetes エコシステムとの統合が弱い

**推奨アプローチ** (現在の構成):

1. GitHub Actions + `kubectl apply` (シンプル、直感的)
2. GitOps (Flux/ArgoCD) (本番環境向け)
3. Helm Chart (複雑なアプリケーション向け)

## ワークフロー統合

既に`.github/workflows/app-deploy.yml`で自動デプロイ設定済み:

```yaml
- name: Deploy to AKS
  run: |
    kubectl apply -f app/k8s/rbac-vulnerable.yaml
    kubectl apply -f app/k8s/deployment.yaml
    kubectl apply -f app/k8s/service.yaml  # ← ここで適用
```

YAML ファイルを変更してプッシュすれば、CI/CD パイプラインが自動的に反映する。

## 検証結果

✅ External IP 取得成功: `48.218.233.207`  
✅ ブラウザアクセス成功  
✅ Pod ステータス: Running (2 replicas)  
✅ GitHub Actions 統合済み

## 関連ファイル

- `app/k8s/service.yaml` - Service マニフェスト
- `.github/workflows/app-deploy.yml` - アプリデプロイワークフロー
- `app/k8s/deployment.yaml` - Deployment マニフェスト
