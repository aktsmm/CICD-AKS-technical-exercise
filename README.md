# Azure Kubernetes Service CI/CD æŠ€è¡“æ¼”ç¿’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

> âš ï¸ **é‡è¦ãªæ³¨æ„äº‹é …**
>
> ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯**å­¦ç¿’ãƒ»ãƒ‡ãƒ¢ç›®çš„**ã§æ„å›³çš„ã«è„†å¼±æ€§ã‚’å«ã‚€ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
>
> - æœ¬ç•ªç’°å¢ƒã§ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
> - ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã¯å¿…ãšãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„
> - Azure ã®èª²é‡‘ãŒç™ºç”Ÿã—ã¾ã™ï¼ˆæ¨å®š: æ•°ç™¾å††ã€œæ•°åƒå††/æ—¥ï¼‰
> - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãŒç·©ã„ãŸã‚ã€æ‚ªæ„ã‚ã‚‹æ”»æ’ƒã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
2. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
3. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#-ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
4. [ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ](#-ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ)
5. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ](#-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ)
6. [å‡¦ç†ãƒ•ãƒ­ãƒ¼](#-å‡¦ç†ãƒ•ãƒ­ãƒ¼)
7. [é€šä¿¡ãƒ•ãƒ­ãƒ¼](#-é€šä¿¡ãƒ•ãƒ­ãƒ¼)
8. [å‰ææ¡ä»¶](#-å‰ææ¡ä»¶)
9. [åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#-åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
10. [ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †](#-ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †)
11. [å‹•ä½œç¢ºèª](#-å‹•ä½œç¢ºèª)
12. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
13. [ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—](#-ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—)

---

## ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ç›®çš„

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**Azure Kubernetes Service (AKS)** ä¸Šã§å‹•ä½œã™ã‚‹æ²ç¤ºæ¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¡Œæã«ã€ä»¥ä¸‹ã‚’å­¦ç¿’ãƒ»å®Ÿè¨¼ã™ã‚‹ãŸã‚ã®æŠ€è¡“æ¼”ç¿’ã§ã™ï¼š

- **Infrastructure as Code (IaC)**: Azure Bicep ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©è‡ªå‹•æ§‹ç¯‰
- **CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**: GitHub Actions ã«ã‚ˆã‚‹ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: æ„å›³çš„ã«è„†å¼±æ€§ã‚’å«ã‚€ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€æ¤œå‡º â†’ ä¿®å¾©ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’å­¦ã¶ï¼ˆAzure Policyã€Defender for Cloudã€èªè¨¼è¨­å®šãªã©ï¼‰
- **ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«ã‚ˆã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

> **é‡è¦**: ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯**å­¦ç¿’ãƒ»ãƒ‡ãƒ¢ç›®çš„**ã§ã€æœ€åˆã«è„†å¼±æ€§ã®ã‚ã‚‹ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚

### èƒŒæ™¯

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–ãªé–‹ç™ºã§ã¯ã€ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€ä½“ã¨ã—ã¦ç®¡ç†ã—ã€è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§å“è³ªã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æ‹…ä¿ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€**è„†å¼±æ€§ã‚’å«ã‚€åˆæœŸç’°å¢ƒã‚’è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤**ã—ã€ãã‚Œã‚‰ã‚’æ¤œå‡ºãƒ»ä¿®å¾©ã™ã‚‹ä¸€é€£ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½“é¨“ã™ã‚‹ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ã‚¢ãªé‹ç”¨ã¸ã®ç†è§£ã‚’æ·±ã‚ã¾ã™ã€‚

### å­¦ç¿’ãƒ•ãƒ­ãƒ¼

```text
[Phase 1] è„†å¼±ãªç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ (è‡ªå‹•)
   â†“
[Phase 2] è„†å¼±æ€§ã®æ¤œå‡ºã¨ç¢ºèª (æ‰‹å‹• / ãƒ‡ãƒ¢)
   â†“
[Phase 3] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ã®é©ç”¨ (æ‰‹å‹• / åˆ¥é€”æä¾›)
   â†“
[Phase 4] ä¿®æ­£å¾Œã®æ¤œè¨¼ (æ‰‹å‹•)
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦

- **æ²ç¤ºæ¿ã‚¢ãƒ—ãƒª (BBS - Bulletin Board System)**
  - Node.js + Express + EJS ã§æ§‹ç¯‰
  - MongoDB ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåå‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ãƒ»é–²è¦§å¯èƒ½
  - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (`/health`) ã‚’æä¾›

---

## ğŸ›  æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

| æŠ€è¡“                               | ç”¨é€”                         | å‚è€ƒãƒªãƒ³ã‚¯                                                                      |
| ---------------------------------- | ---------------------------- | ------------------------------------------------------------------------------- |
| **Azure Kubernetes Service (AKS)** | ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | [AKS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/aks/)                |
| **Azure Container Registry (ACR)** | Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¿å­˜        | [ACR ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/container-registry/) |
| **Azure Virtual Machines**         | MongoDB ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°         | [VM ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/virtual-machines/)    |
| **Azure Storage Account**          | ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—           | [Storage ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/storage/)        |
| **Azure Virtual Network**          | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢             | [VNet ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/virtual-network/)   |
| **Azure Monitor / Log Analytics**  | ç›£æŸ»ãƒ­ã‚°åé›†                 | [Monitor ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/azure-monitor/)  |

### CI/CDãƒ»é–‹ç™ºãƒ„ãƒ¼ãƒ«

| æŠ€è¡“               | ç”¨é€”                           | å‚è€ƒãƒªãƒ³ã‚¯                                                                                  |
| ------------------ | ------------------------------ | ------------------------------------------------------------------------------------------- |
| **GitHub Actions** | CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³             | [GitHub Actions ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.github.com/ja/actions)                           |
| **Azure Bicep**    | Infrastructure as Code         | [Bicep ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/) |
| **CodeQL**         | ã‚³ãƒ¼ãƒ‰å“è³ªãƒ»è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³     | [CodeQL ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://codeql.github.com/docs/)                                      |
| **Trivy**          | ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ | [Trivy GitHub](https://github.com/aquasecurity/trivy)                                       |
| **Checkov**        | IaC ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³       | [Checkov ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.checkov.io/)                                             |

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

| æŠ€è¡“        | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€”                 |
| ----------- | ---------- | -------------------- |
| **Node.js** | 20.x       | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè¡Œç’°å¢ƒ |
| **Express** | 4.x        | Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯   |
| **MongoDB** | 7.x        | NoSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹   |
| **EJS**     | 3.x        | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ |
| **Docker**  | Latest     | ã‚³ãƒ³ãƒ†ãƒŠåŒ–           |

---

## ğŸ— ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå›³

> **æ³¨**: ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã®ã¯**è„†å¼±æ€§ã‚’å«ã‚€åˆæœŸæ§‹æˆ**ã§ã™ã€‚
> å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®èª¬æ˜ã§ã€ŒåˆæœŸã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹è¨­å®šãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Azure Subscription                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Resource Group: rg-bbs-cicd-aks                  â”‚  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ AKS Cluster                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Node Pool (System & User)               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Frontend Container (BBS App)            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Ingress Controller + LoadBalancer       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - RBAC: Cluster Admin ä»˜ä¸ (è„†å¼±!)       â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                      â†• (Port 27017)             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Virtual Machine (MongoDB)                  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Ubuntu 22.04                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - MongoDB 7.x                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Public IP + SSH Port 22 Open (è„†å¼±!)   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - NSG: ç·©ã„è¨­å®š (0.0.0.0/0 è¨±å¯)         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - MongoDB èªè¨¼ãªã— (è„†å¼±!)                â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                      â†• (HTTPS)                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Storage Account (Blob)                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠ                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Public Access æœ‰åŠ¹ (è„†å¼±!)             â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Azure Container Registry                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Docker Image Repository                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Azure Monitor / Log Analytics Workspace    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - AKS Diagnostics (kube-audit)            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - ACR / Storage / NSG Logs                â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Azure Policy (Microsoft Cloud Security)    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - ã‚«ã‚¹ã‚¿ãƒ  MCSB ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–é©ç”¨          â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â†• Internet (HTTPS Port 443)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼      â”‚
â”‚   (Web Browser)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„ã‚µãƒ¼ãƒ“ã‚¹ã®å½¹å‰²

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ      | å½¹å‰²               | è©³ç´°                                                                 |
| ------------------- | ------------------ | -------------------------------------------------------------------- |
| **AKS Cluster**     | ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡ŒåŸºç›¤   | Node.js ã‚¢ãƒ—ãƒªã‚’ Pod ã¨ã—ã¦å®Ÿè¡Œã€‚Ingress çµŒç”±ã§å¤–éƒ¨å…¬é–‹              |
| **ACR**             | ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ã‚¸ã‚¹ãƒˆãƒª | GitHub Actions ã§ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä¿å­˜ãƒ»AKS ã‹ã‚‰ãƒ—ãƒ«              |
| **MongoDB VM**      | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹       | æ²ç¤ºæ¿ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ°¸ç¶šåŒ–ã€‚**èªè¨¼ãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹(è„†å¼±æ€§)**     |
| **Storage Account** | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—       | MongoDB ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã€‚**Public Access æœ‰åŠ¹(è„†å¼±æ€§)** |
| **Log Analytics**   | ç›£è¦–ãƒ»ç›£æŸ»         | Kubernetes ç›£æŸ»ãƒ­ã‚°ã€ãƒªã‚½ãƒ¼ã‚¹ã®è¨ºæ–­ãƒ­ã‚°ã‚’é›†ç´„                        |
| **Azure Policy**    | ã‚¬ãƒãƒŠãƒ³ã‚¹         | Microsoft Cloud Security Benchmark ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’è‡ªå‹•é©ç”¨    |
| **Load Balancer**   | ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ†æ•£   | Ingress Controller çµŒç”±ã§å¤–éƒ¨ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ AKS ã«è»¢é€           |

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨ä¾å­˜é–¢ä¿‚

```text
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
   â†“ (1) HTTP/HTTPS Request
[Load Balancer (Ingress)]
   â†“ (2) Forward to Pod
[BBS App Container (AKS Pod)]
   â†“ (3) MongoDB Query (Port 27017)
[MongoDB VM]
   â†“ (4) Backup Script
[Storage Account Blob]
```

1. **HTTP/HTTPS ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æ²ç¤ºæ¿ã«ã‚¢ã‚¯ã‚»ã‚¹
2. **Ingress ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: Kubernetes Ingress ãŒ `Service` â†’ `Pod` ã«è»¢é€
3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒª**: Node.js ã‚¢ãƒ—ãƒªãŒ MongoDB ã«æ¥ç¶šã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿æ›¸ã
4. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: å®šæœŸçš„ã« MongoDB ãƒ‡ãƒ¼ã‚¿ã‚’ Storage Account ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆGitHub Actions ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼‰

---

## ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ

### ã‚µãƒ–ãƒãƒƒãƒˆæ§‹æˆ

| ã‚µãƒ–ãƒãƒƒãƒˆ         | CIDR         | ç”¨é€”              | æ¥ç¶šå…ˆ                      |
| ------------------ | ------------ | ----------------- | --------------------------- |
| **aks-subnet**     | 10.1.0.0/20  | AKS ãƒãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«  | MongoDB VM (Private IP)     |
| **vm-subnet**      | 10.1.16.0/24 | MongoDB VM        | AKS Subnetã€Storage (HTTPS) |
| **default-subnet** | 10.1.17.0/24 | æ±ç”¨ (å°†æ¥æ‹¡å¼µç”¨) | -                           |

### Network Security Group (NSG) ãƒ«ãƒ¼ãƒ«

#### ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹æ§‹æˆï¼ˆè„†å¼±æ€§ã‚ã‚Šï¼‰

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã®ã¯ä»¥ä¸‹ã®**è„†å¼±ãªæ§‹æˆ**ã§ã™ï¼š

| ãƒ«ãƒ¼ãƒ«å           | æ–¹å‘    | ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | é€ä¿¡å…ƒ      | å®›å…ˆ | âš ï¸ ãƒªã‚¹ã‚¯                                 |
| ------------------ | ------- | ---------- | ------ | ----------- | ---- | ----------------------------------------- |
| Allow-SSH-Internet | Inbound | TCP        | 22     | `0.0.0.0/0` | VM   | å…¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ SSH ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½     |
| Allow-MongoDB      | Inbound | TCP        | 27017  | `0.0.0.0/0` | VM   | å…¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ MongoDB ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |

#### æ¨å¥¨ã•ã‚Œã‚‹ã‚»ã‚­ãƒ¥ã‚¢æ§‹æˆï¼ˆä¿®æ­£ä¾‹ï¼‰

ä»¥ä¸‹ã¯ä¿®æ­£å¾Œã®æ¨å¥¨è¨­å®šã§ã™ï¼ˆã“ã® README ã®æ‰‹é †ã§ã¯è‡ªå‹•é©ç”¨ã•ã‚Œã¾ã›ã‚“ï¼‰ï¼š

| ãƒ«ãƒ¼ãƒ«å           | æ–¹å‘    | ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | é€ä¿¡å…ƒ      | å®›å…ˆ | ç›®çš„                     |
| ------------------ | ------- | ---------- | ------ | ----------- | ---- | ------------------------ |
| Allow-SSH-Internet | Inbound | TCP        | 22     | `0.0.0.0/0` | VM   | SSH ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå±é™ºï¼‰     |
| Allow-MongoDB      | Inbound | TCP        | 27017  | `0.0.0.0/0` | VM   | MongoDB ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå±é™ºï¼‰ |

ä»¥ä¸‹ã¯ä¿®æ­£å¾Œã®æ¨å¥¨è¨­å®šã§ã™ï¼ˆã“ã® README ã®æ‰‹é †ã§ã¯è‡ªå‹•é©ç”¨ã•ã‚Œã¾ã›ã‚“ï¼‰:

| ãƒ«ãƒ¼ãƒ«å             | æ–¹å‘    | ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | é€ä¿¡å…ƒ          | å®›å…ˆ | èª¬æ˜                      |
| -------------------- | ------- | ---------- | ------ | --------------- | ---- | ------------------------- |
| Allow-SSH-Restricted | Inbound | TCP        | 22     | `<ç®¡ç†è€…IP>/32` | VM   | ç‰¹å®š IP ã®ã¿ SSH è¨±å¯     |
| Allow-MongoDB-AKS    | Inbound | TCP        | 27017  | `10.1.0.0/20`   | VM   | AKS Subnet ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯ |
| Deny-All-Inbound     | Inbound | All        | All    | `0.0.0.0/0`     | VM   | æ˜ç¤ºçš„ãªæ‹’å¦              |

### å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¶å¾¡

#### ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šï¼ˆè„†å¼±æ€§ã‚ã‚Šï¼‰

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹è¨­å®š:

- **AKS Ingress Load Balancer**: `0.0.0.0/0` ã‹ã‚‰ HTTP/HTTPS ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆæ­£å¸¸ï¼‰
- **MongoDB VM**: SSH (22) ã¨ MongoDB (27017) ãŒ**å…¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹** âš ï¸
- **Storage Account**: Blob ã‚³ãƒ³ãƒ†ãƒŠãŒ**Public Access è¨±å¯** âš ï¸

#### æ¨å¥¨ã•ã‚Œã‚‹å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šï¼ˆä¿®æ­£ä¾‹ï¼‰

ä»¥ä¸‹ã¯å­¦ç¿’å¾Œã«é©ç”¨ã™ã¹ãã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®šã§ã™:

- **AKS Ingress**: HTTPS ã®ã¿è¨±å¯ï¼ˆHTTP â†’ HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰ã€WAF è¿½åŠ 
- **MongoDB VM**: ç®¡ç†è€… IP ã®ã¿ SSH è¨±å¯ã€MongoDB ã¯ AKS Subnet ã‹ã‚‰ã®ã¿
- **Storage Account**: Public Access ç„¡åŠ¹ã€Private Endpoint ä½¿ç”¨

#### ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡

- **AKS â†’ ACR**: ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒ«ï¼ˆèªè¨¼ãªã— Public Pull ã‚‚å¯èƒ½ã ãŒæ¨å¥¨å¤–ï¼‰
- **AKS â†’ MongoDB VM**: Private IP (10.1.16.x) çµŒç”±ã§ Port 27017 æ¥ç¶š
- **MongoDB VM â†’ Storage**: HTTPS (443) çµŒç”±ã§ Blob API ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### èªè¨¼ãƒ»èªå¯ã®ä»•çµ„ã¿

#### Azure AD (Entra ID) çµ±åˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ     | èªè¨¼æ–¹å¼                                | è©³ç´°                                                                                                                                                                 |
| ------------------ | --------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **GitHub Actions** | OIDC (ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ ID ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³) | `azure/login` ãŒ `AZURE_CLIENT_ID` / `AZURE_TENANT_ID` / `AZURE_SUBSCRIPTION_ID` ã‚’ä½¿ç”¨ã€‚Secrets ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ä¿æŒã›ãšã€Federated Credential ã§çŸ­å‘½ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ |
| **AKS**            | ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£              | ACR ã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«ã™ã‚‹éš›ã«ä½¿ç”¨ã€‚Azure RBAC ã¨çµ±åˆå¯èƒ½                                                                                                            |
| **Azure Policy**   | ã‚·ã‚¹ãƒ†ãƒ å‰²ã‚Šå½“ã¦ MI                     | Policy ä¿®å¾©ã‚¿ã‚¹ã‚¯å®Ÿè¡Œæ™‚ã«å¿…è¦ã€‚Contributor ãƒ­ãƒ¼ãƒ«ãŒå¿…è¦                                                                                                              |
| **MongoDB**        | ãªã— (è„†å¼±!)                            | **èªè¨¼ãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™**ã€‚ä¿®æ­£æ™‚ã« `mongoadmin` ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ                                                                                                 |

> **è£œè¶³**: GitHub Actions ã®èªè¨¼ã«ã¤ã„ã¦
>
> - **ç¾åœ¨ã®å®Ÿè£…**: OpenID Connect (OIDC) ãƒ™ãƒ¼ã‚¹ã® Microsoft Entra ã‚¢ãƒ—ãƒª (`gh-aks-oidc`)
> - **ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹**: `AZURE_GITHUB_PRINCIPAL_ID` ã«å€¤ã‚’å…¥ã‚Œã¦å®Ÿè¡Œã™ã‚‹ã¨ã€ä¸€æ™‚çš„ã« Service Principal ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ (`AZURE_CREDENTIALS`) ã§ RBAC ä»˜ä¸ã‚’è‡ªå‹•åŒ–
> - **å‚è€ƒè³‡æ–™**: [GitHub Actions ã§ã® Azure ã¸ã® OIDC èªè¨¼](https://learn.microsoft.com/ja-jp/azure/developer/github/connect-from-azure-openid-connect) / `Docs_issue_point/Phase30_OIDCAuthMigration_2025-11-05.md`

#### Kubernetes RBAC

**ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹æ§‹æˆï¼ˆè„†å¼±æ€§ã‚ã‚Šï¼‰**:

- `ClusterRoleBinding` ã§ `cluster-admin` æ¨©é™ã‚’ä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä»˜ä¸
- ã™ã¹ã¦ã® Pod ãŒ Kubernetes API ã«å¯¾ã—ã¦ç®¡ç†è€…æ¨©é™ã‚’æŒã¤çŠ¶æ…‹

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£å¾Œã®æ§‹æˆ**:

æœ€å°æ¨©é™ã® `Role` ã¨ `RoleBinding` ã‚’ä½¿ç”¨ã€‚ä¾‹: `Pod` ã¸ã® `get`, `list` ã®ã¿è¨±å¯

```yaml
# ä¿®æ­£å¾Œã®ä¾‹ï¼ˆæ‰‹å‹•é©ç”¨ãŒå¿…è¦ï¼‰
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
```

### é€šä¿¡ã®æš—å·åŒ–

| é€šä¿¡çµŒè·¯               | ãƒ—ãƒ­ãƒˆã‚³ãƒ«            | æš—å·åŒ–æ–¹å¼             | è¨­å®šç®‡æ‰€                                                        |
| ---------------------- | --------------------- | ---------------------- | --------------------------------------------------------------- |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Ingress** | HTTPS                 | TLS 1.2+               | Ingress Controller (è¨¼æ˜æ›¸ã¯ Let's Encrypt æ¨å¥¨)                |
| **Pod é–“é€šä¿¡**         | HTTP                  | (NetworkPolicy ã§åˆ¶é™) | Kubernetes NetworkPolicy                                        |
| **AKS â†’ MongoDB**      | MongoDB Wire Protocol | **å¹³æ–‡é€šä¿¡ (è„†å¼±!)**   | MongoDB è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (`mongod.conf`)ã€‚ä¿®æ­£æ™‚ã« TLS æœ‰åŠ¹åŒ–ã‚’æ¨å¥¨ |
| **VM â†’ Storage**       | HTTPS                 | TLS 1.2                | Storage Account è¨­å®š (`--https-only true`)                      |
| **GitHub â†’ Azure**     | HTTPS                 | TLS 1.2                | GitHub Actions Runner (è‡ªå‹•)                                    |

### Secrets ã¨ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†

#### GitHub Secrets

å¿…é ˆã® Secret ã‚’ä»¥ä¸‹ã«ç™»éŒ²ã—ã¦ãã ã•ã„ï¼ˆSettings â†’ Secrets and variables â†’ Actionsï¼‰:

| Secret å                  | å†…å®¹                                       | å–å¾—æ–¹æ³• / å‚™è€ƒ                                                             |
| -------------------------- | ------------------------------------------ | --------------------------------------------------------------------------- |
| `AZURE_CLIENT_ID`          | Microsoft Entra ã‚¢ãƒ—ãƒª (gh-aks-oidc) ã® ID | `az ad sp show --id <appId> --query appId -o tsv`                           |
| `AZURE_TENANT_ID`          | ãƒ†ãƒŠãƒ³ãƒˆ ID                                | `az account show --query tenantId -o tsv`                                   |
| `AZURE_SUBSCRIPTION_ID`    | Azure ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID                | `az account show --query id -o tsv`                                         |
| `MONGO_ADMIN_PASSWORD`     | MongoDB ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰                   | ä»»æ„ã®å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: `openssl rand -base64 32`)                      |
| `AZURE_CREDENTIALS` (ä»»æ„) | ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ç”¨ SP ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ JSON    | `az ad sp create-for-rbac --sdk-auth`ã€‚RBAC è‡ªå‹•åŒ–ãŒä¸è¦ãªã‚‰ç™»éŒ²ã—ãªã„ã§ OK |

#### GitHub Variables

| Variable å                 | å†…å®¹                                | ä¾‹                                             |
| --------------------------- | ----------------------------------- | ---------------------------------------------- |
| `AZURE_RESOURCE_GROUP`      | ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å                  | `rg-bbs-cicd-aks`                              |
| `AZURE_LOCATION`            | ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³                | `japaneast`                                    |
| `IMAGE_NAME`                | Docker ã‚¤ãƒ¡ãƒ¼ã‚¸å                   | `bbs-app`                                      |
| `AZURE_GITHUB_PRINCIPAL_ID` | GitHub Actions SP ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ID | `az ad sp show --id <appId> --query id -o tsv` |

#### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°

Kubernetes Deployment ã§ä»¥ä¸‹ã‚’è¨­å®š:

```yaml
env:
  - name: MONGO_URI
    value: "mongodb://<MONGODB_VM_PRIVATE_IP>:27017/guestbook"
  - name: PORT
    value: "3000"
  - name: NODE_ENV
    value: "production"
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³

| ãƒ„ãƒ¼ãƒ«         | ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡            | ã‚¿ã‚¤ãƒŸãƒ³ã‚°                 | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«                         |
| -------------- | ----------------------- | -------------------------- | ------------------------------------ |
| **Checkov**    | Bicep IaC               | ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤å‰         | `.github/workflows/infra-deploy.yml` |
| **Trivy**      | Bicep + Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ | ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤å‰ | `.github/workflows/app-deploy.yml`   |
| **CodeQL**     | JavaScript ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ | ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤å‰           | `.github/workflows/app-deploy.yml`   |
| **Dependabot** | npm ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸      | å®šæœŸè‡ªå‹•å®Ÿè¡Œ               | `.github/dependabot.yml`             |

---

## ğŸ”„ å‡¦ç†ãƒ•ãƒ­ãƒ¼

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‹ã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã¾ã§ã®æµã‚Œ

```text
[1] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã§ http://<EXTERNAL_IP> ã«ã‚¢ã‚¯ã‚»ã‚¹
     â†“
[2] Azure Load Balancer ãŒ Ingress Controller ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
     â†“
[3] Ingress ãŒ Service (guestbook-service) ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯è»¢é€
     â†“
[4] Service ãŒ Pod (bbs-app) ã® Port 3000 ã«è»¢é€
     â†“
[5] Node.js ã‚¢ãƒ—ãƒª (Express) ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡
     â†“
[6] Mongoose ã§ MongoDB (VM) ã«æ¥ç¶š
     - æ“ä½œ: db.messages.find() ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§å–å¾—
     â†“
[7] EJS ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     â†“
[8] HTML ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã™
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿ãƒ•ãƒ­ãƒ¼

```text
[1] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ¼ãƒ ã«åå‰ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ (POST /submit)
     â†“
[2] Express ãŒ body-parser ã§ POST ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
     â†“
[3] Mongoose ã§ MongoDB ã«æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæŒ¿å…¥
     - db.messages.insertOne({ name, message, createdAt })
     â†“
[4] ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ (302) ã§ GET / ã«é·ç§»
     â†“
[5] æ›´æ–°ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ã‚’è¡¨ç¤º
```

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ï¼ˆéåŒæœŸãƒ»ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼‰

```text
[ãƒˆãƒªã‚¬ãƒ¼] GitHub Actions Scheduled Workflow (.github/workflows/backup-schedule.yml)
     â†“
[1] Azure VM ã« SSH æ¥ç¶šï¼ˆã¾ãŸã¯ Run Command API ä½¿ç”¨ï¼‰
     â†“
[2] MongoDB ã§ mongodump å®Ÿè¡Œ
     - å‡ºåŠ›: /tmp/mongodb-backup-YYYYMMDD.tar.gz
     â†“
[3] Azure CLI ã§ Storage Account ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
     - az storage blob upload --account-name ... --container-name backups
     â†“
[4] ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
     â†“
[5] Log Analytics ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```

---

## ğŸ“¡ é€šä¿¡ãƒ•ãƒ­ãƒ¼

### APIãƒ»ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é€šä¿¡çµŒè·¯

#### 1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ â†’ AKS (HTTPS)

- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: HTTPS (TLS 1.2+)
- **ãƒãƒ¼ãƒˆ**: 443
- **çµŒè·¯**: `Internet â†’ Azure Load Balancer â†’ Ingress Controller â†’ Service â†’ Pod`
- **èªè¨¼**: ãªã—ï¼ˆPublic ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

#### 2. AKS Pod â†’ MongoDB VM (MongoDB Wire Protocol)

- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: MongoDB Wire Protocol over TCP
- **ãƒãƒ¼ãƒˆ**: 27017
- **çµŒè·¯**: `Pod (10.1.0.x) â†’ VNet (10.1.16.x) â†’ MongoDB VM`
- **èªè¨¼**: **ãªã— (è„†å¼±!)** - ä¿®æ­£æ™‚ã« SCRAM-SHA-256 (ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰) ã‚’è¨­å®š
- **æš—å·åŒ–**: **å¹³æ–‡ (è„†å¼±!)** - ä¿®æ­£æ™‚ã« TLS æœ‰åŠ¹åŒ–ã‚’æ¨å¥¨

#### 3. MongoDB VM â†’ Storage Account (HTTPS)

- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: HTTPS (Azure Blob API)
- **ãƒãƒ¼ãƒˆ**: 443
- **çµŒè·¯**: `VM Public IP â†’ Azure Storage Endpoint`
- **èªè¨¼**: Storage Account Key ã¾ãŸã¯ SAS Token
- **æš—å·åŒ–**: TLS 1.2 å¿…é ˆ

#### 4. GitHub Actions â†’ Azure (ARM API)

- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: HTTPS (Azure Resource Manager)
- **ãƒãƒ¼ãƒˆ**: 443
- **èªè¨¼**: ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ« (OAuth 2.0 Bearer Token)
- **ç”¨é€”**: Bicep ãƒ‡ãƒ—ãƒ­ã‚¤ã€kubectl applyã€Azure CLI ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

#### 5. AKS â†’ ACR (Docker Registry API)

- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: HTTPS
- **ãƒãƒ¼ãƒˆ**: 443
- **èªè¨¼**: ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¾ãŸã¯ Admin User
- **ç”¨é€”**: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒ« (`imagePullPolicy: Always`)

### é€šä¿¡ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ï¼ˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³é¢¨ï¼‰

```text
User          LoadBalancer   Ingress   Pod(BBS)   MongoDB   Storage
 |                |            |          |          |         |
 |--HTTP GET----->|            |          |          |         |
 |                |--Route---->|          |          |         |
 |                |            |--Fwd---->|          |         |
 |                |            |          |--Query-->|         |
 |                |            |          |<--Data---|         |
 |                |            |<--HTML---|          |         |
 |                |<--200 OK---|          |          |         |
 |<--HTML---------|            |          |          |         |
 |                                                             |
(Backup Job)                              |--mongodump-->     |
                                          |--Upload---------->|
```

---

## âœ… å‰ææ¡ä»¶

### å¿…é ˆãƒ„ãƒ¼ãƒ«

ä»¥ä¸‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼š

| ãƒ„ãƒ¼ãƒ«             | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ (Windows / PowerShell)                  | ç¢ºèªã‚³ãƒãƒ³ãƒ‰               |
| ------------------ | ---------- | ------------------------------------------------------------ | -------------------------- |
| **Azure CLI**      | 2.50+      | `winget install Microsoft.AzureCLI`                          | `az --version`             |
| **kubectl**        | 1.28+      | `az aks install-cli`                                         | `kubectl version --client` |
| **Docker Desktop** | Latest     | [å…¬å¼ã‚µã‚¤ãƒˆ](https://www.docker.com/products/docker-desktop) | `docker --version`         |
| **Git**            | 2.40+      | `winget install Git.Git`                                     | `git --version`            |
| **Node.js**        | 20.x       | `winget install OpenJS.NodeJS.LTS`                           | `node --version`           |
| **PowerShell**     | 7.3+       | `winget install Microsoft.PowerShell`                        | `pwsh --version`           |

### Azure ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è¦ä»¶

- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãª Azure ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³** (ç„¡æ–™è©¦ç”¨ç‰ˆå¯)
- **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã® Owner ã¾ãŸã¯ Contributor ãƒ­ãƒ¼ãƒ«**
- **ãƒªã‚½ãƒ¼ã‚¹ã‚¯ã‚©ãƒ¼ã‚¿**:
  - VM: Standard_B2s ä»¥ä¸Š Ã— 1 å°
  - AKS: Standard_D2s_v3 ä»¥ä¸Š Ã— 2 ãƒãƒ¼ãƒ‰
  - Storage Account: æ¨™æº– LRS

### GitHub ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

- **GitHub ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ** (ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§å¯)
- **GitHub Actions åˆ©ç”¨å¯èƒ½** (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªã¯ç„¡æ–™ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã¯æœˆ 2000 åˆ†ã¾ã§ç„¡æ–™)

---

## ğŸš€ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³

PowerShell ã‚’é–‹ã„ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œ:

```powershell
# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
Set-Location "C:\Projects"

# ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/aktsmm/CICD-AKS-technical-exercise.git

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
Set-Location CICD-AKS-technical-exercise
```

### ã‚¹ãƒ†ãƒƒãƒ— 2: Azure CLI ãƒ­ã‚°ã‚¤ãƒ³

```powershell
# Azure ã«ãƒ­ã‚°ã‚¤ãƒ³
az login

# ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’ç¢ºèª
az account list --output table

# ä½¿ç”¨ã™ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
az account set --subscription "<SUBSCRIPTION_ID>"

# ç¢ºèª
az account show --output table

# å¾Œç¶šã®ãƒ­ãƒ¼ãƒ«ä»˜ä¸ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ ID ã‚’ä¿æŒ
$subscriptionId = (az account show --query id -o tsv)
```

### ã‚¹ãƒ†ãƒƒãƒ— 3: OIDC ç”¨ Microsoft Entra ã‚¢ãƒ—ãƒªã®ä½œæˆ

ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ OIDC ã§ Azure ã«æ¥ç¶šã™ã‚‹ãŸã‚ã€**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ä¸è¦**ã§ã™ã€‚Microsoft Entra ã‚¢ãƒ—ãƒªã‚’ç™»éŒ²ã—ã€GitHub Actions ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿¡é ¼ã•ã›ã¾ã™ã€‚

```powershell
# ãƒªãƒã‚¸ãƒˆãƒªè­˜åˆ¥å­ã¨ã‚¢ãƒ—ãƒªåã‚’è¨­å®š
$repository = "aktsmm/CICD-AKS-technical-exercise"
$appName = "gh-aks-oidc"

# OIDC ç”¨ã®ã‚¢ãƒ—ãƒªç™»éŒ²ã‚’ä½œæˆ
$app = az ad app create --display-name $appName | ConvertFrom-Json
$appId = $app.appId
$tenantId = (az account show --query tenantId -o tsv) # Secrets ã¸ç™»éŒ²ã™ã‚‹ãƒ†ãƒŠãƒ³ãƒˆ ID

# Azure ãƒªã‚½ãƒ¼ã‚¹ã¨ç´ä»˜ã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‚’ä½œæˆ
az ad sp create --id $appId | Out-Null

# GitHub Actions ãŒæ“ä½œã™ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¸ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸
az role assignment create `
  --assignee $appId `
  --role Contributor `
  --scope "/subscriptions/$subscriptionId"

# ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã®ã¿ã‚’è¨±å¯ã™ã‚‹ Federated Credential ã‚’ä½œæˆ
az ad app federated-credential create `
  --id $appId `
  --parameters @"
{
  "name": "github-main",
  "issuer": "https://token.actions.githubusercontent.com",
  "subject": "repo:$repository:ref:refs/heads/main",
  "audiences": ["api://AzureADTokenExchange"]
}
"@

# å–å¾—ã—ãŸ ID ã‚’ç¢ºèª (Secrets ç™»éŒ²ã§ä½¿ç”¨)
az ad sp show --id $appId --query '{appId:appId, tenantId:appOwnerTenantId}' -o jsonc
```

> ğŸ’¡ `workflow_dispatch` ãªã©ä»–ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨±å¯ã—ãŸã„å ´åˆã¯ã€`subject` ã‚’ `repo:<OWNER>/<REPO>:environment:prod` ãªã©ã«è¿½åŠ ã—ã¦ãƒ–ãƒ©ãƒ³ãƒå˜ä½ã§åˆ¶å¾¡ã—ã¦ãã ã•ã„ã€‚è©³ç´°ã¯ [GitHub Actions ã§ã® Azure ã¸ã® OIDC èªè¨¼](https://learn.microsoft.com/ja-jp/azure/developer/github/connect-from-azure-openid-connect) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

Secrets ç™»éŒ²æ™‚ã¯ä»¥ä¸‹ã®å¯¾å¿œé–¢ä¿‚ã«ãªã‚Šã¾ã™ï¼š

- `AZURE_CLIENT_ID`: `$appId`
- `AZURE_TENANT_ID`: `$tenantId`
- `AZURE_SUBSCRIPTION_ID`: `$subscriptionId`

### ã‚¹ãƒ†ãƒƒãƒ— 4: GitHub Secrets ã®ç™»éŒ²

1. **GitHub ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹**: `https://github.com/<YOUR_USERNAME>/CICD-AKS-technical-exercise`
2. **Settings â†’ Secrets and variables â†’ Actions** ã‚’é–‹ãã€ä»¥ä¸‹ã® Secrets ã‚’ç™»éŒ²:

| Name                    | Value                                             | èª¬æ˜                                                                |
| ----------------------- | ------------------------------------------------- | ------------------------------------------------------------------- |
| `AZURE_CLIENT_ID`       | `$appId`                                          | OIDC ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ Microsoft Entra ã‚¢ãƒ—ãƒªã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID         |
| `AZURE_TENANT_ID`       | `$tenantId`                                       | ãƒ†ãƒŠãƒ³ãƒˆ IDã€‚`az account show --query tenantId -o tsv` ã§å†å–å¾—å¯èƒ½ |
| `AZURE_SUBSCRIPTION_ID` | `$subscriptionId`                                 | ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID                                   |
| `MONGO_ADMIN_PASSWORD`  | å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹: `openssl rand -base64 32`ï¼‰ | MongoDB ã‚’ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°ã™ã‚‹éš›ã«ä½¿ç”¨                                  |

> â„¹ï¸ æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã® RBAC ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã‚’è‡ªå‹•åŒ–ã—ãŸã„å ´åˆã®ã¿ã€å¾“æ¥ã® `AZURE_CREDENTIALS` ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ (`az ad sp create-for-rbac --sdk-auth`)ã€‚å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨ã€`infra-deploy` ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒä¸€åº¦ã ã‘ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆèªè¨¼ã§ãƒ­ãƒ¼ãƒ«ä»˜ä¸ã‚’è¡Œã„ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ— 5: GitHub Variables ã®ç™»éŒ²

åŒã˜ãƒšãƒ¼ã‚¸ã§ **Variables** ã‚¿ãƒ–ã‚’é–‹ãã€ä»¥ä¸‹ã‚’ç™»éŒ²:

| Name                   | Value             | èª¬æ˜               |
| ---------------------- | ----------------- | ------------------ |
| `AZURE_RESOURCE_GROUP` | `rg-bbs-cicd-aks` | ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å |
| `AZURE_LOCATION`       | `japaneast`       | ãƒªãƒ¼ã‚¸ãƒ§ãƒ³         |
| `IMAGE_NAME`           | `bbs-app`         | Docker ã‚¤ãƒ¡ãƒ¼ã‚¸å  |

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³**ï¼ˆãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ç”¨ã€‚åˆå›ã¯ä¸è¦ï¼‰:

| Name                        | Value                                        | èª¬æ˜                                                                                            |
| --------------------------- | -------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| `AZURE_GITHUB_PRINCIPAL_ID` | ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ID (ä»»æ„) | RBAC ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã‚’è‡ªå‹•åŒ–ã—ãŸã„å ´åˆã®ã¿è¨­å®šã€‚`az ad sp show --id <appId> --query id -o tsv` |

### ã‚¹ãƒ†ãƒƒãƒ— 6: ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å‹•ä½œç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```powershell
# app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
Set-Location app

# ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ãƒ­ãƒ¼ã‚«ãƒ« MongoDB ã‚’èµ·å‹•ï¼ˆDocker ã‚’ä½¿ç”¨ï¼‰
docker run -d -p 27017:27017 --name mongo-local mongo:7

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‚¢ãƒ—ãƒªèµ·å‹•
$env:MONGO_URI = "mongodb://localhost:27017/guestbook"
$env:PORT = "3000"
npm start
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000` ã‚’é–‹ã„ã¦å‹•ä½œç¢ºèªã€‚

**åœæ­¢æ–¹æ³•**:

```powershell
# Ctrl+C ã§ã‚¢ãƒ—ãƒªåœæ­¢
docker stop mongo-local
docker rm mongo-local
```

---

## ğŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### ãƒ•ã‚§ãƒ¼ã‚º 1: ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®ãƒ‡ãƒ—ãƒ­ã‚¤

#### 1-1. GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œ

1. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® **Actions** ã‚¿ãƒ–ã‚’é–‹ã
2. **"1. Deploy Infrastructure"** ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é¸æŠ
3. **Run workflow** â†’ **Branch: main** â†’ **Run workflow** ã‚’ã‚¯ãƒªãƒƒã‚¯

#### 1-2. ãƒ‡ãƒ—ãƒ­ã‚¤ã®é€²è¡ŒçŠ¶æ³ã‚’ç¢ºèª

- **scan-iac** ã‚¸ãƒ§ãƒ–: Checkov ã¨ Trivy ã§ IaC ã‚’ã‚¹ã‚­ãƒ£ãƒ³
- **deploy-infra** ã‚¸ãƒ§ãƒ–: Bicep ã§ Azure ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
  - ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
  - AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼
  - ACR
  - MongoDB VMï¼ˆUbuntu + MongoDB ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
  - Storage Account
  - Log Analytics Workspace
  - Network Security Groups

å®Œäº†ã¾ã§ **ç´„ 15ã€œ20 åˆ†**ã‹ã‹ã‚Šã¾ã™ã€‚

#### 1-3. å‡ºåŠ›æƒ…å ±ã®å–å¾—

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†å¾Œã€**Artifacts** ã‹ã‚‰ `infra-outputs` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’ç¢ºèª:

```json
{
  "aksClusterName": "aks-bbs-dev-xxxxx",
  "acrName": "acrbbs xxxxx",
  "mongoVmPrivateIp": "10.1.16.4",
  "storageAccountName": "stbbsxxxxx"
}
```

### ãƒ•ã‚§ãƒ¼ã‚º 2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤

#### 2-1. AKS ã¸ã® kubectl æ¥ç¶šè¨­å®š

PowerShell ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:

```powershell
# å¤‰æ•°è¨­å®šï¼ˆinfra-outputs ã‹ã‚‰å–å¾—ã—ãŸå€¤ã‚’ä½¿ç”¨ï¼‰
$resourceGroup = "rg-bbs-cicd-aks"
$aksClusterName = "aks-bbs-dev-xxxxx"  # å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆ

# AKS èªè¨¼æƒ…å ±ã‚’å–å¾—
az aks get-credentials --resource-group $resourceGroup --name $aksClusterName --overwrite-existing

# ç¢ºèª
kubectl get nodes
```

**å‡ºåŠ›ä¾‹**:

```text
NAME                                STATUS   ROLES   AGE   VERSION
aks-nodepool1-12345678-vmss000000   Ready    agent   5m    v1.28.3
aks-nodepool1-12345678-vmss000001   Ready    agent   5m    v1.28.3
```

#### 2-2. GitHub Actions ã§ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤

1. **Actions** ã‚¿ãƒ– â†’ **"2-1. Build and Deploy Application"** ã‚’é¸æŠ
2. **Run workflow** â†’ **Run workflow** ã‚’ã‚¯ãƒªãƒƒã‚¯

**å‡¦ç†å†…å®¹**:

- **quality-check**: npm test ã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- **codeql-analysis**: CodeQL ã§ã‚³ãƒ¼ãƒ‰å“è³ªã‚¹ã‚­ãƒ£ãƒ³
- **scan-container**: Trivy ã§ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
- **build-push**: ACR ã« Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥
- **deploy-aks**: Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é©ç”¨

å®Œäº†ã¾ã§ **ç´„ 10ã€œ15 åˆ†**ã€‚

#### 2-3. ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèª

```powershell
# Pod ã®çŠ¶æ…‹ç¢ºèª
kubectl get pods

# Service ã®ç¢ºèª
kubectl get services

# Ingress ã®ç¢ºèªï¼ˆEXTERNAL-IP ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã¾ã§æ•°åˆ†ã‹ã‹ã‚‹ï¼‰
kubectl get ingress
```

**å‡ºåŠ›ä¾‹**:

```text
NAME                 CLASS   HOSTS   ADDRESS         PORTS   AGE
guestbook-ingress    nginx   *       20.xxx.xxx.xxx  80      3m
```

---

## ğŸ§ª å‹•ä½œç¢ºèª

### 1. Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

```powershell
# External IP ã‚’å–å¾—
$externalIp = kubectl get ingress guestbook-ingress -o jsonpath='{.status.loadBalancer.ingress[0].ip}'

# ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
Start-Process "http://$externalIp"
```

**ç¢ºèªé …ç›®**:

- âœ… æ²ç¤ºæ¿ã®ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… åå‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã§ãã‚‹
- âœ… æŠ•ç¨¿ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã‚‹

### 2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```powershell
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
Invoke-WebRequest -Uri "http://$externalIp/health" -UseBasicParsing | Select-Object StatusCode, Content
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›**:

```text
StatusCode : 200
Content    : {"status":"OK","timestamp":"2025-01-05T12:34:56.789Z"}
```

### 3. MongoDB æ¥ç¶šç¢ºèª

```powershell
# MongoDB VM ã« SSH æ¥ç¶šï¼ˆåˆæœŸè¨­å®šã§ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãŒå¿…è¦ï¼‰
$mongoVmIp = "20.xxx.xxx.xxx"  # VM ã® Public IP
ssh azureuser@$mongoVmIp

# MongoDB ã«æ¥ç¶šï¼ˆåˆæœŸã¯èªè¨¼ãªã—ï¼‰
mongo

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
show dbs
use guestbook
db.messages.find().pretty()

# çµ‚äº†
exit
exit
```

### 4. è„†å¼±æ€§ã®ç¢ºèªï¼ˆå­¦ç¿’ãƒ»ãƒ‡ãƒ¢ç”¨ï¼‰

#### 4-1. Storage Account ã® Public Access

```powershell
$storageAccountName = "stbbsxxxxx"  # å®Ÿéš›ã®å€¤
Invoke-WebRequest -Uri "https://$storageAccountName.blob.core.windows.net/backups/" -UseBasicParsing
```

**ç¢ºèªçµæœ**: åˆæœŸè¨­å®šã§ã¯ Blob ä¸€è¦§ãŒè¦‹ãˆã‚‹ â†’ **è„†å¼±æ€§ãŒå­˜åœ¨**

#### 4-2. SSH ãƒãƒ¼ãƒˆã®é–‹æ”¾ç¢ºèª

```powershell
# nmap ã§ç¢ºèªï¼ˆäº‹å‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¿…è¦: winget install Insecure.Nmapï¼‰
nmap -Pn -p 22,27017 $mongoVmIp
```

**ç¢ºèªçµæœ**: Port 22 (SSH) ã¨ 27017 (MongoDB) ãŒ `open` â†’ **è„†å¼±æ€§ãŒå­˜åœ¨**

#### 4-3. MongoDB èªè¨¼ãªã—ç¢ºèª

```powershell
# MongoDB VM ã« SSH æ¥ç¶š
ssh azureuser@$mongoVmIp

# MongoDB ã«æ¥ç¶šï¼ˆèªè¨¼ãªã—ï¼‰
mongo

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
show dbs
use guestbook
db.messages.find().pretty()

exit
exit
```

**ç¢ºèªçµæœ**: èªè¨¼ãªã—ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ â†’ **è„†å¼±æ€§ãŒå­˜åœ¨**

#### 4-4. RBAC éå‰°æ¨©é™ã®ç¢ºèª

```powershell
kubectl auth can-i '*' '*' --as=system:serviceaccount:default:default
```

**ç¢ºèªçµæœ**: `yes` ã¨è¡¨ç¤ºã•ã‚Œã‚‹ â†’ **éå‰°ãªæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹**

---

## ğŸ”§ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£æ‰‹é †

> **æ³¨**: ä»¥ä¸‹ã®ä¿®æ­£æ‰‹é †ã¯å­¦ç¿’ç”¨ã§ã™ã€‚æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯è‡ªå‹•é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

### ä¿®æ­£ 1: Storage Account ã®ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°

```powershell
# Public Access ã‚’ç„¡åŠ¹åŒ–
az storage account update \
  --name $storageAccountName \
  --resource-group $resourceGroup \
  --allow-blob-public-access false \
  --https-only true \
  --min-tls-version TLS1_2
```

### ä¿®æ­£ 2: NSG ãƒ«ãƒ¼ãƒ«ã®åˆ¶é™

```powershell
# SSH ã‚’ç‰¹å®š IP ã®ã¿ã«åˆ¶é™
$myIp = (Invoke-WebRequest -Uri "https://ifconfig.me/ip").Content.Trim()
az network nsg rule update \
  --resource-group $resourceGroup \
  --nsg-name mongodb-nsg \
  --name Allow-SSH-Internet \
  --source-address-prefixes "$myIp/32"

# MongoDB ã‚’ AKS Subnet ã®ã¿ã«åˆ¶é™
az network nsg rule update \
  --resource-group $resourceGroup \
  --nsg-name mongodb-nsg \
  --name Allow-MongoDB \
  --source-address-prefixes "10.1.0.0/20"
```

### ä¿®æ­£ 3: MongoDB èªè¨¼ã®æœ‰åŠ¹åŒ–

```powershell
# VM ã§å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
$script = @'
mongo admin --eval "db.createUser({ user: 'mongoadmin', pwd: '$MONGO_ADMIN_PASSWORD', roles: ['root'] })"
sudo sed -i '/^#security:/a security:\n  authorization: enabled' /etc/mongod.conf
sudo systemctl restart mongod
'@

# Run Command ã§å®Ÿè¡Œ
az vm run-command invoke \
  --resource-group $resourceGroup \
  --name mongodb-vm \
  --command-id RunShellScript \
  --scripts "$script"
```

### ä¿®æ­£ 4: Kubernetes RBAC ã®æœ€å°æ¨©é™åŒ–

è„†å¼±ãª `ClusterRoleBinding` ã‚’å‰Šé™¤ã—ã€æœ€å°æ¨©é™ã® Role ã‚’é©ç”¨:

```powershell
# è„†å¼±ãªè¨­å®šã‚’å‰Šé™¤
kubectl delete clusterrolebinding default-admin

# æœ€å°æ¨©é™ã® Role ã‚’é©ç”¨
kubectl apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
  namespace: default
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pod-reader-binding
  namespace: default
subjects:
- kind: ServiceAccount
  name: default
  namespace: default
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
EOF
```

### ä¿®æ­£å¾Œã®æ¤œè¨¼

```powershell
# Storage Account ã®ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
Invoke-WebRequest -Uri "https://$storageAccountName.blob.core.windows.net/backups/" -UseBasicParsing
# æœŸå¾…: 403 Forbidden

# MongoDB æ¥ç¶šç¢ºèª
mongo --host $mongoVmIp
# æœŸå¾…: èªè¨¼ã‚¨ãƒ©ãƒ¼

# RBAC ç¢ºèª
kubectl auth can-i '*' '*' --as=system:serviceaccount:default:default
# æœŸå¾…: no
```

---

## ğŸ›  ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ 1: GitHub Actions ã§ azure/login ãŒèªè¨¼ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

**ä¾‹:**

```text
Error: Federated token fetch failed, client or tenant not found
```

**è§£æ±ºç­–**:

1. `AZURE_CLIENT_ID` / `AZURE_TENANT_ID` / `AZURE_SUBSCRIPTION_ID` ã® Secrets ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. Microsoft Entra ã‚¢ãƒ—ãƒªã« GitHub Actions ç”¨ Federated Credential ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ (`az ad app federated-credential list --id <appId>`)
3. ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ãŒä»˜ä¸æ¸ˆã¿ã‹ (`az role assignment list --assignee <appId> --scope /subscriptions/$subscriptionId`)
4. ã©ã†ã—ã¦ã‚‚ RBAC ä»˜ä¸ãŒè¡Œãˆãªã„å ´åˆã¯ã€ä¸€æ™‚çš„ã« `AZURE_CREDENTIALS` ã‚’ç™»éŒ²ã—ã¦ `infra-deploy` ã‚’å†å®Ÿè¡Œã—ã€è‡ªå‹•ä»˜ä¸ãŒå®Œäº†ã—ãŸã‚‰å‰Šé™¤ã™ã‚‹

### å•é¡Œ 2: AKS Pod ãŒ `ImagePullBackOff` çŠ¶æ…‹

**ã‚¨ãƒ©ãƒ¼ç¢ºèª**:

```powershell
kubectl describe pod <POD_NAME>
```

**è§£æ±ºç­–**:

1. ACR ã®ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ã‚’ç¢ºèª:

   ```powershell
   az acr login --name <ACR_NAME>
   ```

2. AKS ã¨ ACR ã®çµ±åˆã‚’å†è¨­å®š:

   ```powershell
   az aks update --resource-group $resourceGroup --name $aksClusterName --attach-acr <ACR_NAME>
   ```

### å•é¡Œ 3: Ingress ã® EXTERNAL-IP ãŒ `<pending>` ã®ã¾ã¾

**ç¢ºèª**:

```powershell
kubectl get services -n ingress-nginx
```

**è§£æ±ºç­–**:

1. Ingress Controller ãŒæ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
2. Azure Load Balancer ã®ä½œæˆã‚’å¾…ã¤ï¼ˆæœ€å¤§ 10 åˆ†ï¼‰
3. NSG ãƒ«ãƒ¼ãƒ«ã§ Port 80/443 ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### å•é¡Œ 4: MongoDB æ¥ç¶šã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°**:

```text
MongoNetworkError: connect ECONNREFUSED
```

**è§£æ±ºç­–**:

1. MongoDB VM ã® Private IP ãŒæ­£ã—ã„ã‹ç¢ºèª:

   ```powershell
   az vm list-ip-addresses --resource-group $resourceGroup --name <VM_NAME> --output table
   ```

2. Kubernetes Deployment ã®ç’°å¢ƒå¤‰æ•° `MONGO_URI` ã‚’æ›´æ–°
3. NSG ã§ Port 27017 ãŒ AKS Subnet ã‹ã‚‰è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### å•é¡Œ 5: Azure Policy ã®ä¿®å¾©ã‚¿ã‚¹ã‚¯ãŒå¤±æ•—

**è§£æ±ºç­–**:

1. Policy ã®ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã« Contributor ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸:

   ```powershell
   $principalId = az policy assignment show --name <ASSIGNMENT_NAME> --query identity.principalId -o tsv
   az role assignment create --assignee $principalId --role Contributor --scope /subscriptions/<SUBSCRIPTION_ID>
   ```

---

## ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤

```powershell
# ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ï¼ˆã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã‚‹ï¼‰
az group delete --name rg-bbs-cicd-aks --yes --no-wait

# Microsoft Entra ã‚¢ãƒ—ãƒª / ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®å‰Šé™¤ï¼ˆæ¼”ç¿’çµ‚äº†å¾Œã«ä¸è¦ãªå ´åˆã®ã¿ï¼‰
az ad app delete --id "<AZURE_CLIENT_ID>"

# ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ç”¨ã« JSON ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆã—ãŸå ´åˆã®ã¿ç‰‡ä»˜ã‘
if (Test-Path azure-credentials.json) {
  Remove-Item azure-credentials.json
}

# kubectl è¨­å®šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
kubectl config delete-context <AKS_CLUSTER_NAME>
```

### å€‹åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```powershell
# AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã¿å‰Šé™¤
az aks delete --resource-group rg-bbs-cicd-aks --name <AKS_NAME> --yes --no-wait

# VM ã®ã¿å‰Šé™¤
az vm delete --resource-group rg-bbs-cicd-aks --name <VM_NAME> --yes --no-wait

# Storage Account ã®ã¿å‰Šé™¤
az storage account delete --name <STORAGE_NAME> --yes
```

---

## ğŸ“š å‚è€ƒè³‡æ–™

### Azure å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Azure Kubernetes Service (AKS) ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/aks/)
- [Azure Container Registry ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/container-registry/)
- [Azure Bicep ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/)
- [Azure Policy ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/governance/policy/)
- [GitHub Actions for Azure](https://learn.microsoft.com/ja-jp/azure/developer/github/github-actions)

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- [Microsoft Cloud Security Benchmark](https://learn.microsoft.com/ja-jp/security/benchmark/azure/)
- [AKS ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://learn.microsoft.com/ja-jp/azure/aks/concepts-security)
- [Kubernetes RBAC ã®æ¨å¥¨è¨­å®š](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)

### ãƒ„ãƒ¼ãƒ«

- [kubectl ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ](https://kubernetes.io/ja/docs/reference/kubectl/cheatsheet/)
- [Azure CLI ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://learn.microsoft.com/ja-jp/cli/azure/)
- [Trivy å…¬å¼ã‚µã‚¤ãƒˆ](https://aquasecurity.github.io/trivy/)

---

## ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ [MIT License](LICENSE) ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ã‚¤ã‚·ãƒ¥ãƒ¼ã®å ±å‘Šã‚’æ­“è¿ã—ã¾ã™ï¼ä»¥ä¸‹ã®æ‰‹é †ã§ã”å”åŠ›ãã ã•ã„ï¼š

1. ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ•ã‚©ãƒ¼ã‚¯
2. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ (`git checkout -b feature/awesome-feature`)
3. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ (`git commit -m 'Add awesome feature'`)
4. ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ (`git push origin feature/awesome-feature`)
5. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ

---

## ğŸ“§ ãŠå•ã„åˆã‚ã›

ã”è³ªå•ã‚„å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€GitHub Issues ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚

---

Happy Coding! ğŸ‰
