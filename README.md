# ğŸ§™â€â™‚ï¸ CICD-AKS-Technical Exercise

ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### æ§‹æˆè¦ç´ 

- **AKS (Azure Kubernetes Service)** - ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã•ã‚ŒãŸ BBS App
- **VM (MongoDB)** - Ubuntu 20.04 + MongoDB 4.4 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **ACR (Azure Container Registry)** - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ã‚¸ã‚¹ãƒˆãƒª
- **Storage Account** - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ Blob Storage
- **Azure Monitor** - ç›£æŸ»ãƒ­ã‚°åé›†

### æ„å›³çš„ãªè„†å¼±æ€§

1. **AKS**: Cluster Admin æ¨©é™ã®ä¸é©åˆ‡ãªä»˜ä¸
2. **VM**: SSH Port 22 ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå…¬é–‹ã€å¤ã„ OS (Ubuntu 20.04)
3. **MongoDB**: èªè¨¼ãªã—ã€å…¨ IP ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (4.4)
4. **Storage**: Public Blob Access æœ‰åŠ¹

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Azure Subscription                         â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Resource Group: rg-cicd-aks                     â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  VNet: vnet-wiz-dev (10.0.0.0/16)                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Subnet: aks-subnet (10.0.1.0/24)    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                       â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  AKS: aks-wiz-dev           â”‚    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ Node Pool: 2 nodes      â”‚    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  Standard_DS2_v2          â”‚    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ Pod: guestbook-app (Ã—2) â”‚    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ Service: LoadBalancer   â”‚â—„â”€â”€â”€â”¼â”€â”€â”€ External IP
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Subnet: mongo-subnet (10.0.2.0/24)  â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                       â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  VM: vm-mongo-dev           â”‚    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ Ubuntu 20.04 LTS        â”‚    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ MongoDB 4.4              â”‚â—„â”€â”€â”€â”¼â”€â”€â”€ AKS Pods
â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ Port 27017 (å…¨é–‹æ”¾)     â”‚    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ Port 22 (SSHå…¬é–‹) âš ï¸    â”‚â—„â”€â”€â”€â”¼â”€â”€â”€ Internet
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  ACR: acrwizdev[hash] (Premium/Basic)                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ guestbook:latest                                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚             â–²                                                â”‚   â”‚
â”‚  â”‚             â”‚ AcrPull Role                                  â”‚   â”‚
â”‚  â”‚             â”‚                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Storage: stwizdev[hash]                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ Container: backups                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Public Blob Access: Enabled âš ï¸                   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚             â–²                                                â”‚   â”‚
â”‚  â”‚             â”‚ Daily Backup (cron 2:00 AM JST)               â”‚   â”‚
â”‚  â”‚             â”‚                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Log Analytics: log-wiz-dev                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ AKS Audit Logs                                   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CI/CD ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GitHub Repository                            â”‚
â”‚                     (aktsmm/CICD-AKS-technical-exercise)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    git push (infra/** or app/**)
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GitHub Actions                              â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Workflow 1: Deploy Infrastructure                        â”‚    â”‚
â”‚  â”‚  Trigger: infra/** changes                                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  1. Checkov Scan (IaC Security)                     â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â””â”€ Check Bicep templates                        â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  2. Deploy Azure Resources (Bicep)                  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ VNet + Subnets                               â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ AKS Cluster                                  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ ACR (with unique suffix)                     â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ MongoDB VM + Managed Identity                â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ Storage Account                              â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ Log Analytics                                â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ NSG (SSH + MongoDB public) âš ï¸                â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â””â”€ RBAC (Vulnerable ClusterAdmin) âš ï¸            â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  3. Wait for AKS Provisioning                       â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â””â”€ Poll every 30s (max 15min)                   â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  4. Save Outputs as Artifacts                       â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ AKS_CLUSTER_NAME                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â”œâ”€ ACR_NAME                                     â”‚  â”‚    â”‚
â”‚  â”‚  â”‚     â””â”€ MONGO_VM_IP                                  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚                               â”‚
â”‚                   workflow_run trigger (on success)             â”‚
â”‚                                  â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Workflow 2: Build and Deploy Application                 â”‚  â”‚
â”‚  â”‚  Trigger: app/** changes OR infra success                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  1. Check Resource Group Existence                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€ Fail early if RG not found                   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  2. Trivy Container Scan                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€ Scan for CVEs (CRITICAL/HIGH)                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  3. Build & Push Docker Image                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€ Build: guestbook:${GITHUB_SHA}               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€ Push to ACR                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€ Tag as :latest                               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  4. Deploy to AKS                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€ kubectl apply -f k8s/rbac-vulnerable.yaml âš ï¸ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€ kubectl apply -f k8s/deployment.yaml         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”œâ”€ kubectl apply -f k8s/service.yaml            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€ Update image: ACR/guestbook:${GITHUB_SHA}    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Deployed Application                             â”‚
â”‚                                                                      â”‚
â”‚  Browser â†’ http://<EXTERNAL_IP> â†’ LoadBalancer                     â”‚
â”‚                                        â””â”€ AKS Pods (guestbook-app)  â”‚
â”‚                                               â””â”€ MongoDB VM          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Code Commit â†’ GitHub Actions                                   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Checkov (IaC)    â”‚      â”‚  Trivy (Container)â”‚             â”‚
â”‚  â”‚  â”œâ”€ Bicep Scan    â”‚      â”‚  â”œâ”€ Image Scan    â”‚             â”‚
â”‚  â”‚  â””â”€ Misconfig     â”‚      â”‚  â””â”€ CVE Detection â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â”‚                           â”‚                         â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                       â–¼                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚  SARIF Upload   â”‚                                â”‚
â”‚              â”‚  to GitHub      â”‚                                â”‚
â”‚              â”‚  Security Tab   â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### å‰ææ¡ä»¶

- Azure CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- Azure ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
- GitHub ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- kubectl, docker ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿

### 1ï¸âƒ£ Azure èªè¨¼

```powershell
az login
az account set --subscription "<YOUR_SUBSCRIPTION_ID>"
```

### 2ï¸âƒ£ ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ä½œæˆ

```powershell
az ad sp create-for-rbac `
  --name "sp-wiz-exercise" `
  --role contributor `
  --scopes /subscriptions/<YOUR_SUBSCRIPTION_ID> `
  --sdk-auth > azure-credentials.json
```

### 3ï¸âƒ£ ACR ä½œæˆï¼ˆæ‰‹å‹•ã€å¿…é ˆï¼‰

```powershell
az group create --name rg-cicd-bbs2 --location japaneast
az acr create `
  --resource-group rg-cicd-bbs2 `
  --name acrwizexercise `
  --sku Basic
```

### 4ï¸âƒ£ GitHub ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š

GitHub Repository Settings > Secrets and variables > Actions

- `AZURE_CREDENTIALS`: azure-credentials.json ã®å†…å®¹
- `AZURE_SUBSCRIPTION_ID`: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID
- `MONGO_ADMIN_PASSWORD`: MongoDB ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

### 5ï¸âƒ£ ãƒ‡ãƒ—ãƒ­ã‚¤

```powershell
git init
git add .
git commit -m "Initial commit: CICD-AKS-Technical Exercise"
git branch -M main
git remote add origin https://github.com/<YOUR_USERNAME>/wiz-technical-exercise.git
git push -u origin main
```

GitHub Actions ãŒè‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™ã€‚

## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
wiz-technical-exercise/
â”œâ”€â”€ app/                          # Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ app.js                   # Express.jsã‚µãƒ¼ãƒãƒ¼
â”‚   â”œâ”€â”€ Dockerfile               # ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸å®šç¾©
â”‚   â”œâ”€â”€ package.json             # ä¾å­˜é–¢ä¿‚
â”‚   â”œâ”€â”€ wizexercise.txt          # ãƒ‡ãƒ¢ç”¨ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ views/                   # EJSãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”‚   â””â”€â”€ index.ejs           # æ²ç¤ºæ¿UI
â”‚   â””â”€â”€ k8s/                     # Kubernetesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
â”‚       â”œâ”€â”€ deployment.yaml      # ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤
â”‚       â”œâ”€â”€ service.yaml         # LoadBalancer Service
â”‚       â”œâ”€â”€ ingress.yaml         # Ingress (App Gateway)
â”‚       â”œâ”€â”€ ingress-nginx.yaml   # Ingress (NGINXä»£æ›¿)
â”‚       â””â”€â”€ rbac-vulnerable.yaml # è„†å¼±ãªRBACè¨­å®š
â”œâ”€â”€ infra/                       # Infrastructure as Code (Bicep)
â”‚   â”œâ”€â”€ main.bicep              # ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ parameters.json         # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆæœªä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ scripts/                # VMã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â””â”€â”€ install-mongodb.sh  # MongoDB 4.4ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
â”‚   â””â”€â”€ modules/                # Bicepãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚       â”œâ”€â”€ aks.bicep           # AKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼
â”‚       â”œâ”€â”€ acr.bicep           # Azure Container Registry
â”‚       â”œâ”€â”€ aks-acr-role.bicep  # AKS-ACRèªè¨¼è¨­å®š
â”‚       â”œâ”€â”€ vm-mongodb.bicep    # MongoDB VM
â”‚       â”œâ”€â”€ vm-role-assignment.bicep  # VM Managed Identity
â”‚       â”œâ”€â”€ vm-storage-role.bicep     # VMã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ¨©é™
â”‚       â”œâ”€â”€ storage.bicep       # Storage Account
â”‚       â”œâ”€â”€ networking.bicep    # VNet/Subnet
â”‚       â””â”€â”€ monitoring.bicep    # Log Analytics
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/              # GitHub Actions
â”‚       â”œâ”€â”€ infra-deploy.yml   # ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤
â”‚       â”œâ”€â”€ app-deploy.yml     # ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤
â”‚       â””â”€â”€ cleanup.yml        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å±¥æ­´ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
â”œâ”€â”€ pipelines/                  # Azure Pipelinesï¼ˆä»£æ›¿CI/CDï¼‰
â”‚   â”œâ”€â”€ azure-pipelines-infra.yml
â”‚   â””â”€â”€ azure-pipelines-app.yml
â”œâ”€â”€ docs/                       # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ ENVIRONMENT_INFO.md    # ç’°å¢ƒæƒ…å ±
â”‚   â”œâ”€â”€ AZURE_SETUP_INFO.md    # Azureã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
â”‚   â””â”€â”€ MICROSOFT_DOCS_VALIDATION.md
â”œâ”€â”€ Docs_issue_point/          # ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¥æ­´
â”‚   â”œâ”€â”€ Phase02_ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤å•é¡Œã¨è§£æ±º_2025-10-29.md
â”‚   â”œâ”€â”€ Phase03_kubectlç’°å¢ƒè¨­å®š_2025-10-29.md
â”‚   â”œâ”€â”€ Phase04_MongoDBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè£…_2025-10-29.md
â”‚   â”œâ”€â”€ Phase06_ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾å­˜é–¢ä¿‚å®Ÿè£…_2025-10-29.md
â”‚   â”œâ”€â”€ Phase07_AKS-ACRèªè¨¼ã‚¨ãƒ©ãƒ¼è§£æ±º_2025-10-29.md
â”‚   â”œâ”€â”€ Phase08_AKSãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å¾…æ©Ÿå®Ÿè£…_2025-10-29.md
â”‚   â”œâ”€â”€ Phase09_MongoDB4.4ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿®æ­£_2025-10-29.md
â”‚   â”œâ”€â”€ Phase10_ACRåå‰è¡çªè§£æ±º_2025-10-29.md
â”‚   â””â”€â”€ Phase11_å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹è¨­å®š_2025-10-30.md
â””â”€â”€ Docs_work_history/         # ä½œæ¥­å±¥æ­´

```

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼

### è„†å¼±æ€§ç¢ºèª

```powershell
# Storage Public Access
$STORAGE_NAME = "<storage-name>"
az storage account show `
  --name $STORAGE_NAME `
  --query allowBlobPublicAccess

# SSHå…¬é–‹ç¢ºèª
$NSG_NAME = "vm-mongo-dev-nsg"
az network nsg rule show `
  --resource-group rg-cicd-bbs2 `
  --nsg-name $NSG_NAME `
  --name Allow-SSH-Internet

# Kubernetes RBAC
kubectl get clusterrolebindings developer-cluster-admin -o yaml
```

## ğŸ“Š ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚»ã‚¹

### Ingress IP ã®å–å¾—

```powershell
kubectl get ingress guestbook-ingress
# ã¾ãŸã¯
kubectl get svc -n ingress-nginx  # NGINXä½¿ç”¨æ™‚
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹: `http://<INGRESS_IP>`

### wizexercise.txt ç¢ºèª

```powershell
# WebçµŒç”±
curl http://<INGRESS_IP>/wizfile

# Podå†…
$POD_NAME = kubectl get pods -l app=guestbook -o jsonpath='{.items[0].metadata.name}'
kubectl exec $POD_NAME -- cat /app/wizexercise.txt
```

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Ingress ãŒå‹•ä½œã—ãªã„

```powershell
# NGINX Ingress Controller ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml

# NGINXç‰ˆIngressã«åˆ‡ã‚Šæ›¿ãˆ
kubectl delete ingress guestbook-ingress
kubectl apply -f app/k8s/ingress-nginx.yaml
```

### MongoDB ã«æ¥ç¶šã§ããªã„

```powershell
# VM IPã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª
az vm show `
  -g rg-cicd-bbs2 `
  -n vm-mongo-dev `
  --show-details `
  --query publicIps -o tsv

# Deploymentã®ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
kubectl set env deployment/guestbook-app MONGO_URI="mongodb://<MONGO_IP>:27017/guestbook"
```

## ğŸ§¹ ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤

```powershell
# ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
az group delete --name rg-cicd-bbs2 --yes --no-wait

# ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«å‰Šé™¤
$SP_ID = az ad sp list --display-name "sp-wiz-exercise" --query "[0].appId" -o tsv
az ad sp delete --id $SP_ID
```

## ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ CICD-AKS-Technical Exercise ã®ãƒ‡ãƒ¢ç”¨ã§ã™ã€‚
