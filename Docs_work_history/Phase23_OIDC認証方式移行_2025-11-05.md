# Phase23 OIDC 認証方式への移行 (2025-11-05)

## 背景

- 従来は GitHub Actions から Azure へ Service Principal (クライアントシークレット) を用いてログインしていた。
- セキュリティ向上とシークレット管理削減のため、GitHub OIDC ワークロード ID フェデレーションへ移行する方針を決定。

## 実施ステップ

1. **Azure AD アプリ `gh-aks-oidc` の確認**

   - 既存 Service Principal を流用し、`Contributor` ロールをサブスクリプションに付与済みであることを確認。
   - 今後の RBAC 追加に備え `User Access Administrator` ロール付与を検討。

2. **フェデレーションクレデンシャル登録**

   - main ブランチ: `repo:aktsmm/CICD-AKS-technical-exercise:ref:refs/heads/main`
   - 環境 `aks-demo`: `repo:aktsmm/CICD-AKS-technical-exercise:environment:aks-demo`
   - `az ad app federated-credential create` を PowerShell で実行し、JSON を一時ファイルに格納して登録。

3. **GitHub Secrets/Variables 更新**

   - 必要秘密情報を `AZURE_CLIENT_ID` / `AZURE_TENANT_ID` / `AZURE_SUBSCRIPTION_ID` に集約。
   - 旧 `AZURE_CREDENTIALS` (Service Principal JSON) を廃止。

4. **ワークフロー修正**

   - `azure/login@v1` ステップを OIDC ログイン用パラメータへ変更。
   - `.github/workflows/infra-deploy.yml` で配下のロール付与モジュールを削除し、デプロイ後に Azure CLI で RBAC を割り当てるステップを追加。
   - 依存ワークフロー名を番号付き名称に合わせて更新。

5. **検証**
   - `1. Deploy Infrastructure` → `2-1. Build and Deploy Application` の連鎖を実行し、OIDC ログイン成功と RBAC 付与を確認。
   - 環境ランで `AADSTS700213` が発生したため、`Phase29` に従って環境 subject 用フェデレーションクレデンシャルを追加し解決。

## 今後のタスク

- 環境追加時に subject を棚卸しして必要なフェデレーションクレデンシャルを漏れなく登録する仕組みを整備。
- RBAC 自動付与のためにアプリへ `User Access Administrator` 等を付与するか、権限チェックステップを追加する。
- 公式ドキュメント: [Workload identity federation for GitHub Actions](https://learn.microsoft.com/entra/workload-id/workload-identity-federation#creating-federated-credentials-for-github-actions) を継続的に参照。
