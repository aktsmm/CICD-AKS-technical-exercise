# Phase 1: 環境準備 - 作業履歴

**作業日**: 2025 年 1 月 29 日  
**担当者**: aktsmm  
**フェーズ**: Phase 1 - 環境準備・Azure サブスクリプション切り替え

---

## 📋 作業概要

Azure サブスクリプションを "hinokuni-sub" から "Visual Studio Enterprise (個人検証サブスクリプション)" に切り替え、GitHub Actions 用の Service Principal を新規作成しました。

---

## 🎯 作業目標

- [x] Azure サブスクリプション切り替え
- [x] 新サブスクリプション用 Service Principal 作成
- [x] GitHub Secrets 更新準備
- [ ] GitHub Secrets 更新実施 (次フェーズ)
- [ ] インフラデプロイ再実行 (次フェーズ)

---

## 🔧 実施した作業内容

### 1. Azure サブスクリプション切り替え

**実行コマンド**:

```powershell
az account set --subscription "832c4080-181c-476b-9db0-b3ce9596d40a"
az account show --query "{Name:name, SubscriptionId:id, TenantId:tenantId}" -o table
```

**実行結果**:

```
Name                      SubscriptionId                        TenantId
------------------------  ------------------------------------  ------------------------------------
Visual Studio Enterprise  832c4080-181c-476b-9db0-b3ce9596d40a  04879edd-d806-4f5d-86b8-d3a171c883fa
```

**切り替え理由**:

- 旧サブスクリプション (hinokuni-sub) で Storage Account デプロイ時にポリシー制約エラー発生
- エラー内容: "PublicAcces..." (PublicAccessNotPermitted と推定)
- 個人検証用サブスクリプションでは制約が緩いため切り替えを決定

---

### 2. Service Principal 作成

**実行コマンド**:

```powershell
az ad sp create-for-rbac `
  --name "sp-wiz-exercise-github-vspro" `
  --role Contributor `
  --scopes /subscriptions/832c4080-181c-476b-9db0-b3ce9596d40a `
  --sdk-auth
```

**実行時刻**: 2025 年 1 月 29 日 (正確な時刻は端末ログ参照)

**Service Principal 情報** (Docs_Secrets に詳細記載):

- Service Principal Name: `sp-wiz-exercise-github-vspro`
- Role: `Contributor`
- Scope: `/subscriptions/832c4080-181c-476b-9db0-b3ce9596d40a`
- Client ID: `a2854234-bf5d-4695-ab5a-e15efb9a1cbf`
- Tenant ID: `04879edd-d806-4f5d-86b8-d3a171c883fa`

⚠️ **警告メッセージ**:

```
Option '--sdk-auth' has been deprecated and will be removed in a future release.
```

**対応メモ**:

- 現時点では --sdk-auth が GitHub Actions の azure/login@v1 で必要
- 将来的には Federated Identity への移行を検討

---

## 📊 変更前後の比較

| 項目                  | 変更前                               | 変更後                               |
| --------------------- | ------------------------------------ | ------------------------------------ |
| サブスクリプション名  | hinokuni-sub                         | Visual Studio Enterprise             |
| サブスクリプション ID | 7134d7ae-2fe3-4eec-8f0b-5ffad8355907 | 832c4080-181c-476b-9db0-b3ce9596d40a |
| テナント ID           | 04879edd-d806-4f5d-86b8-d3a171c883fa | 04879edd-d806-4f5d-86b8-d3a171c883fa |
| Service Principal     | sp-wiz-exercise-github (推定)        | sp-wiz-exercise-github-vspro         |
| リソースグループ      | rg-cicd-aks-bbs-01                   | rg-cicd-aks-bbs-01 (同じ)            |
| リージョン            | Japan East                           | Japan East (同じ)                    |

---

## 🔄 次のフェーズへの引き継ぎ事項

### Phase 2 で実施予定:

1. **GitHub Secrets 更新**

   - `AZURE_CREDENTIALS` の更新
   - `AZURE_SUBSCRIPTION_ID` の更新
   - `MONGO_ADMIN_PASSWORD` の確認

2. **インフラデプロイ再実行**

   - GitHub Actions "Deploy Infrastructure" ワークフロー手動実行
   - 全リソース (Storage Account 含む) のデプロイ成功確認

3. **デプロイ検証**
   - リソースグループ内のリソース一覧確認
   - AKS クラスター接続確認
   - MongoDB VM 接続確認

---

## 📝 参考情報

### 使用したドキュメント

- [Azure CLI - az account set](https://learn.microsoft.com/ja-jp/cli/azure/account?view=azure-cli-latest#az-account-set)
- [Azure CLI - az ad sp create-for-rbac](https://learn.microsoft.com/ja-jp/cli/azure/ad/sp?view=azure-cli-latest#az-ad-sp-create-for-rbac)
- [GitHub Actions - azure/login](https://github.com/Azure/login)

### 関連ファイル

- `.github/workflows/infra-deploy.yml` - インフラデプロイワークフロー
- `infra/main.bicep` - メイン Bicep テンプレート
- `Docs_Secrets/Phase01_Azure_ServicePrincipal.md` - Service Principal 詳細情報

---

## ✅ 作業完了チェックリスト

- [x] Azure サブスクリプション切り替え実施
- [x] サブスクリプション情報確認 (az account show)
- [x] Service Principal 作成実施
- [x] Service Principal 情報の記録 (Docs_Secrets)
- [x] 作業履歴ドキュメント作成
- [ ] GitHub Secrets 更新 (Phase 2)
- [ ] インフラデプロイ再実行 (Phase 2)

---

**作業終了時刻**: (記録予定)  
**次回作業開始予定**: GitHub Secrets 更新後すぐ
