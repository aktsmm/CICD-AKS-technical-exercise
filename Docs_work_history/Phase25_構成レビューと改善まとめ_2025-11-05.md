# Phase25: 構成レビューと改善まとめ

**作成日**: 2025-11-05  
**担当**: yamapan  
**関連リポジトリ**: CICD-AKS-technical-exercise (main)

---

## 背景

- Docs/CheckList_backup_update.txt の「構成」項目 (No.5-10) に対する検証結果を整理。
- GitHub Actions と IaC 周りで断続的に発生した課題を振り返り、対応策を履歴として残す。
- v1.0.2 以降のコミットでバックアップ自動化・RBAC 付与・OIDC 移行など大規模な調整を実施。

---

## タイムライン (抜粋)

| 日付       | コミット/タグ | 内容                                                  | 影響領域       |
| ---------- | ------------- | ----------------------------------------------------- | -------------- |
| 2025-10-29 | 1b90090       | ロール割り当てをワークフローに移動し AKS を Public 化 | RBAC, AKS      |
| 2025-10-30 | 2208485       | バックアップワークフローで VM 存在チェックを追加      | GitHub Actions |
| 2025-10-31 | 31a37cf       | バックアップサマリーに SAS ダウンロード URL を表示    | レポーティング |
| 2025-11-03 | 2203840       | OIDC 認証エラーのドキュメント補完                     | ドキュメント   |
| 2025-11-05 | 324bbe8       | 構成チェック結果をドキュメント化                      | Docs           |
| 2025-11-05 | 5a4d319       | バックアップスケジュールの YAML を整形                | GitHub Actions |
| 2025-11-05 | v1.0.3        | 上記一連の改善をタグ付け                              | リリース管理   |

---

## 苦慮したポイントと改善策サマリ

| 苦慮点                                 | 発生事象                                                        | 対応コミット               | 改善内容                                                                 | 実務ヒント                                                              |
| -------------------------------------- | --------------------------------------------------------------- | -------------------------- | ------------------------------------------------------------------------ | ----------------------------------------------------------------------- |
| GitHub Actions での RBAC 付与エラー    | 既存 Owner 割り当てと衝突し `RoleAssignmentExists` エラーが頻発 | 2de32f0, 9bd6b26, 876eb04  | 事前に所有権をチェックし、必要時のみ Owner を付与。RG 作成フローを追加。 | ワークフロー前段で `az role assignment list` による存在確認を必ず挿入。 |
| Mongo バックアップ自動化の信頼性       | `az vm run-command` 出力に不要ログが混在しパースに失敗          | e435183, af4e430, c814543  | `awk`/`grep` で stdout 区画を抽出し、エラー時は非ゼロ終了とした。        | 取得ログは Step Summary に加工後掲載するとレビューしやすい。            |
| デプロイサマリーの可視性不足           | HTTP エンドポイントの取得失敗や情報欠落                         | 3c98195, d810467, dd6b5cb  | Public IP を ARM 経由で取得、HTTP/HTTPS 両方の URL を提示。              | `az network public-ip show` など冗長経路を用意してフォールバック。      |
| Workflow 版数の追従                    | 古いアクションバージョンが残存しセキュリティ警告                | 67d72c7, 86f13f3           | v3/v4 への更新と不要ステップ整理。                                       | Dependabot や Renovate をパイプライン用に有効化。                       |
| OIDC への移行時トラブル                | Federated Credentials 設定不足によりログイン不可                | c19658a, 2203840, 23e 情報 | ドキュメント整備と Vars/Secrets 見直しで手順を明文化。                   | `az ad app federated-credential create` をサンプル付きでガイドする。    |
| Cleanup ワークフローのリテンション調整 | 実行履歴が大量に残り GitHub UI が煩雑化                         | 2807b5c, 2208485, b6343cd  | 人手/Dependabot/失敗を件数指定で保持し、それ以外を削除。                 | `gh run list` と `jq` を組み合わせたバッチ処理をテンプレート化。        |
| AKS/VM コンポーネントの連携証跡        | Secret 化やクラスタ構築手順が断片化                             | 324bbe8                    | CheckList の No.5-10 を網羅的にドキュメント化。                          | 構成レビュー結果を Docs_work_history に残し、次期改善の土台にする。     |

---

## 詳細調査メモ

### 1. RBAC 付与時の `RoleAssignmentExists` エラー

- **発生状況**: `.github/workflows/infra-deploy.yml` の `Assign RBAC Role Bindings` ステップで Owner を追加しようとすると既存割り当てと衝突し失敗。ログ例:

  ```text
  (RoleAssignmentExists) The role assignment already exists.
  ```

- **解析**: `az role assignment create` は冪等性を持たないため、事前に `az role assignment list --assignee-object-id <PRINCIPAL> --role <ROLE> --scope <SCOPE>` を実行し存在判定が必要。コミット `2de32f0` で RG 作成フェーズを導入し、`9bd6b26` では Owner 付与可否を環境変数 `GRANT_OWNER_PARAMETER` に反映。最終的に `876eb04` で `assign_role()` ヘルパーを追加し idempotent なロジックを確立。
- **改善結果**: GitHub Actions のロール割り当て失敗が解消され、再実行時も安全に適用可能。
- **実務 Tip**: RBAC 操作前に存在チェックメッセージを Step Summary に残すと、監査時に「重複検出済み」であることを説明しやすい。

### 2. Mongo バックアップログの整形とエラー検知

- **発生状況**: バックアップワークフロー `.github/workflows/backup-schedule.yml` で `az vm run-command invoke` 結果が `[stdout]` / `[stderr]` に混在し、SAS URL が抽出できない。
- **解析**: コミット `e435183` で `list_payload()` を新設。`awk '/[stdout]/'` と `sed '/^$/d'` を併用し不要行を除去し、`af4e430` で `set -euo pipefail` を追加。`c814543` では `printf '%s\n' "$OUTPUT"` 形式に統一してログ構造を安定化。
- **改善結果**: Step Summary から常に最新バックアップのファイルサイズと SAS URL を取得でき、失敗時は GitHub Actions が即時にエラー終了。
- **実務 Tip**: 長期運用では `az vm run-command` の代わりに Azure Automation + Runbook に移行し、Log Analytics へ成功/失敗ログを送信すると追跡が容易。

### 3. デプロイ後の公開 URL 取得

- **発生状況**: AKS デプロイ後、Ingress の外部 IP が `pending` のままで Step Summary が空欄。
- **解析**: コミット `d810467` で ARM Public IP からの再取得ロジックを追加し、`3c98195` で HTTP/HTTPS 両方の URL を表示。`dd6b5cb` では結果が存在しない場合でも「取得できませんでした」と明示するガードを追加。
- **改善結果**: 外部公開 URL の取得率が安定し、検証手順書に貼り付けるだけでアクセス確認が可能。
- **実務 Tip**: Ingress の監視には `kubectl wait --for=condition=ready pod -n ingress-nginx` と ARM API の双方を採用する二段構えが有効。

### 4. GitHub Actions バージョン整備

- **発生状況**: GitHub から旧バージョン使用の警告が届き、Security タブにアラートが蓄積。
- **解析**: コミット `67d72c7` で `actions/upload-artifact@v4` へ更新し、`86f13f3` で不要な手順を削除。`Docs_issue_point/Phase22_CodeQL統合とnpmロック整合_2025-11-03.md` に詳細が記録されている。
- **改善結果**: コードスキャンの互換性が維持され、将来の GitHub 仕様変更に追従しやすい基盤を確立。
- **実務 Tip**: `.github/dependabot.yml` に `package-ecosystem: "github-actions"` を追加するとアクション更新が自動提案される。

### 5. OIDC 移行時の Federated Credentials 不足

- **発生状況**: GitHub Actions から Azure への OIDC ログインが `AADSTS7000215` で失敗。`Docs_issue_point/Phase23_OIDC認証方式移行_2025-11-05.md` 参照。
- **解析**: Azure AD 側で GitHub Actions 用 Federated Credential を作成していなかった。コミット `2203840` で `az ad app federated-credential create` の例を追加し、`c19658a` で Secrets/Variables の整理手順を補強。
- **改善結果**: Secrets からクライアントシークレットを除外でき、Azure ベストプラクティスへ準拠。
- **実務 Tip**: Federated Credential 定義 JSON には `issuer`, `subject`, `audience` を明示し、環境ごとにファイルを分けると管理しやすい。

### 6. Cleanup ワークフローのリテンション整備

- **発生状況**: Cleanup ワークフロー自体が蓄積し、GitHub UI で履歴が埋まる。
- **解析**: `2807b5c` で `gh api repos/$REPO/actions/runs --paginate` を用いた JSON 取得を実装し、`jq` で保持件数を制御。`b6343cd` では Workflow 名を `GITHUB_WORKFLOW` と同期させ、Rename 時も動作するよう調整。
- **改善結果**: 最新 7 件 (人手) + 3 件 (Dependabot) + 1 件 (失敗) だけを保持するルールが確立。
- **実務 Tip**: 削除前に `echo "🧹 Deleting run $ID"` のような操作ログを出力しておくと、万一の誤削除時に追跡できる。

### 7. AKS/VM 連携証跡の整理

- **発生状況**: MongoDB 認証やバックアップの設定が散逸し、レビュー時に根拠ファイルの提示が難しい。
- **解析**: `docs/CheckList_backup_update_20251105_review.txt` で No.5-10 の要件と実装ファイルを照合。`infra/main.bicep` で診断設定 (`Microsoft.Insights/diagnosticSettings`) がサブスクリプション Activity Log を Log Analytics へ送っていることを確認（公式解説: #microsoft.docs.mcp [Azure Monitor Activity Log](https://learn.microsoft.com/azure/azure-monitor/essentials/activity-log)）。
- **改善結果**: Docs_work_history に構成レビューの記録を追加し、プレゼン資料や監査対応のベースが整った。
- **実務 Tip**: チェックリスト要件ごとに「証跡候補」をスクリーンショットや CLI 出力で収集すると、将来の監査に流用できる。

---

## 改善で得られた知見

1. **Workflow 出力は人間レビュー前提で整形する**
   - `GITHUB_STEP_SUMMARY` を積極活用し、SAS URL などは Markdown 形式で提示すると監査が容易。
2. **RBAC や Policy は Idempotency を最優先**
   - Owner/Contributor の重複割り当てを防ぐため、常に事前チェック関数を共通化。
3. **デプロイ情報は Fallback ルートを複数用意**
   - `kubectl` 依存の情報取得は失敗時に Azure REST/API へ切り替えると信頼性が向上。
4. **バックアップログは取り逃さない仕組みを作る**
   - `tail` 取得やファイル一覧の整形出力を取り入れることで、運用側の確認負担を軽減。
5. **タグ付けのタイミングでレビューを習慣化**
   - v1.0.3 では CheckList の検証結果を同時にまとめ、タグコメントに要約を残した。

---

## Next Action

- AKS API サーバーのアクセス制御 (Private Cluster / Authorized IP) を再検討する。
- アプリ Workflow に `npm run lint` を追加し、CI で静的解析をブロックする。
- バックアップ/Defender ログを Log Analytics ワークブックで可視化し、プレゼン資料向けの証跡を拡充する。
- デプロイ通知を PR コメントや Teams/Slack に連携させ、実運用に近い体制を整える。

---

## 参考コミット

- `324bbe8` 構成チェック結果を Docs 化。
- `5a4d319` バックアップスケジュール YAML の整形。
- `af4e430`, `c814543`, `e435183` Mongo バックアップログの整備。
- `2de32f0`, `9bd6b26`, `876eb04` RBAC 付与フローの再設計。
- `2203840`, `c19658a` OIDC 認証方式のドキュメント化。
- `2807b5c`, `b6343cd`, `78d276f` Cleanup ワークフローの保守。
