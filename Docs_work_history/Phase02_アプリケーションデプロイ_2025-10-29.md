# Phase 02: アプリケーションデプロイ - 作業履歴

**日付**: 2025 年 10 月 29 日  
**フェーズ**: アプリケーションのコンテナ化と AKS へのデプロイ

---

## 📋 作業概要

1. Azure Container Registry (ACR) の作成
2. Docker イメージのビルド＆プッシュ
3. Kubernetes マニフェストの作成・修正
4. AKS へのアプリケーションデプロイ
5. Ingress + Azure LoadBalancer 構成の実装

---

## 🎯 実施内容

### 1. Azure Container Registry (ACR) 作成

```bash
az acr create \
  --resource-group rg-cicd-aks-bbs-01 \
  --name acrwizdev \
  --sku Basic \
  --location japaneast
```

**結果**:

- ACR 名: `acrwizdev`
- Login Server: `acrwizdev.azurecr.io`
- SKU: Basic
- 状態: Succeeded ✅

### 2. AKS と ACR の統合

```bash
az aks update \
  --resource-group rg-cicd-aks-bbs-01 \
  --name aks-wiz-dev \
  --attach-acr acrwizdev
```

**目的**: AKS クラスターが ACR からイメージをプルできるように認証情報を自動設定

---

## 🐳 Docker イメージのビルド

### 問題 1: package.json に依存関係が未定義

**エラー内容**:

```
Error: Cannot find module 'express'
```

**原因**:

- `package.json` に `dependencies` セクションが存在しない
- `npm install` が何もインストールしなかった

**解決方法**:

`package.json` を修正:

```json
{
  "name": "wiz-technical-exercise-app",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "start": "node app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^7.6.3",
    "body-parser": "^1.20.2",
    "ejs": "^3.1.9"
  }
}
```

### イメージビルドのバージョン履歴

| バージョン     | 状態    | 備考                |
| -------------- | ------- | ------------------- |
| v1 (latest)    | ❌ 失敗 | 依存関係なし        |
| v2             | ❌ 失敗 | 依存関係なし        |
| v3             | ✅ 成功 | package.json 修正後 |
| v4             | ✅ 成功 | UI 更新版           |
| 動的タグ (SHA) | ✅ 成功 | CI/CD 自動化        |

**ビルドコマンド**:

```bash
az acr build \
  --registry acrwizdev \
  --image guestbook:v3 \
  --file Dockerfile \
  .
```

---

## ☸️ Kubernetes マニフェストのデプロイ

### 初期デプロイ (v3 イメージ)

**使用したマニフェスト**:

- `deployment.yaml`: アプリケーション本体
- `service.yaml`: LoadBalancer 型
- `rbac-vulnerable.yaml`: 脆弱な権限設定 (デモ用)

**デプロイコマンド**:

```bash
kubectl apply -f app/k8s/deployment.yaml
kubectl apply -f app/k8s/service.yaml
kubectl apply -f app/k8s/rbac-vulnerable.yaml
```

**デプロイ結果**:

```
NAME                             READY   STATUS    RESTARTS   AGE
guestbook-app-6b77f7fcbc-pw6kw   1/1     Running   0          10s
guestbook-app-6b77f7fcbc-sr7zj   1/1     Running   0          10s
```

**サービス公開**:

```
NAME                TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)
guestbook-service   LoadBalancer   10.1.112.47   4.189.34.65   80:32136/TCP
```

初期アクセス URL: `http://4.189.34.65`

---

## 🔄 CI/CD パイプラインの自動化

### GitHub Actions ワークフローの修正

**修正内容**:

1. ACR 名の修正: `acrwizexercise` → `acrwizdev`
2. Ingress デプロイの一時削除 (Application Gateway 未設定)
3. 動的イメージタグの実装

**ワークフロー構成**:

```yaml
jobs:
  scan-container:
    # Trivyによるコンテナスキャン

  build-push:
    # github.shaタグでイメージビルド&プッシュ
    outputs:
      image_tag: ${{ steps.image.outputs.tag }}

  deploy-aks:
    # 動的イメージタグでKubernetesにデプロイ
```

**実装した自動化**:

- ✅ `app/` ディレクトリの変更を検知
- ✅ コンテナイメージを自動ビルド (Commit SHA タグ)
- ✅ Trivy による脆弱性スキャン
- ✅ ACR への自動プッシュ
- ✅ AKS への自動デプロイ
- ✅ ローリングアップデート

---

## 🌐 Ingress + LoadBalancer 構成の実装

### 課題要件

> **「Ingress + CSP（Cloud Service Provider）のロードバランサで公開」**

### 初期状態の問題点

❌ LoadBalancer 型 Service で直接公開 (Ingress 未使用)  
❌ Application Gateway Ingress Controller が未インストール

### 解決方法: NGINX Ingress Controller の導入

**インストールコマンド**:

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml
```

**デプロイされたリソース**:

- Namespace: `ingress-nginx`
- Deployment: `ingress-nginx-controller`
- Service: `ingress-nginx-controller` (LoadBalancer 型)
- IngressClass: `nginx`

### マニフェスト修正

**Service 変更**:

```yaml
# Before
spec:
  type: LoadBalancer

# After
spec:
  type: ClusterIP
```

**Ingress 作成**:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: guestbook-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: guestbook-service
                port:
                  number: 80
```

### 最終構成

```
インターネット
    ↓
[Azure Load Balancer: 20.18.117.80] ← CSPのロードバランサ
    ↓
[NGINX Ingress Controller Pod]
    ↓
[Ingress リソース: guestbook-ingress]
    ↓
[ClusterIP Service: guestbook-service]
    ↓
[Application Pods: guestbook-app (2 replicas)]
```

**最終アクセス URL**: `http://20.18.117.80`

---

## 📊 デプロイ確認コマンド

### Ingress Controller 確認

```bash
kubectl get all -n ingress-nginx
kubectl get svc -n ingress-nginx
```

### アプリケーション確認

```bash
kubectl get pods -l app=guestbook
kubectl get svc guestbook-service
kubectl get ingress guestbook-ingress
```

### 動作確認

```bash
# HTTPアクセステスト
Invoke-WebRequest -Uri http://20.18.117.80 -UseBasicParsing

# ブラウザで開く
Start-Process "http://20.18.117.80"
```

---

## ✅ 達成事項まとめ

| 項目             | 状態 | 詳細                     |
| ---------------- | ---- | ------------------------ |
| ACR 作成         | ✅   | acrwizdev.azurecr.io     |
| イメージビルド   | ✅   | 複数バージョン対応       |
| AKS デプロイ     | ✅   | 2 レプリカで稼働         |
| CI/CD 自動化     | ✅   | GitHub Actions 完全統合  |
| Ingress 構成     | ✅   | NGINX + Azure LB         |
| 動的イメージタグ | ✅   | Commit SHA 使用          |
| 自動 UI 更新     | ✅   | コード変更で自動デプロイ |

---

## 🔐 セキュリティ考慮事項

### 実装済み

- ✅ コンテナイメージのスキャン (Trivy)
- ✅ ACR と AKS の統合 (Managed Identity)
- ✅ プライベートネットワーク内での Pod 配置
- ✅ MongoDB 認証の実装

### 意図的な脆弱性 (デモ用)

- ⚠️ クラスタ管理者権限の付与 (rbac-vulnerable.yaml)
- ⚠️ パブリックアクセス許可

---

## 📝 次のステップ

1. ✅ Ingress 構成の完了
2. ⏭️ セキュリティコントロールの追加実装
3. ⏭️ モニタリング・ログ収集の設定
4. ⏭️ プレゼンテーション資料の作成

---

**作成日**: 2025 年 10 月 29 日  
**最終更新**: 2025 年 10 月 29 日
