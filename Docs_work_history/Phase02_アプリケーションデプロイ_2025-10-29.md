# Phase 02: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ - ä½œæ¥­å±¥æ­´

**æ—¥ä»˜**: 2025å¹´10æœˆ29æ—¥  
**ãƒ•ã‚§ãƒ¼ã‚º**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã¨AKSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

---

## ğŸ“‹ ä½œæ¥­æ¦‚è¦

1. Azure Container Registry (ACR) ã®ä½œæˆ
2. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼†ãƒ—ãƒƒã‚·ãƒ¥
3. Kubernetesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ä½œæˆãƒ»ä¿®æ­£
4. AKSã¸ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
5. Ingress + Azure LoadBalanceræ§‹æˆã®å®Ÿè£…

---

## ğŸ¯ å®Ÿæ–½å†…å®¹

### 1. Azure Container Registry (ACR) ä½œæˆ

```bash
az acr create \
  --resource-group rg-wiz-exercise \
  --name acrwizdev \
  --sku Basic \
  --location japaneast
```

**çµæœ**:
- ACRå: `acrwizdev`
- Login Server: `acrwizdev.azurecr.io`
- SKU: Basic
- çŠ¶æ…‹: Succeeded âœ…

### 2. AKSã¨ACRã®çµ±åˆ

```bash
az aks update \
  --resource-group rg-wiz-exercise \
  --name aks-wiz-dev \
  --attach-acr acrwizdev
```

**ç›®çš„**: AKSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒACRã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«ã§ãã‚‹ã‚ˆã†ã«èªè¨¼æƒ…å ±ã‚’è‡ªå‹•è¨­å®š

---

## ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰

### å•é¡Œ1: package.jsonã«ä¾å­˜é–¢ä¿‚ãŒæœªå®šç¾©

**ã‚¨ãƒ©ãƒ¼å†…å®¹**:
```
Error: Cannot find module 'express'
```

**åŸå› **:
- `package.json` ã« `dependencies` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„
- `npm install` ãŒä½•ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªã‹ã£ãŸ

**è§£æ±ºæ–¹æ³•**:

`package.json` ã‚’ä¿®æ­£:
```json
{
  "name": "wiz-technical-exercise-app",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "start": "node app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^7.6.3",
    "body-parser": "^1.20.2",
    "ejs": "^3.1.9"
  }
}
```

### ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | çŠ¶æ…‹ | å‚™è€ƒ |
|----------|------|------|
| v1 (latest) | âŒ å¤±æ•— | ä¾å­˜é–¢ä¿‚ãªã— |
| v2 | âŒ å¤±æ•— | ä¾å­˜é–¢ä¿‚ãªã— |
| v3 | âœ… æˆåŠŸ | package.jsonä¿®æ­£å¾Œ |
| v4 | âœ… æˆåŠŸ | UIæ›´æ–°ç‰ˆ |
| å‹•çš„ã‚¿ã‚° (SHA) | âœ… æˆåŠŸ | CI/CDè‡ªå‹•åŒ– |

**ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰**:
```bash
az acr build \
  --registry acrwizdev \
  --image guestbook:v3 \
  --file Dockerfile \
  .
```

---

## â˜¸ï¸ Kubernetesãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤

### åˆæœŸãƒ‡ãƒ—ãƒ­ã‚¤ (v3ã‚¤ãƒ¡ãƒ¼ã‚¸)

**ä½¿ç”¨ã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ**:
- `deployment.yaml`: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“
- `service.yaml`: LoadBalancerå‹
- `rbac-vulnerable.yaml`: è„†å¼±ãªæ¨©é™è¨­å®š (ãƒ‡ãƒ¢ç”¨)

**ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰**:
```bash
kubectl apply -f app/k8s/deployment.yaml
kubectl apply -f app/k8s/service.yaml
kubectl apply -f app/k8s/rbac-vulnerable.yaml
```

**ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ**:
```
NAME                             READY   STATUS    RESTARTS   AGE
guestbook-app-6b77f7fcbc-pw6kw   1/1     Running   0          10s
guestbook-app-6b77f7fcbc-sr7zj   1/1     Running   0          10s
```

**ã‚µãƒ¼ãƒ“ã‚¹å…¬é–‹**:
```
NAME                TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)
guestbook-service   LoadBalancer   10.1.112.47   4.189.34.65   80:32136/TCP
```

åˆæœŸã‚¢ã‚¯ã‚»ã‚¹URL: `http://4.189.34.65`

---

## ğŸ”„ CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®è‡ªå‹•åŒ–

### GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¿®æ­£

**ä¿®æ­£å†…å®¹**:
1. ACRåã®ä¿®æ­£: `acrwizexercise` â†’ `acrwizdev`
2. Ingressãƒ‡ãƒ—ãƒ­ã‚¤ã®ä¸€æ™‚å‰Šé™¤ (Application Gatewayæœªè¨­å®š)
3. å‹•çš„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã®å®Ÿè£…

**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹æˆ**:
```yaml
jobs:
  scan-container:
    # Trivyã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³
  
  build-push:
    # github.shaã‚¿ã‚°ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥
    outputs:
      image_tag: ${{ steps.image.outputs.tag }}
  
  deploy-aks:
    # å‹•çš„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã§Kubernetesã«ãƒ‡ãƒ—ãƒ­ã‚¤
```

**å®Ÿè£…ã—ãŸè‡ªå‹•åŒ–**:
- âœ… `app/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’æ¤œçŸ¥
- âœ… ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è‡ªå‹•ãƒ“ãƒ«ãƒ‰ (Commit SHAã‚¿ã‚°)
- âœ… Trivyã«ã‚ˆã‚‹è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
- âœ… ACRã¸ã®è‡ªå‹•ãƒ—ãƒƒã‚·ãƒ¥
- âœ… AKSã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
- âœ… ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

---

## ğŸŒ Ingress + LoadBalanceræ§‹æˆã®å®Ÿè£…

### èª²é¡Œè¦ä»¶
> **ã€ŒIngress + CSPï¼ˆCloud Service Providerï¼‰ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã§å…¬é–‹ã€**

### åˆæœŸçŠ¶æ…‹ã®å•é¡Œç‚¹
âŒ LoadBalancerå‹Serviceã§ç›´æ¥å…¬é–‹ (Ingressæœªä½¿ç”¨)  
âŒ Application Gateway Ingress ControllerãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### è§£æ±ºæ–¹æ³•: NGINX Ingress Controllerã®å°å…¥

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰**:
```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml
```

**ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹**:
- Namespace: `ingress-nginx`
- Deployment: `ingress-nginx-controller`
- Service: `ingress-nginx-controller` (LoadBalancerå‹)
- IngressClass: `nginx`

### ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¿®æ­£

**Serviceå¤‰æ›´**:
```yaml
# Before
spec:
  type: LoadBalancer

# After
spec:
  type: ClusterIP
```

**Ingressä½œæˆ**:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: guestbook-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: guestbook-service
                port:
                  number: 80
```

### æœ€çµ‚æ§‹æˆ

```
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ
    â†“
[Azure Load Balancer: 20.18.117.80] â† CSPã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µ
    â†“
[NGINX Ingress Controller Pod]
    â†“
[Ingress ãƒªã‚½ãƒ¼ã‚¹: guestbook-ingress]
    â†“
[ClusterIP Service: guestbook-service]
    â†“
[Application Pods: guestbook-app (2 replicas)]
```

**æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹URL**: `http://20.18.117.80`

---

## ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªã‚³ãƒãƒ³ãƒ‰

### Ingress Controllerç¢ºèª
```bash
kubectl get all -n ingress-nginx
kubectl get svc -n ingress-nginx
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
```bash
kubectl get pods -l app=guestbook
kubectl get svc guestbook-service
kubectl get ingress guestbook-ingress
```

### å‹•ä½œç¢ºèª
```bash
# HTTPã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
Invoke-WebRequest -Uri http://20.18.117.80 -UseBasicParsing

# ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
Start-Process "http://20.18.117.80"
```

---

## âœ… é”æˆäº‹é …ã¾ã¨ã‚

| é …ç›® | çŠ¶æ…‹ | è©³ç´° |
|------|------|------|
| ACRä½œæˆ | âœ… | acrwizdev.azurecr.io |
| ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ | âœ… | è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ |
| AKSãƒ‡ãƒ—ãƒ­ã‚¤ | âœ… | 2ãƒ¬ãƒ—ãƒªã‚«ã§ç¨¼åƒ |
| CI/CDè‡ªå‹•åŒ– | âœ… | GitHub Actionså®Œå…¨çµ±åˆ |
| Ingressæ§‹æˆ | âœ… | NGINX + Azure LB |
| å‹•çš„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° | âœ… | Commit SHAä½¿ç”¨ |
| è‡ªå‹•UIæ›´æ–° | âœ… | ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ |

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### å®Ÿè£…æ¸ˆã¿
- âœ… ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¹ã‚­ãƒ£ãƒ³ (Trivy)
- âœ… ACRã¨AKSã®çµ±åˆ (Managed Identity)
- âœ… ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã§ã®Podé…ç½®
- âœ… MongoDBèªè¨¼ã®å®Ÿè£…

### æ„å›³çš„ãªè„†å¼±æ€§ (ãƒ‡ãƒ¢ç”¨)
- âš ï¸ ã‚¯ãƒ©ã‚¹ã‚¿ç®¡ç†è€…æ¨©é™ã®ä»˜ä¸ (rbac-vulnerable.yaml)
- âš ï¸ ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯

---

## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… Ingressæ§‹æˆã®å®Œäº†
2. â­ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¿½åŠ å®Ÿè£…
3. â­ï¸ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°åé›†ã®è¨­å®š
4. â­ï¸ ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è³‡æ–™ã®ä½œæˆ

---

**ä½œæˆæ—¥**: 2025å¹´10æœˆ29æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ29æ—¥
