name: 0. Setup RBAC for Service Principal

on:
    workflow_dispatch:
        inputs:
            service_principal_object_id:
                description: "Service Principal Object ID"
                required: true
                default: "ba5e5bf1-4e1b-484a-a4cd-d8b9be224de3"
            subscription_id:
                description: "Azure Subscription ID"
                required: true
                default: "832c4080-181c-476b-9db0-b3ce9596d40a"

permissions:
    contents: read

jobs:
    assign-roles:
        name: Assign Required Roles to Service Principal
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Azure Login (Admin Context)
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS_ADMIN }}
              # Note: This requires a separate secret with Owner/User Access Administrator permissions

            - name: Set Subscription Context
              shell: bash
              run: |
                  az account set --subscription ${{ github.event.inputs.subscription_id }}
                  az account show

            - name: Assign Resource Policy Contributor Role
              shell: bash
              run: |
                  echo "Assigning Resource Policy Contributor role..."
                  az role assignment create \
                    --assignee-object-id ${{ github.event.inputs.service_principal_object_id }} \
                    --assignee-principal-type ServicePrincipal \
                    --role "Resource Policy Contributor" \
                    --scope "/subscriptions/${{ github.event.inputs.subscription_id }}"

            - name: Verify Role Assignments
              shell: bash
              run: |
                  echo "Current role assignments for Service Principal:"
                  az role assignment list \
                    --assignee-object-id ${{ github.event.inputs.service_principal_object_id }} \
                    --output table

            - name: Summary
              shell: bash
              run: |
                  echo "âœ… RBAC setup completed!"
                  echo "Service Principal: ${{ github.event.inputs.service_principal_object_id }}"
                  echo "Subscription: ${{ github.event.inputs.subscription_id }}"
                  echo ""
                  echo "Assigned Roles:"
                  echo "  - Resource Policy Contributor"
                  echo ""
                  echo "Next Steps:"
                  echo "  1. Run workflow '1. Deploy Infrastructure'"
                  echo "  2. Run workflow '2-2. Deploy Azure Policy Guardrails'"
