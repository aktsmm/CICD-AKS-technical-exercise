name: üßπ Cleanup Workflow Runs (Delete ALL runs)

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete ALL workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="aktsmm/CICD-AKS-technical-exercise"

          echo "üßæ Fetching ALL workflow runs..."
          RUNS=$(gh api repos/$REPO/actions/runs --paginate \
            -q '.workflow_runs[] | {id: .id, status: .status, conclusion: .conclusion, created_at: .created_at}' \
            | jq -s 'sort_by(.created_at) | reverse')

          COUNT=$(echo "$RUNS" | jq 'length')
          echo "üßπ Found $COUNT runs to delete."

          if (( COUNT == 0 )); then
            echo "‚úÖ No runs found. Exiting."
            exit 0
          fi

          echo "$RUNS" | jq -c '.[]' | while read -r run; do
            ID=$(echo "$run" | jq -r '.id')
            STATUS=$(echo "$run" | jq -r '.status')
            CONCLUSION=$(echo "$run" | jq -r '.conclusion')
            CREATED_AT=$(echo "$run" | jq -r '.created_at')

            echo "üßπ Deleting run ID: $ID ($STATUS/$CONCLUSION, created $CREATED_AT)"
            gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "‚ö†Ô∏è Failed to delete run $ID"
          done
