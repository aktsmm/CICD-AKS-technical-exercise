name: üßπ Cleanup Workflow Runs (Delete latest 5 older than 1h)

on:
    workflow_dispatch:
    schedule:
        - cron: "0 */12 * * *" # 12ÊôÇÈñì„Åî„Å®„Å´ÂÆüË°åÔºàUTCÔºâ

permissions:
    actions: write
    contents: read

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: Delete latest 5 workflow runs older than 1h
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  REPO="aktsmm/CICD-AKS-technical-exercise"
                  NOW=$(date -u +"%s")       # ÁèæÂú®UTCÊôÇÂàª
                  THRESHOLD=$((60 * 60))     # 1ÊôÇÈñìÔºàÁßíÔºâ

                  echo "üßæ Fetching workflow runs..."
                  # workflow runs „ÇíÊñ∞„Åó„ÅÑÈ†Ü„Å´ÂèñÂæó
                  RUNS=$(gh api repos/$REPO/actions/runs --paginate -q '.workflow_runs[] | {id: .id, status: .status, conclusion: .conclusion, created_at: .created_at}' | jq -s 'sort_by(.created_at) | reverse')

                  # 1ÊôÇÈñì‰ª•‰∏äÁµåÈÅé„Åó„Å¶„ÅÑ„Çã run „ÇíÊäΩÂá∫„Åó„ÄÅ‰∏ä‰Ωç5‰ª∂„Å†„ÅëÂâäÈô§
                  TARGETS=$(echo "$RUNS" | jq -c --arg now "$NOW" --argjson th "$THRESHOLD" '
                    map(select((($now|tonumber) - (.created_at|fromdate|tonumber)) >= $th))[:5]
                  ')

                  COUNT=$(echo "$TARGETS" | jq 'length')
                  echo "üßπ Found $COUNT runs eligible for deletion."

                  if (( COUNT == 0 )); then
                    echo "‚úÖ No runs to delete. Exiting."
                    exit 0
                  fi

                  echo "$TARGETS" | jq -c '.[]' | while read -r run; do
                    ID=$(echo "$run" | jq -r '.id')
                    STATUS=$(echo "$run" | jq -r '.status')
                    CONCLUSION=$(echo "$run" | jq -r '.conclusion')
                    CREATED_AT=$(echo "$run" | jq -r '.created_at')

                    AGE_MIN=$(( (NOW - $(date -d "$CREATED_AT" +"%s")) / 60 ))

                    echo "üßπ Deleting run ID: $ID ($STATUS/$CONCLUSION, ${AGE_MIN}min old)"
                    gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "‚ö†Ô∏è Failed to delete run $ID"
                  done
