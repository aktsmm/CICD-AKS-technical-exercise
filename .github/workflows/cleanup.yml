name: ğŸ§¹ Cleanup Workflow Runs (Keep only latest 5 + delete failed recent runs)

on:
    push:
        branches:
            - main
        paths:
            - "app/**"
            - "infra/**"
            - ".github/workflows/cleanup.yml"

    workflow_dispatch:
    schedule:
        - cron: "0 */12 * * *" # 12æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆUTCï¼‰

permissions:
    actions: write
    contents: read

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: Delete old or failed workflow runs
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  REPO="aktsmm/CICD-AKS-technical-exercise"

                  echo "ğŸ§¾ Fetching workflow runs..."
                  RUNS=$(gh api repos/$REPO/actions/runs --paginate \
                    -q '.workflow_runs[] | {id: .id, status: .status, conclusion: .conclusion, created_at: .created_at}' \
                    | jq -s 'sort_by(.created_at) | reverse')

                  echo "ğŸ§© Selecting deletion targets..."
                  # æœ€æ–°5ä»¶ã¯ä¿æŒã€‚ãŸã ã—å¤±æ•—ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»conclusion=null ã¯å‰Šé™¤å¯¾è±¡
                  TARGETS=$(echo "$RUNS" | jq -c '[.[] | select((.conclusion == "failure") or (.conclusion == "cancelled") or (.conclusion == "timed_out") or (.conclusion == null))] + .[5:]')

                  COUNT=$(echo "$TARGETS" | jq 'length')
                  echo "ğŸ§¹ Found $COUNT runs to delete."

                  if (( COUNT == 0 )); then
                    echo "âœ… No runs to delete. Exiting."
                    exit 0
                  fi

                  echo "$TARGETS" | jq -c '.[]' | while read -r run; do
                    ID=$(echo "$run" | jq -r '.id')
                    STATUS=$(echo "$run" | jq -r '.status')
                    CONCLUSION=$(echo "$run" | jq -r '.conclusion')
                    CREATED_AT=$(echo "$run" | jq -r '.created_at')

                    echo "ğŸ§¹ Deleting run ID: $ID ($STATUS/$CONCLUSION, created $CREATED_AT)"
                    gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "âš ï¸ Failed to delete run $ID"
                  done
