name: üßπ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot + 1 failed)

on:
  schedule:
    - cron: "0 */12 * * *" # 12ÊôÇÈñì„Åî„Å®
  workflow_dispatch:
  workflow_run:
    workflows:
      - "1. Deploy Infrastructure"
      - "2-1. Build and Deploy Application"
      - "2-2. Deploy Policy Guardrails"
    types: [completed]
  push:
    branches: [main]
    paths:
      - ".github/workflows/cleanup.yml"
      - ".github/workflows/üßπ*.yml"

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üßπ Cleanup all old workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          # GitHub ÂÅ¥„Åß‰ªò‰∏é„Åï„Çå„ÇãÂÆüË°åÂêç„ÇíÂÑ™ÂÖà„Åó„ÄÅÂêçÁß∞Â§âÊõ¥ÊôÇ„ÇÇÂ∏∏„Å´‰∏ÄËá¥„Åï„Åõ„Çã
          SELF_NAME="${GITHUB_WORKFLOW:-üßπ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot + 1 failed)}"

          echo "üîç Getting all Cleanup workflow runs..."
          RUNS=$(gh run list --workflow "$SELF_NAME" --json databaseId,headBranch,status,conclusion,createdAt --limit 1000)
          COUNT=$(echo "$RUNS" | jq 'length')
          echo "üßæ Found $COUNT Cleanup runs total."

          # ÁèæÂú®„ÅÆ Cleanup ÂÆüË°å‰∏≠„ÅÆ ID „ÇíÂèñÂæó
          CURRENT_ID=$(echo "$RUNS" | jq -r '.[] | select(.status=="in_progress" or .status=="queued") | .databaseId' | head -n 1)
          echo "üü¢ Current Cleanup Run ID: ${CURRENT_ID:-none}"

          # ÁèæË°åRun‰ª•Â§ñ„ÇíÂâäÈô§ÂØæË±°„Å®„Åô„Çã
          TARGETS=$(echo "$RUNS" | jq -r --arg cur "$CURRENT_ID" '.[] | select(.databaseId != ($cur|tonumber)) | .databaseId')

          if [ -z "$TARGETS" ]; then
            echo "‚úÖ No old Cleanup runs to delete."
          else
            echo "$TARGETS" | while read -r ID; do
              echo "üßπ Deleting old Cleanup run ID: $ID"
              gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "‚ö†Ô∏è Failed to delete run $ID"
            done
          fi

          echo "üß© Cleaning other workflows (7 human + 3 dependabot + 1 failed)..."
          ALL_RUNS=$(gh api repos/$REPO/actions/runs --paginate -q '.workflow_runs[] | {id: .id, name: .name, conclusion: .conclusion, created_at: .created_at, actor: (.actor.login // "unknown")}' | jq -s 'sort_by(.created_at) | reverse')

          # ‚úÖ ÊàêÂäü„Åó„Åü human ÂÆüË°å: ÊúÄÊñ∞7‰ª∂‰øùÊåÅ
          KEEP_HUMAN=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.actor != "dependabot[bot]" and .conclusion == "success")][:7] | map(.id)')

          # ‚úÖ ÊàêÂäü„Åó„Åü dependabot ÂÆüË°å: ÊúÄÊñ∞3‰ª∂‰øùÊåÅ
          KEEP_DEPENDABOT=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.actor == "dependabot[bot]" and .conclusion == "success")][:3] | map(.id)')

          # ‚úÖ Â§±Êïó„Åó„ÅüÂÆüË°å: ÊúÄÊñ∞1‰ª∂‰øùÊåÅ
          KEEP_FAILED=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.conclusion != "success")][:1] | map(.id)')

          # ‚úÖ ‰øùÊåÅÂØæË±°„ÇíÁµ±Âêà
          KEEP_ALL=$(jq -n --argjson a "$KEEP_HUMAN" --argjson b "$KEEP_DEPENDABOT" --argjson c "$KEEP_FAILED" '$a + $b + $c')

          # üßπ ÂâäÈô§ÂØæË±°„ÇíÊäΩÂá∫
          TARGETS=$(echo "$ALL_RUNS" | jq -c --argjson keepIds "$KEEP_ALL" '[ .[] | select((.id as $id | ($keepIds | index($id)) | not)) ]')
          COUNT=$(echo "$TARGETS" | jq 'length')
          echo "üßπ Found $COUNT runs to delete."

          # üöÆ ÂâäÈô§Âá¶ÁêÜ
          if (( COUNT > 0 )); then
            echo "$TARGETS" | jq -c '.[]' | while read -r run; do
              ID=$(echo "$run" | jq -r '.id')
              NAME=$(echo "$run" | jq -r '.name')
              CONCLUSION=$(echo "$run" | jq -r '.conclusion')
              echo "üóëÔ∏è Deleting run $ID [$NAME] ($CONCLUSION)"
              gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "‚ö†Ô∏è Failed to delete run $ID"
            done
          else
            echo "‚úÖ No old workflow runs to delete."
          fi

          echo "üéâ Cleanup complete (kept 1 current + 7 human + 3 dependabot + 1 failed)."
