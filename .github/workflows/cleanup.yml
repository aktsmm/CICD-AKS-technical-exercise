name: üßπ Cleanup Failed or Pending Runs (Keep last 5 successful)

on:
    workflow_dispatch:
    schedule:
        - cron: "0 */12 * * *" # 12ÊôÇÈñì„Åî„Å®„Å´ÂÆüË°åÔºàUTCÔºâ

permissions:
    actions: write
    contents: read

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: Delete failed, cancelled, or old pending workflow runs
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  REPO="aktsmm/CICD-AKS-technical-exercise"
                  NOW=$(date -u +"%s")  # ÁèæÂú®„ÅÆUTCÊôÇÂàªÔºàUNIXÁßíÔºâ
                  THRESHOLD=$((60 * 60))  # 1ÊôÇÈñì(ÁßíÊèõÁÆó)

                  echo "üßæ Fetching workflow runs..."
                  RUNS=$(gh api repos/$REPO/actions/runs --paginate -q '.workflow_runs[] | {id: .id, status: .status, conclusion: .conclusion, created_at: .created_at}')

                  echo "$RUNS" | jq -c '.' | while read -r run; do
                    ID=$(echo "$run" | jq -r '.id')
                    STATUS=$(echo "$run" | jq -r '.status')
                    CONCLUSION=$(echo "$run" | jq -r '.conclusion')
                    CREATED_AT=$(echo "$run" | jq -r '.created_at')

                    # ÂÆüË°åÈñãÂßãÊôÇÂàª„ÇíUNIXÁßí„Å´Â§âÊèõ
                    CREATED_UNIX=$(date -d "$CREATED_AT" +"%s")
                    AGE=$((NOW - CREATED_UNIX))

                    # 1ÊôÇÈñì‰ª•‰∏äÁµåÈÅé„Åó„Å¶„ÅÑ„Çãrun„ÅÆ„ÅøÂØæË±°
                    if (( AGE >= THRESHOLD )); then
                      if [[ "$CONCLUSION" == "failure" || "$CONCLUSION" == "cancelled" || "$STATUS" == "in_progress" ]]; then
                        echo "üßπ Deleting run ID: $ID ($STATUS/$CONCLUSION) - age: $((AGE/60)) min"
                        gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "‚ö†Ô∏è Skipped run $ID"
                      else
                        echo "‚úÖ Keeping successful run ID: $ID ($STATUS/$CONCLUSION)"
                      fi
                    else
                      echo "‚è≥ Skipping recent run ID: $ID ($STATUS/$CONCLUSION, created less than 1h ago)"
                    fi
                  done
