name: 🧹 Cleanup Workflow Runs (Keep only latest 5)

on:
    workflow_dispatch:
    schedule:
        - cron: "0 */12 * * *" # 12時間ごとに実行（UTC）

permissions:
    actions: write
    contents: read

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: Delete all but latest 5 workflow runs
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  REPO="aktsmm/CICD-AKS-technical-exercise"

                  echo "🧾 Fetching workflow runs..."
                  RUNS=$(gh api repos/$REPO/actions/runs --paginate -q '.workflow_runs[] | {id: .id, status: .status, conclusion: .conclusion, created_at: .created_at}' | jq -s 'sort_by(.created_at) | reverse')

                  # 5件目以降を削除対象にする
                  TARGETS=$(echo "$RUNS" | jq -c '.[5:]')

                  COUNT=$(echo "$TARGETS" | jq 'length')
                  echo "🧹 Found $COUNT old runs to delete."

                  if (( COUNT == 0 )); then
                    echo "✅ No old runs to delete. Exiting."
                    exit 0
                  fi

                  echo "$TARGETS" | jq -c '.[]' | while read -r run; do
                    ID=$(echo "$run" | jq -r '.id')
                    STATUS=$(echo "$run" | jq -r '.status')
                    CONCLUSION=$(echo "$run" | jq -r '.conclusion')
                    CREATED_AT=$(echo "$run" | jq -r '.created_at')

                    echo "🧹 Deleting old run ID: $ID ($STATUS/$CONCLUSION, created $CREATED_AT)"
                    gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "⚠️ Failed to delete run $ID"
                  done
