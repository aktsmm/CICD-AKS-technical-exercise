name: ğŸ§¹ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot runs)

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *" # 12æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆUTCï¼‰

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    if: ${{ github.ref == 'refs/heads/main' && github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Delete failed, old, and all Cleanup runs (keep latest 7 human + 3 dependabot)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="aktsmm/CICD-AKS-technical-exercise"
          SELF_NAME="ğŸ§¹ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot runs)"

          echo "ğŸ§¾ Fetching workflow runs..."
          RUNS=$(gh api repos/$REPO/actions/runs --paginate \
            -q '.workflow_runs[] | {id: .id, name: .name, status: .status, conclusion: .conclusion, actor: .actor.login, created_at: .created_at}' \
            | jq -s 'sort_by(.created_at) | reverse')

          echo "ğŸ§© Selecting deletion targets..."

          # âœ… äººé–“å®Ÿè¡Œ: æœ€æ–°7ä»¶ã®ã¿ä¿æŒ
          KEEP_HUMAN=$(echo "$RUNS" | jq -c '[.[] | select(.actor != "dependabot[bot]" and .conclusion == "success")][:7] | map(.id)')

          # ğŸ¤– Dependabotå®Ÿè¡Œ: æœ€æ–°3ä»¶ã®ã¿ä¿æŒ
          KEEP_DEPENDABOT=$(echo "$RUNS" | jq -c '[.[] | select(.actor == "dependabot[bot]" and .conclusion == "success")][:3] | map(.id)')

          # ğŸ§© ä¿æŒå¯¾è±¡ã‚’çµ±åˆ
          KEEP_ALL=$(jq -n --argjson a "$KEEP_HUMAN" --argjson b "$KEEP_DEPENDABOT" '$a + $b')

          TARGETS=$(echo "$RUNS" | jq -c --arg self "$SELF_NAME" --argjson keepIds "$KEEP_ALL" '
            [ .[]
              | select(
                  (.name == $self)                           # âœ… Cleanupè‡ªä½“ã¯å¸¸ã«å‰Šé™¤
                  or (.conclusion != "success")              # âŒ å¤±æ•—/ã‚­ãƒ£ãƒ³ã‚»ãƒ«Runå‰Šé™¤
                  or (.id as $id | ($keepIds | index($id)) | not)  # âŒ ä¿æŒãƒªã‚¹ãƒˆå¤–ã‚’å‰Šé™¤
                )
            ]')

          COUNT=$(echo "$TARGETS" | jq 'length')
          echo "ğŸ§¹ Found $COUNT runs to delete."

          if (( COUNT == 0 )); then
            echo "âœ… No runs to delete. Exiting."
            exit 0
          fi

          echo "$TARGETS" | jq -c '.[]' | while read -r run; do
            ID=$(echo "$run" | jq -r '.id')
            NAME=$(echo "$run" | jq -r '.name')
            ACTOR=$(echo "$run" | jq -r '.actor')
            STATUS=$(echo "$run" | jq -r '.status')
            CONCLUSION=$(echo "$run" | jq -r '.conclusion')
            CREATED_AT=$(echo "$run" | jq -r '.created_at')

            echo "ğŸ§¹ Deleting run ID: $ID [$NAME] by $ACTOR ($STATUS/$CONCLUSION, created $CREATED_AT)"
            gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "âš ï¸ Failed to delete run $ID"
          done

          echo "ğŸ‰ Cleanup complete (7 human + 3 dependabot runs retained)."
