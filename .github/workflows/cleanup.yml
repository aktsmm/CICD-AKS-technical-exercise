name: ğŸ§¹ Cleanup Workflow Runs (Keep latest 10 + delete failed recent runs + keep last success per workflow)

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - "infra/**"
      - ".github/workflows/cleanup.yml"

  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *" # 12æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆUTCï¼‰

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old or failed workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="aktsmm/CICD-AKS-technical-exercise"

          echo "ğŸ§¾ Fetching workflow runs..."
          RUNS=$(gh api repos/$REPO/actions/runs --paginate \
            -q '.workflow_runs[] | {id: .id, name: .name, status: .status, conclusion: .conclusion, created_at: .created_at}' \
            | jq -s 'sort_by(.created_at) | reverse')

          echo "ğŸ§© Determining latest successful runs per workflow..."
          # å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã”ã¨ã«ã€Œæœ€æ–°ã® successã€ã‚’æŠ½å‡º
          LAST_SUCCESSES=$(echo "$RUNS" | jq -c 'group_by(.name) | map(first(select(.conclusion == "success")) | .id) | map(select(. != null))')

          echo "ğŸ§© Selecting deletion targets..."
          # æœ€æ–°10ä»¶ã¯ä¿æŒã€‚ãŸã ã— "Cleanup Workflow Runs" ã¯ä¿æŒå¯¾è±¡ã§ã‚‚å‰Šé™¤ã™ã‚‹
          # ã•ã‚‰ã«ã€å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€å¾Œã«æˆåŠŸã—ãŸ run ã¯ä¿æŒå¯¾è±¡ã¨ã—ã¦é™¤å¤–
          TARGETS=$(echo "$RUNS" | jq -c --argjson keepIds "$LAST_SUCCESSES" '[.[10:][] 
            | select(
                ((.conclusion == "failure") 
                or (.conclusion == "cancelled") 
                or (.conclusion == "timed_out") 
                or (.conclusion == null) 
                or (.name == "ğŸ§¹ Cleanup Workflow Runs (Keep latest 10 + delete failed recent runs + keep last success per workflow)"))
                and (.id as $id | ($keepIds | index($id)) | not)
              )]')

          COUNT=$(echo "$TARGETS" | jq 'length')
          echo "ğŸ§¹ Found $COUNT runs to delete."

          if (( COUNT == 0 )); then
            echo "âœ… No runs to delete. Exiting."
            exit 0
          fi

          echo "$TARGETS" | jq -c '.[]' | while read -r run; do
            ID=$(echo "$run" | jq -r '.id')
            NAME=$(echo "$run" | jq -r '.name')
            STATUS=$(echo "$run" | jq -r '.status')
            CONCLUSION=$(echo "$run" | jq -r '.conclusion')
            CREATED_AT=$(echo "$run" | jq -r '.created_at')

            echo "ğŸ§¹ Deleting run ID: $ID [$NAME] ($STATUS/$CONCLUSION, created $CREATED_AT)"
            gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "âš ï¸ Failed to delete run $ID"
          done
