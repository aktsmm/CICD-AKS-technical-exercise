name: 3. ğŸ§¹ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot runs)

on:
  # âœ… å®šæœŸå®Ÿè¡Œï¼ˆ30åˆ†ã”ã¨ã€UTCåŸºæº–ï¼‰
  schedule:
    - cron: "*/30 * * * *"

  # âœ… æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

  # âœ… ä»–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†æ™‚ï¼ˆæˆåŠŸãƒ»å¤±æ•—ã©ã¡ã‚‰ã§ã‚‚ï¼‰
  workflow_run:
    workflows:
      - "Deploy Infrastructure"
      - "Build and Deploy Application"
      - "Deploy Policy Guardrails"
    types:
      - completed

  # âœ… è‡ªåˆ†è‡ªèº«ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«ã‚‚å®Ÿè¡Œ
  push:
    branches:
      - main
    paths:
      - ".github/workflows/cleanup.yml" # â† Cleanupã®ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã‚‹

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    # âœ… mainãƒ–ãƒ©ãƒ³ãƒã§å®Ÿè¡Œ
    if: |
      (
        github.ref == 'refs/heads/main' ||
        (
          github.event_name == 'workflow_run' &&
          github.event.workflow_run.head_branch == 'main'
        )
      ) &&
      (
        github.event_name == 'schedule' ||
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'push' ||
        (
          github.event_name == 'workflow_run' &&
          (
            github.event.workflow_run.conclusion == 'failure' ||
            github.event.workflow_run.conclusion == 'success'
          )
        )
      )

    runs-on: ubuntu-latest

    steps:
      - name: ğŸª¶ Debug trigger info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Workflow Run Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Head Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Committer: ${{ github.actor }}"
          echo "Workflow file changed: ${{ github.event.head_commit.message }}"

      - name: ğŸ§¹ Cleanup old workflow runs (keep latest 7 human + 3 dependabot + current cleanup)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          SELF_NAME="ğŸ§¹ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot runs)"

          echo "ğŸ§¾ Fetching workflow runs..."
          RUNS=$(gh api repos/$REPO/actions/runs --paginate \
            -q '.workflow_runs[] | {id: .id, name: .name, status: .status, conclusion: .conclusion, actor: .actor.login, created_at: .created_at}' \
            | jq -s 'sort_by(.created_at) | reverse')

          echo "ğŸ§© Selecting deletion targets..."

          # âœ… æœ€æ–°ã®Cleanup Runï¼ˆï¼ä»Šå›åˆ†ï¼‰ã‚’ä¿æŒ
          CURRENT_RUN_ID=$(gh run list --workflow "$SELF_NAME" --json databaseId,status \
            | jq -r '.[] | select(.status=="in_progress" or .status=="queued") | .databaseId' | head -n 1)

          echo "â„¹ï¸ Current Cleanup Run ID: ${CURRENT_RUN_ID:-not found}"

          # âœ… äººé–“å®Ÿè¡Œ: æœ€æ–°7ä»¶ã®ã¿ä¿æŒ
          KEEP_HUMAN=$(echo "$RUNS" | jq -c '[.[] | select(.actor != "dependabot[bot]" and .conclusion == "success")][:7] | map(.id)')

          # ğŸ¤– Dependabotå®Ÿè¡Œ: æœ€æ–°3ä»¶ã®ã¿ä¿æŒ
          KEEP_DEPENDABOT=$(echo "$RUNS" | jq -c '[.[] | select(.actor == "dependabot[bot]" and .conclusion == "success")][:3] | map(.id)')

          # ğŸ§© ä¿æŒå¯¾è±¡ï¼ˆCleanupç¾è¡ŒRunå«ã‚€ï¼‰
          KEEP_ALL=$(jq -n \
            --argjson a "$KEEP_HUMAN" \
            --argjson b "$KEEP_DEPENDABOT" \
            --arg current "${CURRENT_RUN_ID:-null}" \
            '$a + $b + (if $current then [$current] else [] end)')

          # ğŸ¯ å‰Šé™¤å¯¾è±¡ã®é¸å®š
          TARGETS=$(echo "$RUNS" | jq -c --arg self "$SELF_NAME" --argjson keepIds "$KEEP_ALL" '
            [ .[]
              | select(
                  ((.name == $self) and (.id as $id | ($keepIds | index($id)) | not)) # âœ… å¤ã„Cleanupã¯å‰Šé™¤ï¼ˆä»Šå›åˆ†ã¯ä¿æŒï¼‰
                  or (.conclusion != "success")                                      # âŒ å¤±æ•—/ã‚­ãƒ£ãƒ³ã‚»ãƒ«Runå‰Šé™¤
                  or (.id as $id | ($keepIds | index($id)) | not)                    # âŒ ä¿æŒå¯¾è±¡å¤–ã‚’å‰Šé™¤
                )
            ]')

          COUNT=$(echo "$TARGETS" | jq 'length')
          echo "ğŸ§¹ Found $COUNT runs to delete."

          if (( COUNT == 0 )); then
            echo "âœ… No runs to delete. Exiting."
            exit 0
          fi

          echo "ğŸ§¾ DELETEå¯¾è±¡ä¸€è¦§:"
          echo "$TARGETS" | jq '.[] | {id, name, actor, conclusion, created_at}'

          echo "$TARGETS" | jq -c '.[]' | while read -r run; do
            ID=$(echo "$run" | jq -r '.id')
            NAME=$(echo "$run" | jq -r '.name')
            ACTOR=$(echo "$run" | jq -r '.actor')
            CONCLUSION=$(echo "$run" | jq -r '.conclusion')
            CREATED_AT=$(echo "$run" | jq -r '.created_at')

            echo "ğŸ§¹ Deleting run ID: $ID [$NAME] by $ACTOR ($CONCLUSION, created $CREATED_AT)"
            gh api repos/$REPO/actions/runs/$ID -X DELETE -v || echo "âŒ Failed to delete run $ID"
          done

          echo "ğŸ‰ Cleanup complete (kept 7 human + 3 dependabot + current cleanup run)."
