name: üßπ Cleanup Failed or Pending Runs (Keep last 5 successful)

on:
    workflow_dispatch:
    schedule:
        - cron: "0 * * * *" # ÊØéÊôÇÂÆüË°åÔºàUTCÔºâ

permissions:
    actions: write
    contents: read

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: Delete only failed or in_progress workflow runs
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  REPO="aktsmm/CICD-AKS-technical-exercise"

                  echo "üßæ Fetching workflow runs..."
                  RUNS=$(gh api repos/$REPO/actions/runs --paginate -q '.workflow_runs[] | {id: .id, status: .status, conclusion: .conclusion}')

                  echo "$RUNS" | jq -c '.' | while read -r run; do
                    ID=$(echo $run | jq -r '.id')
                    STATUS=$(echo $run | jq -r '.status')
                    CONCLUSION=$(echo $run | jq -r '.conclusion')

                    # ÂâäÈô§ÂØæË±°Êù°‰ª∂Ôºöfailed, cancelled, or in_progress
                    if [[ "$CONCLUSION" == "failure" || "$CONCLUSION" == "cancelled" || "$STATUS" == "in_progress" ]]; then
                      echo "üßπ Deleting failed/pending run ID: $ID ($STATUS/$CONCLUSION)"
                      gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "‚ö†Ô∏è Skipped run $ID"
                    else
                      echo "‚úÖ Keeping run ID: $ID ($STATUS/$CONCLUSION)"
                    fi
                  done
