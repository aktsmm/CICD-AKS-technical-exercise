name: Deploy Infrastructure

on:
    push:
        branches:
            - main
        paths:
            - "infra/**"
            - ".github/workflows/infra-deploy.yml"
    workflow_dispatch:

permissions:
    contents: read
    security-events: write

env:
    AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    RESOURCE_GROUP: rg-bbs-cicd-aks-01
    LOCATION: japaneast

jobs:
    scan-iac:
        name: Scan IaC for Security Issues
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Run Checkov Scan
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: infra/
                  framework: bicep
                  output_format: sarif
                  output_file_path: checkov-results.sarif
                  soft_fail: true

            - name: Upload Checkov Results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              continue-on-error: true
              with:
                  sarif_file: checkov-results.sarif

    deploy-infra:
        name: Deploy Azure Infrastructure
        runs-on: ubuntu-latest
        needs: scan-iac
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Deploy Bicep
              uses: azure/arm-deploy@v1
              with:
                  subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
                  scope: subscription
                  region: ${{ env.LOCATION }}
                  template: ./infra/main.bicep
                  parameters: >
                      resourceGroupName=${{ env.RESOURCE_GROUP }}
                      location=${{ env.LOCATION }}
                      mongoAdminPassword=${{ secrets.MONGO_ADMIN_PASSWORD }}
                  deploymentName: infra-deployment-${{ github.run_number }}
                  failOnStdErr: false

            - name: Get Deployment Outputs
              id: outputs
              run: |
                  DEPLOYMENT_NAME="infra-deployment-${{ github.run_number }}"

                  AKS_NAME=$(az deployment sub show \
                    --name $DEPLOYMENT_NAME \
                    --query properties.outputs.aksClusterName.value \
                    -o tsv)

                  MONGO_IP=$(az deployment sub show \
                    --name $DEPLOYMENT_NAME \
                    --query properties.outputs.mongoVMPrivateIP.value \
                    -o tsv)

                  STORAGE_NAME=$(az deployment sub show \
                    --name $DEPLOYMENT_NAME \
                    --query properties.outputs.storageAccountName.value \
                    -o tsv)

                  ACR_NAME=$(az deployment sub show \
                    --name $DEPLOYMENT_NAME \
                    --query properties.outputs.acrName.value \
                    -o tsv)

                  echo "aks_name=$AKS_NAME" >> $GITHUB_OUTPUT
                  echo "mongo_ip=$MONGO_IP" >> $GITHUB_OUTPUT
                  echo "storage_name=$STORAGE_NAME" >> $GITHUB_OUTPUT
                  echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT

            - name: Save Outputs as Artifacts
              run: |
                  mkdir -p outputs
                  echo "AKS_CLUSTER_NAME=${{ steps.outputs.outputs.aks_name }}" > outputs/infra-outputs.txt
                  echo "MONGO_VM_IP=${{ steps.outputs.outputs.mongo_ip }}" >> outputs/infra-outputs.txt
                  echo "ACR_NAME=${{ steps.outputs.outputs.acr_name }}" >> outputs/infra-outputs.txt
                  echo "STORAGE_ACCOUNT_NAME=${{ steps.outputs.outputs.storage_name }}" >> outputs/infra-outputs.txt

            - name: Upload Outputs
              uses: actions/upload-artifact@v4
              with:
                  name: infra-outputs
                  path: outputs/infra-outputs.txt
