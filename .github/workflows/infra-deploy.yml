name: 1. Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - "infra/**"
      - ".github/workflows/infra-deploy.yml"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  id-token: write

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  LOCATION: ${{ vars.AZURE_LOCATION }}
  GRANT_OWNER_PARAMETER: ${{ vars.AZURE_GRANT_GITHUB_OWNER || 'false' }}

jobs:
  scan-iac:
    name: Scan IaC for Security Issues
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Checkov Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infra/
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: checkov-results.sarif

      - name: Run Trivy Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          format: sarif
          output: trivy-config.sarif
          path: infra
          severity: CRITICAL,HIGH
          exit-code: 0

      - name: Upload Trivy Config Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: trivy-config.sarif

  deploy-infra:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    needs: scan-iac
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login (bootstrap RBAC)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure RBAC for GitHub Actions Principal
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        env:
          PRINCIPAL_ID: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID }}
          SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          GRANT_OWNER: ${{ vars.AZURE_GRANT_GITHUB_OWNER || 'false' }}
        run: |
          set -euo pipefail

          az account set --subscription "$SUBSCRIPTION_ID"

          ensure_assignment() {
            local scope="$1"
            local roleName="$2"

            local existing
            existing=$(az role assignment list --assignee-object-id "$PRINCIPAL_ID" --role "$roleName" --scope "$scope" --query "[].id" -o tsv)

            if [[ -n "$existing" ]]; then
              echo "Role '$roleName' already present at scope '$scope'."
            else
              echo "Assigning role '$roleName' at scope '$scope'."
              az role assignment create \
                --assignee-object-id "$PRINCIPAL_ID" \
                --assignee-principal-type ServicePrincipal \
                --role "$roleName" \
                --scope "$scope"
            fi
          }

          RG_SCOPE="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}"

          ensure_assignment "$RG_SCOPE" "User Access Administrator"

          OWNER_SCOPE="/subscriptions/${SUBSCRIPTION_ID}"
          OWNER_ASSIGNMENTS=$(az role assignment list --assignee-object-id "$PRINCIPAL_ID" --role "Owner" --scope "$OWNER_SCOPE" --query "[].id" -o tsv)

          OWNER_PARAMETER="false"

          if [ "$GRANT_OWNER" = "true" ]; then
            if [[ -n "$OWNER_ASSIGNMENTS" ]]; then
              echo "Owner role already present; Bicep module will be skipped."
            else
              echo "Owner role not detected; Bicep module will assign." # avoid double assignment errors later
              OWNER_PARAMETER="true"
            fi
          else
            if [[ -n "$OWNER_ASSIGNMENTS" ]]; then
              echo "Owner role already assigned but automation flag is false; leaving as-is."
            fi
          fi

          echo "GRANT_OWNER_PARAMETER=$OWNER_PARAMETER" >> "$GITHUB_ENV"

      - name: Azure Logout (bootstrap context)
        if: ${{ vars.AZURE_GITHUB_PRINCIPAL_ID != '' }}
        run: az account clear

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Preview Changes with What-If
        run: |
          az deployment sub what-if \
            --name infra-whatif-${{ github.run_number }} \
            --location ${{ env.LOCATION }} \
            --template-file ./infra/main.bicep \
            --parameters \
              @infra/parameters/main-dev.parameters.json \
              resourceGroupName=${{ env.RESOURCE_GROUP }} \
              location=${{ env.LOCATION }} \
              mongoAdminPassword=${{ secrets.MONGO_ADMIN_PASSWORD }} \
              automationPrincipalObjectId=${{ vars.AZURE_GITHUB_PRINCIPAL_ID }} \
              grantAutomationPrincipalOwner=${{ env.GRANT_OWNER_PARAMETER }} \
            --result-format ResourceIdOnly

      - name: Deploy Bicep
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
          scope: subscription
          region: ${{ env.LOCATION }}
          template: ./infra/main.bicep
          parameters: >
            @infra/parameters/main-dev.parameters.json
            resourceGroupName=${{ env.RESOURCE_GROUP }}
            location=${{ env.LOCATION }}
            mongoAdminPassword=${{ secrets.MONGO_ADMIN_PASSWORD }}
            automationPrincipalObjectId=${{ vars.AZURE_GITHUB_PRINCIPAL_ID }}
            grantAutomationPrincipalOwner=${{ env.GRANT_OWNER_PARAMETER }}
          deploymentName: infra-deployment-${{ github.run_number }}
          failOnStdErr: false

      - name: Get Deployment Outputs
        id: outputs
        run: |
          DEPLOYMENT_NAME="infra-deployment-${{ github.run_number }}"

          AKS_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.aksClusterName.value \
            -o tsv)

          MONGO_IP=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.mongoVMPrivateIP.value \
            -o tsv)

          VM_IDENTITY=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.mongoVMIdentityPrincipalId.value \
            -o tsv)

          STORAGE_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.storageAccountName.value \
            -o tsv)

          ACR_NAME=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.acrName.value \
            -o tsv)

          KUBELET_IDENTITY=$(az deployment sub show \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.kubeletIdentityPrincipalId.value \
            -o tsv)

          echo "aks_name=$AKS_NAME" >> $GITHUB_OUTPUT
          echo "mongo_ip=$MONGO_IP" >> $GITHUB_OUTPUT
          echo "mongo_vm_identity=$VM_IDENTITY" >> $GITHUB_OUTPUT
          echo "storage_name=$STORAGE_NAME" >> $GITHUB_OUTPUT
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "kubelet_identity=$KUBELET_IDENTITY" >> $GITHUB_OUTPUT

      - name: Save Outputs as Artifacts
        run: |
          mkdir -p outputs
          echo "AKS_CLUSTER_NAME=${{ steps.outputs.outputs.aks_name }}" > outputs/infra-outputs.txt
          echo "MONGO_VM_IP=${{ steps.outputs.outputs.mongo_ip }}" >> outputs/infra-outputs.txt
          echo "ACR_NAME=${{ steps.outputs.outputs.acr_name }}" >> outputs/infra-outputs.txt
          echo "MONGO_VM_IDENTITY=${{ steps.outputs.outputs.mongo_vm_identity }}" >> outputs/infra-outputs.txt
          echo "KUBELET_IDENTITY=${{ steps.outputs.outputs.kubelet_identity }}" >> outputs/infra-outputs.txt
          echo "STORAGE_ACCOUNT_NAME=${{ steps.outputs.outputs.storage_name }}" >> outputs/infra-outputs.txt

      - name: Assign RBAC Role Bindings
        run: |
          set -euo pipefail

          assign_role() {
            local principal="$1"
            local roleName="$2"
            local scope="$3"

            if az role assignment list --assignee-object-id "$principal" --role "$roleName" --scope "$scope" --query "[].id" -o tsv | grep -q . ; then
              echo "Role '$roleName' already exists for principal '$principal' at scope '$scope'."
            else
              echo "Assigning role '$roleName' to principal '$principal' at scope '$scope'."
              az role assignment create --assignee-object-id "$principal" --role "$roleName" --scope "$scope"
            fi
          }

          SUBSCRIPTION_ID="${{ env.AZURE_SUBSCRIPTION_ID }}"
          RESOURCE_GROUP="${{ env.RESOURCE_GROUP }}"
          VM_IDENTITY="${{ steps.outputs.outputs.mongo_vm_identity }}"
          KUBELET_IDENTITY="${{ steps.outputs.outputs.kubelet_identity }}"
          STORAGE_NAME="${{ steps.outputs.outputs.storage_name }}"
          ACR_NAME="${{ steps.outputs.outputs.acr_name }}"

          STORAGE_SCOPE=$(az storage account show --name "$STORAGE_NAME" --resource-group "$RESOURCE_GROUP" --query id -o tsv)
          ACR_SCOPE=$(az acr show --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP" --query id -o tsv)
          RESOURCE_GROUP_SCOPE="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}"

          assign_role "$VM_IDENTITY" "Contributor" "$RESOURCE_GROUP_SCOPE"
          assign_role "$VM_IDENTITY" "Storage Blob Data Contributor" "$STORAGE_SCOPE"
          assign_role "$VM_IDENTITY" "Virtual Machine Contributor" "$RESOURCE_GROUP_SCOPE"
          assign_role "$KUBELET_IDENTITY" "AcrPull" "$ACR_SCOPE"

      - name: Upload Outputs
        uses: actions/upload-artifact@v4
        with:
          name: infra-outputs
          path: outputs/infra-outputs.txt
