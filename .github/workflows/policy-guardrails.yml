name: 2-2. Deploy Policy Guardrails

on:
    workflow_run:
        workflows:
            - Deploy Infrastructure
        types:
            - completed
    workflow_dispatch:
    push:
        branches:
            - main
        paths:
            - ".github/workflows/policy-guardrails.yml"

permissions:
    contents: read
    security-events: write

env:
    AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    LOCATION: ${{ vars.AZURE_LOCATION }}

jobs:
    scan-iac:
        name: Scan Guardrail Bicep for Security Issues
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Run Checkov Scan
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: infra/
                  framework: bicep
                  output_format: sarif
                  output_file_path: checkov-results.sarif
                  soft_fail: true

            - name: Upload Checkov Results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              continue-on-error: true
              with:
                  sarif_file: checkov-results.sarif

    deploy-guardrails:
        name: Deploy Policy Guardrails
        runs-on: ubuntu-latest
        needs: scan-iac
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Build Custom MCSB Definition
              shell: pwsh
              run: |
                  ./Scripts/Build-CustomMcsb.ps1 -OutputPath ./infra/policies/mcsb-v2-pruned.json

            - name: Azure Login
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Publish Custom MCSB Policy Set
              shell: pwsh
              run: |
                  $definitionPath = Join-Path $PWD 'infra/policies/mcsb-v2-pruned.json'
                  $policySet = Get-Content -Path $definitionPath -Raw | ConvertFrom-Json -Depth 100

                  $tempDir = Join-Path $env:RUNNER_TEMP ([guid]::NewGuid().ToString())
                  New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

                  function Export-JsonSection {
                      param(
                          [Parameter(Mandatory = $true)][object]$Data,
                          [Parameter(Mandatory = $true)][string]$FileName
                      )

                      $targetPath = Join-Path $tempDir $FileName
                      $Data | ConvertTo-Json -Depth 100 | Set-Content -Path $targetPath -Encoding utf8
                      return $targetPath
                  }

                  $definitionsFile = Export-JsonSection -Data $policySet.properties.policyDefinitions -FileName 'definitions.json'

                  if ($policySet.properties.PSObject.Properties.Name -contains 'version') {
                      # Remove unsupported version field because policy set definitions currently allow only a single version.
                      $policySet.properties.PSObject.Properties.Remove('version') | Out-Null
                  }

                  $cliArgs = @(
                      '--name', 'Custom-MCSB-Core',
                      '--subscription', $env:AZURE_SUBSCRIPTION_ID,
                      '--display-name', $policySet.properties.displayName,
                      '--description', $policySet.properties.description,
                      '--definitions', "@$definitionsFile"
                  )
                  if ($policySet.properties.parameters) {
                      $parametersFile = Export-JsonSection -Data $policySet.properties.parameters -FileName 'parameters.json'
                      $cliArgs += @('--params', "@$parametersFile")
                  }

                  if ($policySet.properties.metadata) {
                      $metadataFile = Export-JsonSection -Data $policySet.properties.metadata -FileName 'metadata.json'
                      $cliArgs += @('--metadata', "@$metadataFile")
                  }

                  if ($policySet.properties.policyDefinitionGroups) {
                      $groupsFile = Export-JsonSection -Data $policySet.properties.policyDefinitionGroups -FileName 'definition-groups.json'
                      $cliArgs += @('--definition-groups', "@$groupsFile")
                  }

                  $createResult = az policy set-definition create @cliArgs
                  if ($LASTEXITCODE -ne 0) {
                      Write-Host 'Create failed; attempting to update existing definition.'
                      $updateResult = az policy set-definition update @cliArgs
                      if ($LASTEXITCODE -ne 0) {
                          throw 'Failed to publish custom MCSB policy set.'
                      }
                  }

            - name: Deploy Guardrail Bicep
              uses: azure/arm-deploy@v1
              with:
                  subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
                  scope: subscription
                  region: ${{ env.LOCATION }}
                  template: ./infra/policy-guardrails.bicep
                  parameters: >
                      @infra/parameters/policy-dev.parameters.json
                  deploymentName: policy-guardrails-${{ github.run_number }}
                  failOnStdErr: false
