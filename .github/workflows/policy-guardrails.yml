name: Deploy Policy Guardrails

on:
    workflow_run:
        workflows:
            - Deploy Infrastructure
        types:
            - completed
    workflow_dispatch:

permissions:
    contents: read
    security-events: write

env:
    AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    LOCATION: ${{ vars.AZURE_LOCATION }}

jobs:
    scan-iac:
        name: Scan Guardrail Bicep for Security Issues
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Run Checkov Scan
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: infra/
                  framework: bicep
                  output_format: sarif
                  output_file_path: checkov-results.sarif
                  soft_fail: true

            - name: Upload Checkov Results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              continue-on-error: true
              with:
                  sarif_file: checkov-results.sarif

    deploy-guardrails:
        name: Deploy Policy Guardrails
        runs-on: ubuntu-latest
        needs: scan-iac
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Deploy Guardrail Bicep
              uses: azure/arm-deploy@v1
              with:
                  subscriptionId: ${{ env.AZURE_SUBSCRIPTION_ID }}
                  scope: subscription
                  region: ${{ env.LOCATION }}
                  template: ./infra/policy-guardrails.bicep
                  parameters: >
                      @infra/parameters/policy-dev.parameters.json
                  deploymentName: policy-guardrails-${{ github.run_number }}
                  failOnStdErr: false
