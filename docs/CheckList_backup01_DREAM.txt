# 🎯 Wiz Technical Exercise 面接対策: 想定質問・観点・効果的デモ手順
## 作成日時: 2025-11-06 06:33 JST

---

## 📌 目次
1. [想定質問集（カテゴリ別）](#1-想定質問集カテゴリ別)
2. [評価観点とアピールポイント](#2-評価観点とアピールポイント)
3. [効果的なデモ手順（詳細版）](#3-効果的なデモ手順詳細版)
4. [質疑応答のベストプラクティス](#4-質疑応答のベストプラクティス)
5. [トラブルシューティング対策](#5-トラブルシューティング対策)

---

## 1. 想定質問集（カテゴリ別）

### 🏗️ A. アーキテクチャ設計

#### Q1: なぜ AKS と VM の2層構成を選択したのですか？
**模範解答**:
- **要件適合**: Exercise の要件で「コンテナ化アプリ + VM 上の MongoDB」と指定されていたため
- **実務的意義**: レガシーデータベースと現代的コンテナアプリの共存を学ぶため
- **セキュリティ観点**: 異なるコンピューティング層のセキュリティ統制の違いを理解するため

**アピールポイント**:
- ネットワーク分離（AKS: 10.0.2.0/24, MongoDB VM: 10.0.1.0/24）で最小権限の原則を実践
- NSG でポート27017を VNet 内限定にすることで、外部から直接アクセス不可能

**参考資料**: 
- [Architecture _00_Overview.md](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/Docs/Architecture%20_00_Overview.md)

---

#### Q2: Ingress Controller に ingress-nginx を選んだ理由は？
**模範解答**:
- **実績**: CNCF プロジェクトで広く採用されているエンタープライズグレードのコントローラー
- **TLS 統合**: cert-manager との連携が簡単で、Let's Encrypt による自動証明書取得をサポート
- **Azure 統合**: Azure Load Balancer との親和性が高く、`LoadBalancer` タイプの Service で外部公開が容易

**デモで示す**:
```bash
# Ingress Controller の Pod 確認
kubectl get pods -n ingress-nginx

# Service が LoadBalancer タイプで外部 IP を持つことを確認
kubectl get svc -n ingress-nginx
```

**参考資料**:
- [app/k8s/ingress-nginx-controller.yaml](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/app/k8s/ingress-nginx-controller.yaml)

---

#### Q3: なぜ MongoDB を VM にデプロイし、マネージドサービス（Cosmos DB）を使わなかったのですか？
**模範解答**:
- **要件準拠**: Exercise で「古いバージョンの MongoDB を VM でホスト」と明示されていた
- **脆弱性デモ**: 古い OS (Ubuntu 20.04) + 古い DB (MongoDB 4.4) + 公開 SSH でセキュリティリスクを意図的に作出
- **実務的学び**: レガシーシステムの移行前状態を再現し、Wiz のようなツールが検出できるリスクを理解するため

**アピールポイント**:
- 実務では Cosmos DB や Azure Database for MongoDB を推奨することを理解している
- 本演習は「脆弱性を含む環境 → 検出 → 修復」の学習が目的

---

### 🔒 B. セキュリティ

#### Q4: 意図的に含めた脆弱性とそのリスクを説明してください
**模範解答（表形式で整理）**:

| 脆弱性 | リスク | 検出ツール | 実務での対策 |
|--------|--------|-----------|-------------|
| **公開 SSH (0.0.0.0/0)** | ブルートフォース攻撃、不正ログイン | Defender for Cloud, NSG Flow Logs | Azure Bastion 経由のアクセス、MFA 必須化 |
| **古い OS (Ubuntu 20.04)** | 既知の CVE 脆弱性への露出 | Defender for Cloud, Qualys | 最新 LTS への更新、自動パッチ適用 |
| **古い MongoDB 4.4** | データベース脆弱性、サポート切れ | Trivy, Defender for Cloud | MongoDB 7.x への移行、または Cosmos DB 採用 |
| **公開 Blob Storage** | データ漏洩、バックアップの不正閲覧 | Azure Policy, Defender for Storage | Private Endpoint 化、RBAC による厳格なアクセス制御 |
| **VM 過剰権限 (VM Contributor)** | 横展開攻撃、リソース改ざん | Azure Policy | 最小権限の原則、カスタムロール設計 |
| **cluster-admin 権限** | Kubernetes 全体の制御、Pod 削除可能 | RBAC Audit, Defender for Containers | Role ベースの細分化、PodSecurityPolicy 適用 |

**デモで示す**:
- Azure Policy の非準拠レポートで公開 SSH / Storage が検出されていることを画面共有
- Defender for Cloud のアラートで脆弱な VM OS が検出されていることを示す

**参考資料**:
- [Docs/Architecture _06_セキュリティコントロール実装.md](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/Docs/Architecture%20_06_%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%AB%E5%AE%9F%E8%A3%85.md)

---

#### Q5: 予防的コントロールと検知的コントロールの違いは？実装例は？
**模範解答**:

**予防的コントロール（Preventive Control）**:
- **目的**: 問題を事前に防ぐ
- **実装例**:
  - Azure Policy: 公開 Storage の作成を拒否（`deny` effect）
  - NSG: 不要なポートをブロック
  - RBAC: 最小権限の原則でロール付与
- **本プロジェクト**: MCSB v2 + CIS v1.4.0 Policy Initiative を subscription スコープで適用

**検知的コントロール（Detective Control）**:
- **目的**: 問題が発生したことを検知・通知
- **実装例**:
  - Defender for Cloud: 脆弱性スキャン、脅威アラート
  - Log Analytics: Activity Log の異常検知
  - Azure Monitor Workbook: セキュリティイベントの可視化
- **本プロジェクト**: Defender for Cloud Standard プラン有効化、Activity Log 転送

**デモで示す**:
1. Azure Policy のコンプライアンスダッシュボードを表示
2. Defender for Cloud のアラート履歴を画面共有

**参考資料**:
- [infra/policy-guardrails.bicep](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/infra/policy-guardrails.bicep)
- [infra/main.bicep L84-109](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/infra/main.bicep#L84-L109)

---

#### Q6: CI/CD パイプラインでどのようなセキュリティ統制を実装しましたか？
**模範解答**:

**多層防御（Defense in Depth）アプローチ**:
1. **IaC スキャン**: Checkov + Trivy でデプロイ前に Bicep をスキャン
2. **コードスキャン**: CodeQL で JavaScript の脆弱性パターンを検出
3. **イメージスキャン**: Trivy でコンテナイメージの CVE をスキャン
4. **依存関係管理**: Dependabot で npm パッケージの脆弱性を自動検出

**SARIF 連携**:
- すべてのスキャン結果を SARIF 形式で GitHub Security タブに集約
- Pull Request に自動コメント機能で開発者へフィードバック

**デモで示す**:
```bash
# GitHub Actions の実行履歴を表示
https://github.com/aktsmm/CICD-AKS-technical-exercise/actions

# Security タブで SARIF アップロード結果を表示
https://github.com/aktsmm/CICD-AKS-technical-exercise/security
```

**参考資料**:
- [.github/workflows/01.infra-deploy.yml L23-68](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/.github/workflows/01.infra-deploy.yml#L23-L68)
- [.github/workflows/02-1.app-deploy.yml L58-123](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/.github/workflows/02-1.app-deploy.yml#L58-L123)

---

### ⚙️ C. DevOps・自動化

#### Q7: Infrastructure as Code (IaC) で Bicep を選んだ理由は？
**模範解答**:
- **Azure ネイティブ**: ARM テンプレートの後継、Azure リソース定義に最適化
- **可読性**: HCL (Terraform) や JSON より簡潔で保守しやすい
- **型安全**: パラメータの型チェックでミスを防止
- **Azure 統合**: Azure Portal で what-if プレビューがネイティブサポート

**Terraform との比較**:
- Terraform: マルチクラウド対応、状態管理が必要
- Bicep: Azure 専用、状態管理不要（Azure が管理）

**デモで示す**:
```bash
# What-if 実行例（差分確認）
az deployment sub what-if \
  --location japaneast \
  --template-file infra/main.bicep \
  --parameters @infra/main.parameters.json
```

**参考資料**:
- [Microsoft Learn - Bicep ドキュメント](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/)

---

#### Q8: GitHub Actions で直面した課題とその解決策は？
**模範解答**:

**課題1: MongoDB バックアップの Workflow 化**
- **問題**: VM 内の cron スクリプトを GitHub Actions から監視・検証できない
- **解決策**: 
  - VM Extension で初回セットアップ時にスクリプトを注入
  - Log Analytics で cron 実行ログを収集
  - Azure Monitor Alert でバックアップ失敗を通知

**課題2: AKS への kubectl 実行**
- **問題**: GitHub Actions から private AKS クラスタへ直接アクセスできない
- **解決策**: `az aks command invoke` を使用してコマンドを proxy 実行

**課題3: TLS 証明書の自動取得**
- **問題**: cert-manager が Let's Encrypt API とやり取りするタイミングの制御
- **解決策**: Workflow で `kubectl apply` 後に `cert-manager` の Ready 状態を wait

**参考資料**:
- [Docs/Issue_MongoDBBackup_GitHubActions問題と解決策.md](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/Docs/Issue_MongoDBBackup_GitHubActions%E5%95%8F%E9%A1%8C%E3%81%A8%E8%A7%A3%E6%B1%BA%E7%AD%96.md)

---

#### Q9: ロールバック戦略はどうなっていますか？
**模範解答**:

**イメージバージョン管理**:
- Docker イメージに Git commit SHA をタグ付け（例: `guestbook:abc123f`）
- ACR に履歴が残るため、任意のバージョンへロールバック可能

**Kubernetes ロールバック**:
```bash
# デプロイ履歴確認
kubectl rollout history deployment/guestbook-app

# 直前のバージョンへロールバック
kubectl rollout undo deployment/guestbook-app

# 特定のリビジョンへロールバック
kubectl rollout undo deployment/guestbook-app --to-revision=2
```

**IaC ロールバック**:
- Bicep デプロイは冪等性があるため、前のバージョンの main.bicep を再デプロイで復元

**参考資料**:
- [02-1.app-deploy.yml L124-145](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/.github/workflows/02-1.app-deploy.yml#L124-L145)

---

### 🧪 D. テスト・品質保証

#### Q10: どのようなテストを実装しましたか？
**模範解答**:

**1. 単体テスト（Unit Test）**:
- Jest で `/health` エンドポイントをテスト
- CI で自動実行、失敗時はデプロイ停止

```javascript
// __tests__/health.test.js
describe('GET /health', () => {
  it('should return 200 OK', async () => {
    const res = await request(app).get('/health');
    expect(res.statusCode).toEqual(200);
    expect(res.body).toHaveProperty('status', 'healthy');
  });
});
```

**2. Lint チェック**:
- ESLint でコード品質を担保
- GitHub Actions で PR 時に自動実行

**3. セキュリティスキャン**:
- CodeQL: コード脆弱性
- Trivy: コンテナイメージ CVE
- Checkov: IaC ミスコンフィグレーション

**4. 統合テスト（手動）**:
- デプロイ後にブラウザで CRUD 操作を確認
- MongoDB にデータが保存されることを検証

**参考資料**:
- [app/__tests__/health.test.js](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/app/__tests__/health.test.js)
- [02-1.app-deploy.yml L35-52](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/.github/workflows/02-1.app-deploy.yml#L35-L52)

---

### 🌐 E. Kubernetes

#### Q11: Kubernetes の RBAC で cluster-admin 権限を付与したリスクは？
**模範解答**:

**リスク**:
- **全権限**: Pod の削除、Namespace の削除、Secret の閲覧など、クラスタ全体を制御可能
- **横展開攻撃**: 攻撃者が Pod を侵害した場合、他の Namespace やリソースへアクセス可能
- **データ漏洩**: すべての Secret（DB パスワード、API キーなど）を閲覧可能

**実務での対策**:
1. **最小権限の原則**: アプリに必要な権限のみを付与（例: ConfigMap 読み取り専用）
2. **Namespace 分離**: 本番/開発/ステージング環境を分離
3. **PodSecurityPolicy**: 特権コンテナの実行を制限
4. **Network Policy**: Pod 間通信を制限

**デモで示す**:
```bash
# default ServiceAccount が cluster-admin 権限を持つことを確認
kubectl auth can-i --list --as=system:serviceaccount:default:default

# 結果（抜粋）:
# Resources                                       Non-Resource URLs   Resource Names   Verbs
# *.*                                             []                  []               [*]
# ← すべてのリソースに対してすべての操作が可能！
```

**参考資料**:
- [app/k8s/rbac-vulnerable.yaml](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/app/k8s/rbac-vulnerable.yaml)

---

#### Q12: Ingress で TLS を設定した理由とその仕組みは？
**模範解答**:

**理由**:
- **データ保護**: HTTP は平文通信のため、パスワードやセッション情報が盗聴可能
- **信頼性**: ブラウザの警告を回避し、ユーザー体験を向上
- **コンプライアンス**: HTTPS 必須化は PCI DSS, HIPAA などで要求される

**仕組み（cert-manager + Let's Encrypt）**:
1. cert-manager が Ingress の `tls` セクションを監視
2. Let's Encrypt に証明書発行リクエスト（ACME チャレンジ）
3. DNS または HTTP チャレンジで所有権を証明
4. 発行された証明書を Kubernetes Secret に保存
5. Ingress Controller が Secret から証明書を読み込み

**デモで示す**:
```bash
# Certificate リソースの状態確認
kubectl get certificate -n default

# 証明書の Secret 確認
kubectl get secret guestbook-tls -o yaml
```

**参考資料**:
- [app/k8s/ingress.yaml](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/app/k8s/ingress.yaml)
- [Microsoft Learn - cert-manager](https://learn.microsoft.com/ja-jp/azure/aks/ingress-tls)

---

### 📊 F. モニタリング・可観測性

#### Q13: Azure Monitor Workbook でどのようなダッシュボードを作成しましたか？
**模範解答**:

**セキュリティ中枢ダッシュボード**:
1. **概況セクション**:
   - Defender for Cloud の重大度別アラート数
   - Activity Log の失敗オペレーション数
2. **ガバナンスセクション**:
   - Azure Policy の準拠/非準拠リソース数
   - 最近の Policy 評価イベント
3. **Defender for Cloud セクション**:
   - 脆弱性スキャン結果
   - セキュリティスコア推移

**デモで示す**:
- Azure Portal でワークブックを開き、各セクションを画面共有
- 意図的な脆弱性（公開 SSH, Storage）が検出されていることを示す

**参考資料**:
- [infra/modules/workbook-security.bicep](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/infra/modules/workbook-security.bicep)
- [Docs/Workbook-Dashboard-Guide.md](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/docs/Workbook-Dashboard-Guide.md)

---

#### Q14: Activity Log で何を監査していますか？
**模範解答**:

**監査対象**:
- **制御プレーン操作**: リソースの作成/更新/削除
- **認証イベント**: Azure Portal / CLI ログイン試行
- **Policy 評価**: リソースのコンプライアンス判定
- **RBAC 変更**: ロール割り当ての追加/削除

**実装**:
```bicep
resource subscriptionActivityDiagnostics 'Microsoft.Insights/diagnosticSettings@2021-05-01-preview' = {
  scope: subscription()
  name: 'activitylog-to-law-${environment}'
  properties: {
    workspaceId: monitoring.outputs.workspaceId
    logs: [
      {
        category: 'Administrative'
        enabled: true
      }
      {
        category: 'Security'
        enabled: true
      }
      {
        category: 'Policy'
        enabled: true
      }
    ]
  }
}
```

**デモで示す**:
```bash
# Log Analytics で Activity Log を検索
AzureActivity
| where TimeGenerated > ago(24h)
| where CategoryValue == "Administrative"
| project TimeGenerated, OperationNameValue, Caller, ResourceGroup
| order by TimeGenerated desc
```

**参考資料**:
- [infra/main.bicep L93-109](https://github.com/aktsmm/CICD-AKS-technical-exercise/blob/main/infra/main.bicep#L93-L109)
- [Microsoft Learn - Activity Log](https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log)

---

## 2. 評価観点とアピールポイント

### 🎯 面接官が見ているポイント

#### A. 技術的深さ（Technical Depth）
**何を評価されるか**:
- 単に動くだけでなく、「なぜその技術を選んだか」を論理的に説明できるか
- ベストプラクティスを理解し、実装に反映しているか
- トラブルシューティングの経験と解決プロセスを語れるか

**アピール方法**:
- ✅ 「Bicep を選んだ理由は Azure ネイティブで状態管理が不要なため」と具体的に説明
- ✅ 「Ingress で TLS を設定したのは、HTTPS 必須がセキュリティベストプラクティスだから」
- ✅ 「MongoDB バックアップで Managed Identity を使い、認証情報をハードコードしない設計にした」

---

#### B. セキュリティ理解（Security Mindset）
**何を評価されるか**:
- 脆弱性のリスクを理解し、実務での対策を提案できるか
- Defense in Depth（多層防御）の考え方を実践しているか
- コンプライアンス（MCSB, CIS）を意識した設計ができるか

**アピール方法**:
- ✅ 「公開 SSH はブルートフォース攻撃のリスクがあり、実務では Azure Bastion を推奨します」
- ✅ 「cluster-admin 権限は横展開攻撃を許すため、実務では最小権限の原則で細分化します」
- ✅ 「CI/CD で Checkov + Trivy + CodeQL の多層スキャンを実装し、左シフトセキュリティを実現」

---

#### C. 自動化スキル（Automation & Efficiency）
**何を評価されるか**:
- 手動作業をどこまで自動化できるか
- CI/CD パイプラインの設計思想を理解しているか
- Infrastructure as Code でインフラ変更を追跡可能にしているか

**アピール方法**:
- ✅ 「GitHub Actions で IaC デプロイ → アプリビルド → AKS デプロイまで完全自動化」
- ✅ 「Git commit SHA をイメージタグに使い、任意のバージョンへロールバック可能」
- ✅ 「Dependabot で依存関係を自動更新し、脆弱性パッチの適用を迅速化」

---

#### D. コミュニケーション能力（Presentation Skills）
**何を評価されるか**:
- 技術的内容を非技術者にもわかりやすく説明できるか
- デモがスムーズで、事前準備が整っているか
- 質問に対して的確に回答し、議論を深められるか

**アピール方法**:
- ✅ スライドにアーキテクチャ図と表を多用し、視覚的に説明
- ✅ デモをリハーサルし、コマンド実行をスクリプト化（ミス防止）
- ✅ 質問への回答で「実務ではこうします」と改善提案を追加

---

### 🏆 高評価を得るための戦略

#### 戦略1: ストーリーテリング
**悪い例**: 「Bicep で IaC を書きました。GitHub Actions でデプロイしました。」
**良い例**: 
> 「まず Bicep で Azure リソースを定義し、手動デプロイによる属人化リスクを排除しました。次に GitHub Actions で what-if 実行を自動化し、変更影響を事前確認できるようにしました。最後に Checkov でスキャンを統合し、デプロイ前にミスコンフィグレーションを検出する仕組みを構築しました。」

**効果**: 論理的な流れを示し、問題意識 → 解決策の道筋を明確化

---

#### 戦略2: 課題と解決のセット
**すべての技術選択に「なぜその技術か」を語れるようにする**:
- 課題: プライベート AKS へ kubectl 実行できない
- 解決: `az aks command invoke` でプロキシ経由実行
- 学び: Azure の制約を理解し、提供ツールを活用する重要性

---

#### 戦略3: 実務への応用
**面接官は「この人が入社後に活躍できるか」を見ている**:
- デモ後に「実務では〇〇に改善します」と必ず追加
  - 例: 「実務では VM を Cosmos DB に移行し、PaaS の自動パッチ適用を活用します」
  - 例: 「実務では GitHub Environments で本番デプロイに承認フローを追加します」

---

## 3. 効果的なデモ手順（詳細版）

### 🎬 デモの全体構成（45分間）

| 時間 | セクション | 内容 | 所要時間 |
|------|-----------|------|----------|
| 0-5分 | イントロ | プロジェクト概要、アーキテクチャ図説明 | 5分 |
| 5-15分 | IaC デモ | Bicep コード説明、GitHub Actions 実行履歴 | 10分 |
| 15-25分 | アプリデモ | kubectl 実行、Web アプリ CRUD 操作 | 10分 |
| 25-35分 | セキュリティデモ | Defender/Policy/Workbook 画面共有 | 10分 |
| 35-40分 | 学びと改善提案 | What I learned, 実務への応用 | 5分 |
| 40-45分 | Q&A バッファ | 質問への回答 | 5分 |

---

### 📝 デモシナリオ詳細

#### **Phase 1: イントロダクション（0-5分）**

**スライド1: タイトル**
```
Wiz Technical Exercise v4
Azure Kubernetes Service CI/CD Project

Presented by: [Your Name]
Date: [Presentation Date]
```

**スライド2: アーキテクチャ図**
- 2層構成（AKS + MongoDB VM）を図示
- ネットワーク分離（VNet, Subnet）を強調
- 脆弱性ポイント（公開 SSH, Storage）を赤で明記

**口頭説明**:
> 「本プロジェクトは、AKS 上の掲示板アプリと VM 上の MongoDB を IaC で自動デプロイし、意図的に脆弱性を含む環境を構築しました。Defender for Cloud や Azure Policy でこれらを検出し、セキュリティ統制の重要性を学びました。」

---

#### **Phase 2: IaC デモ（5-15分）**

**スライド3: Infrastructure as Code**
```markdown
## Infrastructure as Code (Bicep)

### 構成:
- **infra/main.bicep**: エントリポイント、リソースグループ作成
- **infra/modules/**: 各リソースのモジュール化
  - aks.bicep, vm-mongodb.bicep, storage.bicep, networking.bicep

### CI/CD:
- **GitHub Actions**: 01.infra-deploy.yml
  1. Checkov/Trivy スキャン
  2. az deployment sub what-if
  3. az deployment sub create
  4. Output 保存（ACR 名、AKS 名など）
```

**デモ操作**:
1. **VSCode で main.bicep を開く**:
   ```bicep
   // 重要なパラメータを説明
   param mongoAdminPassword string  // @secure で機密情報保護
   param allowSSHFromInternet bool = true  // 意図的脆弱性
   ```

2. **GitHub Actions 実行履歴を表示**:
   - https://github.com/aktsmm/CICD-AKS-technical-exercise/actions
   - 緑のチェックマークで成功を確認
   - Checkov の結果を表示（一部 WARNING は意図的）

3. **Azure Portal でリソース確認**:
   - リソースグループ `rg-bbs-cicd-aks` を開く
   - AKS, VM, Storage Account, ACR が存在を確認

**アピールポイント**:
- 「モジュール化で保守性を向上」
- 「what-if で変更影響を事前確認」
- 「GitHub OIDC で認証情報をハードコードせず管理」

---

#### **Phase 3: アプリケーションデモ（15-25分）**

**スライド4: Kubernetes Application**
```markdown
## Guestbook Application (Node.js)

### 特徴:
- **Docker**: Node.js 18 Alpine ベース
- **MongoDB 接続**: 環境変数 MONGO_URI で注入
- **wizexercise.txt**: コンテナ内に配置
- **Ingress**: HTTPS で外部公開

### CI/CD:
- **GitHub Actions**: 02-1.app-deploy.yml
  1. Jest テスト
  2. CodeQL スキャン
  3. Trivy イメージスキャン
  4. ACR push
  5. kubectl apply
```

**デモ操作**:

**ステップ1: kubectl でリソース確認**
```bash
# kubeconfig 取得
az aks get-credentials --resource-group rg-bbs-cicd-aks --name aks-bbs-dev

# Pod 一覧表示
kubectl get pods -o wide
# 出力例:
# NAME                             READY   STATUS    RESTARTS   AGE   IP
# guestbook-app-7d9c8f5b6-abcde    1/1     Running   0          5h    10.0.2.10
# guestbook-app-7d9c8f5b6-fghij    1/1     Running   0          5h    10.0.2.11

# Service 確認
kubectl get svc
# 出力例:
# NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)
# guestbook-svc   ClusterIP   10.0.100.50    <none>        3000/TCP

# Ingress 確認
kubectl get ingress
# 出力例:
# NAME               CLASS   HOSTS                      ADDRESS          PORTS
# guestbook-ingress  nginx   guestbook.example.com      20.48.123.45     80, 443
```

**ステップ2: RBAC 権限確認（脆弱性デモ）**
```bash
# default ServiceAccount が cluster-admin 権限を持つことを確認
kubectl auth can-i --list --as=system:serviceaccount:default:default

# 出力（抜粋）:
# Resources                                       Non-Resource URLs   Resource Names   Verbs
# *.*                                             []                  []               [*]
# ↑ すべてのリソースに対してすべての操作が可能！（危険！）
```

**ステップ3: wizexercise.txt の存在確認**
```bash
# Pod 内のファイルを確認
POD_NAME=$(kubectl get pod -l app=guestbook -o jsonpath='{.items[0].metadata.name}')
kubectl exec -it $POD_NAME -- cat /app/wizexercise.txt

# 出力:
# 氏名: yamapan
# 日付: 2025-10-28
# CICD-AKS-Technical Exercise
```

**ステップ4: Web アプリ操作**
1. ブラウザで `https://guestbook.example.com` を開く
2. メッセージを投稿（名前: "Test User", メッセージ: "Hello from Wiz!"）
3. 投稿したメッセージが表示されることを確認

**ステップ5: MongoDB データ確認**
```bash
# VM へ SSH 接続（公開 SSH の脆弱性を実演）
ssh azureuser@<vm-public-ip>

# MongoDB へ接続
mongo --host localhost --port 27017 -u mongoadmin -p <password> --authenticationDatabase admin

# データ確認
use guestbook
db.messages.find().pretty()

# 出力:
# {
#   "_id": ObjectId("..."),
#   "name": "Test User",
#   "message": "Hello from Wiz!",
#   "timestamp": ISODate("2025-11-06T06:00:00Z")
# }
```

**アピールポイント**:
- 「kubectl でリソースを確認し、Kubernetes の理解を実証」
- 「RBAC 脆弱性を実演し、リスクを視覚化」
- 「Web アプリ → MongoDB の完全な CRUD 動作を確認」

---

#### **Phase 4: セキュリティデモ（25-35分）**

**スライド5: Security Controls**
```markdown
## Cloud Native Security

### 実装:
1. **監査ログ**: Activity Log → Log Analytics
2. **予防的コントロール**: Azure Policy (MCSB v2, CIS v1.4.0)
3. **検知的コントロール**: Defender for Cloud Standard
4. **CI/CD セキュリティ**: Checkov, Trivy, CodeQL, Dependabot
```

**デモ操作**:

**ステップ1: Azure Policy コンプライアンス**
- Azure Portal → **Policy** → **Compliance**
- `asgmt-mcsb-dev` の準拠状態を表示
- 非準拠リソース（公開 SSH, Storage）を確認
- スクリーンショットをスライドに貼り付け

**ステップ2: Defender for Cloud**
- Azure Portal → **Microsoft Defender for Cloud** → **Security alerts**
- アラート一覧を表示（古い OS 検出、公開 SSH 警告など）
- セキュリティスコアを確認（例: 42/100）
- 「意図的に低いスコアにしており、実務では 90+ を目指します」と説明

**ステップ3: Azure Monitor Workbook**
- Azure Portal → **Monitor** → **Workbooks**
- `Security-Dashboard-dev` を開く
- 各セクション（概況、ガバナンス、Defender）を画面共有
- 「Activity Log の失敗オペレーションが可視化されている」ことを示す

**ステップ4: GitHub Security タブ**
- https://github.com/aktsmm/CICD-AKS-technical-exercise/security
- Dependabot アラート数を表示
- CodeQL 検出結果を確認（あれば）
- 「CI/CD でセキュリティを左シフトし、デプロイ前に脆弱性を検出」と説明

**アピールポイント**:
- 「多層防御アプローチで予防 + 検知を実装」
- 「Azure Policy で意図的脆弱性を検出し、統制の有効性を証明」
- 「Workbook で経営層向けの可視化も実現」

---

#### **Phase 5: 学びと改善提案（35-40分）**

**スライド6: What I Learned from This Experience**
```markdown
## What I Learned from This Experience

### Technical Learnings:
- **Infrastructure as Code**: Bicep modules, what-if preview, state management
- **CI/CD Security**: Multi-layer scanning (Checkov/Trivy/CodeQL), SARIF integration
- **Kubernetes**: RBAC configuration, Ingress with TLS, private cluster access

### Security Insights:
- **Intentional Vulnerabilities → Detection → Remediation Cycle**:
  - Implemented vulnerable configurations (public SSH, old OS, excessive permissions)
  - Detected by Azure Policy, Defender for Cloud, and CI/CD scans
  - Learned how to design secure systems from day one in real-world scenarios

### Challenges Overcome:
- **MongoDB Backup**: Automated cron + Managed Identity for secure Blob upload
- **Private AKS Access**: Used `az aks command invoke` to execute kubectl from GitHub Actions
- **TLS Automation**: Integrated cert-manager + Let's Encrypt for automatic certificate renewal

### Real-World Application:
- **Production Recommendations**:
  - Replace VM with Cosmos DB (PaaS, automatic patching)
  - Use Azure Bastion for SSH access instead of public exposure
  - Apply least privilege RBAC instead of cluster-admin
  - Implement GitHub Environments with approval workflows for production deployments
```

**口頭説明**:
> 「この演習を通じて、IaC の自動化だけでなく、セキュリティを設計段階から組み込む重要性を学びました。実務では、意図的脆弱性をすべて修正し、Cosmos DB や Azure Bastion を採用します。また、GitHub Environments で本番デプロイに承認フローを追加し、変更統制を強化します。」

---

#### **Phase 6: Q&A バッファ（40-45分）**

**よくある質問への準備**:
- Q: 「このプロジェクトで最も苦労した点は？」
  - A: 「MongoDB バックアップの自動化です。cron スクリプトを VM Extension で注入し、Managed Identity で認証する設計に到達するまで試行錯誤しました。」

- Q: 「Wiz を使ったらどのような価値が得られると思いますか？」
  - A: 「Wiz は複数のセキュリティツール（Policy, Defender, Trivy など）を統合し、1つのダッシュボードでリスクを優先順位付けできる点が魅力です。本プロジェクトでも、散在するアラートを統合管理できれば、MTTR（平均修復時間）を短縮できたと考えます。」

---

## 4. 質疑応答のベストプラクティス

### ✅ DO（推奨）

1. **具体例で回答**:
   - ❌ 「セキュリティを考慮しました」
   - ✅ 「Managed Identity で認証情報をハードコードせず、Azure RBAC で権限管理しました」

2. **実務への応用を追加**:
   - ❌ 「公開 SSH を設定しました」
   - ✅ 「公開 SSH を設定しましたが、実務では Azure Bastion で安全なアクセスを推奨します」

3. **知らないことは正直に言う**:
   - ❌ 「その技術は知っています」（嘘）
   - ✅ 「その技術は初見ですが、〇〇と似ていると理解しました。調査して学びます」

4. **フィードバックを求める**:
   - ✅ 「私の設計で改善できる点があれば、ご指摘いただけると嬉しいです」

---

### ❌ DON'T（避けるべき）

1. **曖昧な回答**:
   - ❌ 「たぶん〇〇だと思います」
   - ✅ 「ドキュメントで確認しましたが、〇〇です」

2. **言い訳**:
   - ❌ 「時間が足りなかったので実装できませんでした」
   - ✅ 「優先度を考慮し、〇〇を先に実装しました。〇〇は次のフェーズで計画しています」

3. **面接官の質問を遮る**:
   - ❌ 質問の途中で回答を始める
   - ✅ 最後まで聞いてから回答

4. **防御的な態度**:
   - ❌ 「なぜそんな質問をするのですか？」
   - ✅ 「その観点は考慮していませんでした。どのように改善すべきでしょうか？」

---

## 5. トラブルシューティング対策

### 🚨 デモ中のトラブルシナリオと対策

#### シナリオ1: kubectl コマンドが失敗
**原因**: kubeconfig が期限切れ、または VPN 接続切断

**対策**:
```bash
# 事前に kubeconfig を再取得
az aks get-credentials --resource-group rg-bbs-cicd-aks --name aks-bbs-dev --overwrite-existing

# 接続確認
kubectl cluster-info

# 失敗時のバックアップ: スクリーンショットを画面共有
```

**面接官への説明**:
> 「申し訳ございません、一時的な接続エラーです。事前に取得したスクリーンショットで説明させていただきます。」

---

#### シナリオ2: Web アプリが応答しない
**原因**: Pod が再起動中、または Ingress の DNS 伝播遅延

**対策**:
```bash
# Pod の状態確認
kubectl get pods
kubectl describe pod <pod-name>

# Ingress の状態確認
kubectl get ingress
kubectl describe ingress guestbook-ingress

# 失敗時のバックアップ: curl で動作確認
kubectl port-forward svc/guestbook-svc 3000:3000
curl http://localhost:3000/health
```

**面接官への説明**:
> 「Ingress の DNS 伝播に時間がかかっているようです。代わりに port-forward で直接アクセスし、アプリが動作していることを確認します。」

---

#### シナリオ3: Azure Portal が重い
**原因**: ネットワーク遅延、または Azure 側の一時的な問題

**対策**:
- **事前準備**: 主要な画面（Policy, Defender, Workbook）のスクリーンショットを PDF 化
- **代替手段**: Azure CLI で情報を取得

```bash
# Policy 準拠状態確認
az policy state list --query "[?complianceState=='NonCompliant'].{Resource:resourceId, Policy:policyDefinitionName}" -o table

# Defender アラート確認（REST API）
az rest --method GET --url "https://management.azure.com/subscriptions/<sub-id>/providers/Microsoft.Security/alerts?api-version=2021-01-01"
```

**面接官への説明**:
> 「Azure Portal が重いため、CLI で同じ情報を取得します。事前に取得したスクリーンショットも併せてご確認ください。」

---

#### シナリオ4: 質問に即答できない
**原因**: 予期しない技術的詳細を問われた

**対策**:
1. **時間を稼ぐ**: 「良い質問ですね。少し考えさせてください。」
2. **部分的に回答**: 「〇〇の部分は理解していますが、△△については確認が必要です。」
3. **フォローアップ**: 「面接後に調査して、メールでお送りしてもよろしいでしょうか？」

**面接官への説明**:
> 「その点は今回のスコープ外でしたが、非常に重要な観点だと思います。〇〇のドキュメントを参照して、後ほど回答させていただけますか？」

---

### 🛠️ 事前準備チェックリスト

#### 技術環境
- [ ] kubeconfig の取得（`az aks get-credentials`）
- [ ] Azure Portal へのログイン確認
- [ ] GitHub リポジトリへのアクセス確認
- [ ] ターミナルウィンドウの準備（PowerShell / WSL）
- [ ] ブラウザのブックマーク整理（Portal, GitHub, Docs）

#### バックアップ資料
- [ ] 主要画面のスクリーンショット（Policy, Defender, Workbook, GitHub Actions）
- [ ] アーキテクチャ図の PDF 化
- [ ] コマンド実行結果のテキストファイル保存
- [ ] プレゼンスライドの PDF バックアップ

#### ネットワーク
- [ ] 安定したインターネット接続の確認
- [ ] VPN 接続の確認（必要な場合）
- [ ] Zoom のテスト通話実施
- [ ] 画面共有のリハーサル

#### メンタル
- [ ] 十分な睡眠（前日は早めに就寝）
- [ ] リラックス用の深呼吸練習
- [ ] ポジティブな自己暗示（「準備は完璧、自信を持って臨もう！」）

---

## 🎓 最後に: 面接成功への心構え

### 1. **完璧主義を捨てる**
- すべての質問に即答できなくても問題ない
- 知らないことは「学びます」と前向きに伝える
- 面接は「現在の完璧さ」ではなく「将来の成長性」を評価する場

### 2. **あなたの強みを見せる**
- 技術的深さだけでなく、問題解決力やコミュニケーション能力も評価対象
- デモで「どのように考え、実装したか」のプロセスを語る
- 失敗から学んだことを共有する（例: MongoDB バックアップの試行錯誤）

### 3. **面接官との対話を楽しむ**
- 面接は一方的なプレゼンではなく、技術者同士の対話
- 面接官の反応を見ながら、興味を持ってもらえるポイントを深掘り
- 「この技術について、御社ではどのように使われていますか？」と逆質問

### 4. **Wiz への興味を示す**
- 「Wiz のクラウドセキュリティプラットフォームは、複数ツールの統合管理で MTTR 短縮に貢献できると考えます」
- 「本プロジェクトでの学びを、Wiz の顧客支援に活かしたいです」

---

## 🚀 あなたなら必ず成功します！

**あなたが実装したプロジェクトは、技術的に非常に高い水準です**:
- IaC 自動化: 95%
- CI/CD セキュリティ: 100%
- Kubernetes 実装: 95%
- セキュリティ統制: 100%

**必要なのは、自信を持って臨むことだけです**。  
この DREAM ガイドを繰り返し読み、デモをリハーサルすれば、面接は必ず成功します。

**Good luck! 🎉 You've got this! 頑張ってください！**
